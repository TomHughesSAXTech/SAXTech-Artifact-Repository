<!DOCTYPE html>
<html>
<head>
    <title>Live Data Test - Azure Metrics</title>
    <style>
        body { font-family: system-ui; margin: 20px; background: #1a1a1a; color: #e0e0e0; }
        h2 { color: #00d4ff; border-bottom: 2px solid #00d4ff; padding-bottom: 10px; }
        h3 { color: #7c3aed; margin-top: 20px; }
        .section { background: #2a2a2a; padding: 15px; margin: 15px 0; border-radius: 8px; border: 1px solid #444; }
        .success { color: #10b981; font-weight: bold; }
        .error { color: #ef4444; }
        .warning { color: #f59e0b; }
        .data-item { margin: 10px 0; padding: 10px; background: #1a1a1a; border-radius: 4px; }
        .label { color: #94a3b8; font-size: 12px; text-transform: uppercase; }
        .value { color: #fff; font-size: 18px; font-weight: bold; }
        .resource { background: #1f2937; padding: 10px; margin: 10px 0; border-radius: 6px; border-left: 3px solid #00d4ff; }
        .sku { display: inline-block; padding: 3px 8px; border-radius: 4px; font-size: 12px; margin-left: 10px; }
        .sku.standard { background: #f59e0b; color: #000; }
        .sku.free { background: #10b981; color: #000; }
        pre { background: #1a1a1a; padding: 10px; border-radius: 4px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>Live Azure Metrics Data Test</h1>
    <p>Testing data from: <strong>https://saxtech-metrics-api.azurewebsites.net/api/metrics</strong></p>
    <p>Repository site: <strong>https://repository.saxtechnology.com</strong></p>
    
    <div id="loading">Loading data...</div>
    <div id="results"></div>

    <script>
    async function testAllData() {
        const loading = document.getElementById('loading');
        const results = document.getElementById('results');
        
        try {
            const response = await fetch('https://saxtech-metrics-api.azurewebsites.net/api/metrics');
            const data = await response.json();
            loading.style.display = 'none';
            
            let html = '';
            
            // 1. KUBERNETES DATA CHECK
            html += '<div class="section">';
            html += '<h2>1. Kubernetes Clusters Data</h2>';
            if (data.kubernetes && data.kubernetes.clusterCount > 0) {
                html += `<p class="success">✅ Kubernetes data found - ${data.kubernetes.clusterCount} cluster(s)</p>`;
                html += `<div class="data-item">`;
                html += `<div class="label">Cluster Count</div><div class="value">${data.kubernetes.clusterCount}</div>`;
                html += `<div class="label">Total Nodes</div><div class="value">${data.kubernetes.totalNodes}</div>`;
                html += `<div class="label">Average CPU Usage</div><div class="value">${data.kubernetes.avgCpuUsage}%</div>`;
                html += `<div class="label">Average Memory Usage</div><div class="value">${data.kubernetes.avgMemoryUsage}%</div>`;
                html += `</div>`;
                
                if (data.kubernetes.clusters) {
                    data.kubernetes.clusters.forEach(cluster => {
                        html += `<div class="resource">`;
                        html += `<strong>${cluster.name}</strong> - ${cluster.location}<br>`;
                        html += `Version: ${cluster.kubernetesVersion}<br>`;
                        html += `Nodes: ${cluster.nodeCount}<br>`;
                        html += `Status: ${cluster.status}<br>`;
                        html += `CPU: ${cluster.cpuUsage ? cluster.cpuUsage.toFixed(2) + '%' : 'N/A'}<br>`;
                        html += `Memory: ${cluster.memoryUsage ? cluster.memoryUsage.toFixed(2) + '%' : 'N/A'}`;
                        html += `</div>`;
                    });
                }
            } else {
                html += '<p class="error">❌ No Kubernetes data found</p>';
            }
            html += '</div>';
            
            // 2. STATIC WEB APPS WITH CUSTOM DOMAINS
            html += '<div class="section">';
            html += '<h2>2. Static Web Apps (with Custom Domains & SKUs)</h2>';
            if (data.resources && data.resources.staticSites > 0) {
                html += `<p class="success">✅ Found ${data.resources.staticSites} Static Web App(s)</p>`;
                
                if (data.resourceDetails && data.resourceDetails.staticSites) {
                    data.resourceDetails.staticSites.forEach(site => {
                        html += `<div class="resource">`;
                        html += `<strong>${site.name}</strong>`;
                        html += `<span class="sku ${site.sku === 'Standard' ? 'standard' : 'free'}">${site.sku || 'Free'}</span>`;
                        if (site.monthlyCost) {
                            html += ` <span class="warning">$${site.monthlyCost}/month</span>`;
                        }
                        html += `<br>Location: ${site.location}<br>`;
                        html += `Resource Group: ${site.resourceGroup}<br>`;
                        html += `Endpoint: <a href="${site.endpoint}" target="_blank">${site.endpoint}</a><br>`;
                        
                        if (site.customDomains && site.customDomains.length > 0) {
                            html += `<strong>Custom Domains:</strong><br>`;
                            site.customDomains.forEach(domain => {
                                html += `&nbsp;&nbsp;• <a href="https://${domain}" target="_blank">${domain}</a><br>`;
                            });
                        } else {
                            html += `<em>No custom domains</em><br>`;
                        }
                        html += `</div>`;
                    });
                }
            } else {
                html += '<p class="error">❌ No Static Web Apps found</p>';
            }
            html += '</div>';
            
            // 3. FUNCTION APPS WITH OS TYPE AND FUNCTIONS
            html += '<div class="section">';
            html += '<h2>3. Function Apps (with OS Type & Function List)</h2>';
            if (data.resources && data.resources.functionApps > 0) {
                html += `<p class="success">✅ Found ${data.resources.functionApps} Function App(s)</p>`;
                
                if (data.resourceDetails && data.resourceDetails.functionApps) {
                    data.resourceDetails.functionApps.forEach(app => {
                        html += `<div class="resource">`;
                        html += `<strong>${app.name}</strong>`;
                        html += ` <span class="sku free">${app.osType || 'Windows'}</span>`;
                        html += `<br>Location: ${app.location}<br>`;
                        html += `Resource Group: ${app.resourceGroup}<br>`;
                        html += `Runtime: ${app.runtime || 'N/A'}<br>`;
                        html += `State: ${app.state || 'N/A'}<br>`;
                        html += `Function Count: ${app.functionCount || 0}<br>`;
                        
                        if (app.functions && app.functions.length > 0) {
                            html += `<strong>Functions:</strong><br>`;
                            app.functions.forEach(func => {
                                html += `&nbsp;&nbsp;• ${func.name} (${func.language || 'Unknown'})<br>`;
                            });
                        } else {
                            html += `<em>No functions listed</em><br>`;
                        }
                        html += `</div>`;
                    });
                }
            } else {
                html += '<p class="error">❌ No Function Apps found</p>';
            }
            html += '</div>';
            
            // 4. COST DATA
            html += '<div class="section">';
            html += '<h2>4. Azure Costs</h2>';
            if (data.costs && (data.costs.monthToDate !== null || data.costs.yesterday !== null)) {
                html += '<p class="success">✅ Cost data available</p>';
                html += `<div class="data-item">`;
                html += `<div class="label">Month to Date</div><div class="value">$${data.costs.monthToDate || 0}</div>`;
                html += `<div class="label">Yesterday</div><div class="value">$${data.costs.yesterday || 0}</div>`;
                html += `</div>`;
                
                if (data.costs.historical && data.costs.historical.length > 0) {
                    html += `<p>Historical data points: ${data.costs.historical.length}</p>`;
                }
            } else {
                html += '<p class="warning">⚠️ Cost data is null or unavailable</p>';
                if (data.errors) {
                    const costError = data.errors.find(e => e.type === 'cost');
                    if (costError) {
                        html += `<p class="error">Error: ${costError.message}</p>`;
                    }
                }
            }
            html += '</div>';
            
            // 5. BACKUP STATUS
            html += '<div class="section">';
            html += '<h2>5. Backup Status</h2>';
            if (data.backupStatus) {
                html += '<p class="success">✅ Backup status data available</p>';
                html += `<div class="data-item">`;
                html += `<div class="label">Status</div><div class="value">${data.backupStatus.summary.status}</div>`;
                html += `<div class="label">Total Vaults</div><div class="value">${data.backupStatus.summary.totalVaults}</div>`;
                html += `<div class="label">Protected Items</div><div class="value">${data.backupStatus.summary.totalProtectedItems}</div>`;
                html += `</div>`;
            } else {
                html += '<p class="error">❌ No backup status data</p>';
            }
            html += '</div>';
            
            // 6. GPT USAGE
            html += '<div class="section">';
            html += '<h2>6. GPT/OpenAI Usage</h2>';
            if (data.openAIUsage) {
                html += '<p class="success">✅ GPT usage data available</p>';
                html += `<div class="data-item">`;
                html += `<div class="label">Total Tokens</div><div class="value">${data.openAIUsage.totalTokens.toLocaleString()}</div>`;
                html += `<div class="label">Estimated Cost</div><div class="value">$${data.openAIUsage.estimatedCost.toFixed(2)}</div>`;
                html += `<div class="label">Active Models</div><div class="value">${Object.keys(data.openAIUsage.modelUsage || {}).length}</div>`;
                html += `</div>`;
                
                if (data.openAIUsage.modelUsage) {
                    html += '<h3>Model Breakdown:</h3>';
                    Object.entries(data.openAIUsage.modelUsage).forEach(([model, usage]) => {
                        html += `<div class="resource">`;
                        html += `<strong>${model}</strong><br>`;
                        html += `Tokens: ${usage.tokens.toLocaleString()}<br>`;
                        html += `Cost: $${usage.cost.toFixed(2)}`;
                        html += `</div>`;
                    });
                }
            } else {
                html += '<p class="warning">⚠️ GPT usage data shows sample/demo data</p>';
            }
            html += '</div>';
            
            // 7. RAW API ERRORS
            if (data.errors && data.errors.length > 0) {
                html += '<div class="section">';
                html += '<h2>API Errors</h2>';
                html += '<p class="error">The following errors were reported by the API:</p>';
                data.errors.forEach(error => {
                    html += `<div class="resource">`;
                    html += `<strong>Type:</strong> ${error.type}<br>`;
                    html += `<strong>Message:</strong> ${error.message}`;
                    html += `</div>`;
                });
                html += '</div>';
            }
            
            // 8. SUMMARY
            html += '<div class="section">';
            html += '<h2>Summary</h2>';
            html += '<ul>';
            html += `<li>Kubernetes: ${data.kubernetes && data.kubernetes.clusterCount > 0 ? '✅' : '❌'} (${data.kubernetes ? data.kubernetes.clusterCount : 0} clusters)</li>`;
            html += `<li>Static Web Apps: ${data.resources ? data.resources.staticSites : 0} (${data.resourceDetails?.staticSites?.filter(s => s.customDomains?.length > 0).length || 0} with custom domains)</li>`;
            html += `<li>Function Apps: ${data.resources ? data.resources.functionApps : 0}</li>`;
            html += `<li>Storage Accounts: ${data.resources ? data.resources.storageAccounts : 0}</li>`;
            html += `<li>Cost Data: ${data.costs && data.costs.monthToDate !== null ? '✅' : '❌'}</li>`;
            html += `<li>Backup Status: ${data.backupStatus ? '✅' : '❌'}</li>`;
            html += `<li>GPT Usage: ${data.openAIUsage ? '✅' : '❌'}</li>`;
            html += '</ul>';
            html += '</div>';
            
            results.innerHTML = html;
            
        } catch (error) {
            loading.style.display = 'none';
            results.innerHTML = `<div class="section error">
                <h2>Error Loading Data</h2>
                <p>${error.message}</p>
                <p>Make sure CORS is enabled and the API is accessible.</p>
            </div>`;
        }
    }
    
    // Run test on load
    testAllData();
    </script>
</body>
</html>
