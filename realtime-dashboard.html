<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>SAXTech Real-Time Azure Dashboard</title>
  
  <!-- MSAL.js for Azure AD Authentication -->
  <script src="https://alcdn.msauth.net/browser/2.32.2/js/msal-browser.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #060818 100%);
      color: #e2e8f0;
      min-height: 100vh;
    }
    
    .header {
      background: rgba(15, 23, 41, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 212, 255, 0.2);
      padding: 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .user-section {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .user-info {
      display: none;
      align-items: center;
      gap: 15px;
    }
    
    .user-info.active {
      display: flex;
    }
    
    .user-email {
      color: #94a3b8;
      font-size: 14px;
    }
    
    .btn {
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: rgba(124, 58, 237, 0.2);
      border: 1px solid rgba(124, 58, 237, 0.5);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    /* Auth Section */
    .auth-section {
      background: rgba(15, 23, 41, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .auth-section.hidden {
      display: none;
    }
    
    .auth-title {
      font-size: 20px;
      margin-bottom: 15px;
      color: #00d4ff;
    }
    
    .auth-description {
      color: #94a3b8;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    /* Status Messages */
    .status-message {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    
    .status-message.active {
      display: block;
    }
    
    .status-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
    }
    
    .status-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .status-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #3b82f6;
    }
    
    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .metric-card {
      background: rgba(15, 23, 41, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
    }
    
    .metric-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #94a3b8;
      margin-bottom: 10px;
    }
    
    .metric-value {
      font-size: 32px;
      font-weight: 800;
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 5px;
    }
    
    .metric-subtitle {
      font-size: 12px;
      color: #64748b;
    }
    
    .metric-loading {
      opacity: 0.5;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.8; }
    }
    
    /* Data Table */
    .data-section {
      background: rgba(15, 23, 41, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #00d4ff;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      text-align: left;
      padding: 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #94a3b8;
      border-bottom: 1px solid rgba(0, 212, 255, 0.2);
    }
    
    .data-table td {
      padding: 10px;
      color: #e2e8f0;
      border-bottom: 1px solid rgba(0, 212, 255, 0.1);
    }
    
    .data-table tr:hover {
      background: rgba(0, 212, 255, 0.05);
    }
    
    /* Loading Spinner */
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0, 212, 255, 0.3);
      border-top-color: #00d4ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Settings Panel */
    .settings-panel {
      background: rgba(15, 23, 41, 0.8);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-label {
      display: block;
      font-size: 12px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }
    
    .input-field {
      width: 100%;
      background: rgba(6, 8, 24, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.2);
      color: #e2e8f0;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #00d4ff;
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }
    
    .code-block {
      background: rgba(6, 8, 24, 0.8);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 8px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #00d4ff;
      overflow-x: auto;
      margin: 10px 0;
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">SAXTech Real-Time Azure Dashboard</div>
      <div class="user-section">
        <button id="signInButton" class="btn" onclick="signIn()">Sign In with Azure AD</button>
        <div id="userInfo" class="user-info">
          <span class="user-email" id="userEmail">Not signed in</span>
          <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
          <button class="btn" onclick="signOut()">Sign Out</button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Authentication Section -->
    <div id="authSection" class="auth-section">
      <h2 class="auth-title">üîê Azure AD Authentication Required</h2>
      <p class="auth-description">
        This dashboard connects directly to Azure Management APIs for real-time data.<br>
        Please sign in with your Azure AD account to continue.
      </p>
      <button class="btn" onclick="signIn()">Sign In with Microsoft Account</button>
    </div>

    <!-- Status Messages -->
    <div id="statusMessage" class="status-message"></div>

    <!-- Main Dashboard (Hidden until authenticated) -->
    <div id="mainDashboard" style="display: none;">
      <!-- Cost Metrics -->
      <div class="dashboard-grid">
        <div class="metric-card">
          <div class="metric-label">Month-to-Date Cost</div>
          <div class="metric-value" id="mtdCost">--</div>
          <div class="metric-subtitle" id="mtdDates">Loading...</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Yesterday's Cost</div>
          <div class="metric-value" id="yesterdayCost">--</div>
          <div class="metric-subtitle" id="yesterdayDate">--</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Today's Cost (Live)</div>
          <div class="metric-value" id="todayCost">--</div>
          <div class="metric-subtitle">Real-time from Azure</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Last 7 Days</div>
          <div class="metric-value" id="weekCost">--</div>
          <div class="metric-subtitle">Weekly spending</div>
        </div>
      </div>

      <!-- Resource Counts -->
      <div class="dashboard-grid">
        <div class="metric-card">
          <div class="metric-label">Resource Groups</div>
          <div class="metric-value" id="rgCount">--</div>
          <div class="metric-subtitle">Active groups</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Virtual Machines</div>
          <div class="metric-value" id="vmCount">--</div>
          <div class="metric-subtitle" id="vmStatus">--</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Storage Accounts</div>
          <div class="metric-value" id="storageCount">--</div>
          <div class="metric-subtitle">Total accounts</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Web Apps</div>
          <div class="metric-value" id="webAppCount">--</div>
          <div class="metric-subtitle">Static + Function</div>
        </div>
      </div>

      <!-- Detailed Cost Breakdown -->
      <div class="data-section">
        <h3 class="section-title">Cost Breakdown by Service (Last 30 Days)</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Service</th>
              <th>Resource Count</th>
              <th>Month-to-Date</th>
              <th>Daily Average</th>
              <th>% of Total</th>
            </tr>
          </thead>
          <tbody id="costBreakdownTable">
            <tr><td colspan="5" style="text-align: center;"><div class="spinner"></div></td></tr>
          </tbody>
        </table>
      </div>

      <!-- Resources List -->
      <div class="data-section">
        <h3 class="section-title">Top 10 Resources by Cost</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Resource Name</th>
              <th>Type</th>
              <th>Resource Group</th>
              <th>Location</th>
              <th>MTD Cost</th>
            </tr>
          </thead>
          <tbody id="resourcesTable">
            <tr><td colspan="5" style="text-align: center;"><div class="spinner"></div></td></tr>
          </tbody>
        </table>
      </div>

      <!-- Settings -->
      <div class="settings-panel">
        <h3 class="section-title">Azure Configuration</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div class="input-group">
            <label class="input-label">Subscription ID</label>
            <input type="text" class="input-field" id="subscriptionId" value="3cfb259a-f02a-484e-9ce3-d83c21fd0ddb">
          </div>
          <div class="input-group">
            <label class="input-label">Tenant ID</label>
            <input type="text" class="input-field" id="tenantId" value="3d659328-eef0-44f7-8481-5833e1051aec" readonly>
          </div>
        </div>
        <div style="margin-top: 15px;">
          <button class="btn btn-secondary" onclick="updateSubscription()">Update Subscription</button>
          <button class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
        </div>
        
        <div class="code-block" style="margin-top: 20px;">
          <strong>API Endpoints Being Used:</strong><br>
          Cost Management: https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.CostManagement/query<br>
          Resources: https://management.azure.com/subscriptions/{subscriptionId}/resources<br>
          Resource Groups: https://management.azure.com/subscriptions/{subscriptionId}/resourcegroups
        </div>
      </div>
    </div>
  </div>

  <script>
    // MSAL Configuration
    const msalConfig = {
      auth: {
        clientId: 'c1a20824-c427-46f0-a819-53d657d6ea7f', // SAXTech Real-Time Dashboard App
        authority: 'https://login.microsoftonline.com/3d659328-eef0-44f7-8481-5833e1051aec',
        redirectUri: window.location.origin + '/realtime-dashboard.html'
      },
      cache: {
        cacheLocation: 'localStorage',
        storeAuthStateInCookie: false
      }
    };

    // MSAL Instance
    const msalInstance = new msal.PublicClientApplication(msalConfig);

    // Azure Management API Scopes
    const loginRequest = {
      scopes: ['https://management.azure.com/user_impersonation']
    };

    const tokenRequest = {
      scopes: ['https://management.azure.com/.default'],
      forceRefresh: false
    };

    let currentAccount = null;

    // Initialize MSAL
    async function initializeMSAL() {
      try {
        // Handle redirect response
        const response = await msalInstance.handleRedirectPromise();
        if (response) {
          currentAccount = response.account;
          showMessage('Successfully signed in!', 'success');
          await onSignIn();
        }

        // Check if user is already signed in
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length > 0) {
          currentAccount = accounts[0];
          await onSignIn();
        }
      } catch (error) {
        console.error('MSAL initialization error:', error);
        showMessage('Authentication error: ' + error.message, 'error');
      }
    }

    // Sign In
    async function signIn() {
      try {
        showMessage('Redirecting to Microsoft login...', 'info');
        await msalInstance.loginRedirect(loginRequest);
      } catch (error) {
        console.error('Login error:', error);
        showMessage('Login failed: ' + error.message, 'error');
      }
    }

    // Sign Out
    function signOut() {
      msalInstance.logoutRedirect({
        account: currentAccount
      });
    }

    // Handle successful sign in
    async function onSignIn() {
      if (!currentAccount) return;

      // Update UI
      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('signInButton').style.display = 'none';
      document.getElementById('userInfo').classList.add('active');
      document.getElementById('userEmail').textContent = currentAccount.username || currentAccount.name;
      document.getElementById('mainDashboard').style.display = 'block';

      // Load data
      await refreshData();
    }

    // Get Access Token
    async function getAccessToken() {
      try {
        const response = await msalInstance.acquireTokenSilent({
          ...tokenRequest,
          account: currentAccount
        });
        return response.accessToken;
      } catch (error) {
        console.error('Token acquisition failed, attempting interactive:', error);
        const response = await msalInstance.acquireTokenRedirect(tokenRequest);
        return response.accessToken;
      }
    }

    // Rate limiting configuration
    const rateLimitConfig = {
      costApiDelay: 2000, // 2 seconds between Cost API calls
      maxRetries: 3,
      retryDelay: 5000 // 5 seconds between retries
    };
    
    let lastCostApiCall = 0;
    
    // Sleep function for delays
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // Azure API Helper with retry logic
    async function callAzureAPI(endpoint, options = {}, retryCount = 0) {
      try {
        // Rate limiting for Cost Management API
        if (endpoint.includes('/providers/Microsoft.CostManagement/')) {
          const now = Date.now();
          const timeSinceLastCall = now - lastCostApiCall;
          if (timeSinceLastCall < rateLimitConfig.costApiDelay) {
            await sleep(rateLimitConfig.costApiDelay - timeSinceLastCall);
          }
          lastCostApiCall = Date.now();
        }
        
        const token = await getAccessToken();
        const response = await fetch(`https://management.azure.com${endpoint}`, {
          ...options,
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            ...options.headers
          }
        });

        if (!response.ok) {
          // Handle rate limiting (429)
          if (response.status === 429 && retryCount < rateLimitConfig.maxRetries) {
            console.log(`Rate limited. Retrying in ${rateLimitConfig.retryDelay}ms... (Attempt ${retryCount + 1}/${rateLimitConfig.maxRetries})`);
            await sleep(rateLimitConfig.retryDelay);
            return callAzureAPI(endpoint, options, retryCount + 1);
          }
          
          // Try to get error details from response
          let errorMessage = `${response.status} ${response.statusText}`;
          try {
            const errorData = await response.json();
            if (errorData.error) {
              errorMessage = errorData.error.message || errorData.error.code || errorMessage;
            }
            console.error('API Error Details:', errorData);
          } catch (e) {
            // Response wasn't JSON
          }
          throw new Error(`API Error: ${errorMessage}`);
        }

        return await response.json();
      } catch (error) {
        console.error('Azure API call failed:', error);
        throw error;
      }
    }

    // Get Cost Data
    async function getCostData(timeframe = 'MonthToDate') {
      const subscriptionId = document.getElementById('subscriptionId').value;
      const endpoint = `/subscriptions/${subscriptionId}/providers/Microsoft.CostManagement/query?api-version=2023-03-01`;
      
      const body = {
        type: 'ActualCost',
        dataSet: {
          granularity: 'Daily',
          aggregation: {
            totalCost: {
              name: 'Cost',
              function: 'Sum'
            },
            totalCostUSD: {
              name: 'CostUSD',
              function: 'Sum'
            }
          },
          grouping: [
            {
              type: 'Dimension',
              name: 'ServiceName'
            }
          ]
        },
        timeframe: timeframe
      };

      return await callAzureAPI(endpoint, {
        method: 'POST',
        body: JSON.stringify(body)
      });
    }

    // Get Custom Date Range Cost
    async function getCostForDateRange(startDate, endDate) {
      const subscriptionId = document.getElementById('subscriptionId').value;
      const endpoint = `/subscriptions/${subscriptionId}/providers/Microsoft.CostManagement/query?api-version=2023-03-01`;
      
      const body = {
        type: 'ActualCost',
        dataSet: {
          granularity: 'Daily',
          aggregation: {
            totalCost: {
              name: 'Cost',
              function: 'Sum'
            },
            totalCostUSD: {
              name: 'CostUSD',
              function: 'Sum'
            }
          }
        },
        timePeriod: {
          from: startDate + 'T00:00:00Z',
          to: endDate + 'T23:59:59Z'
        }
      };

      return await callAzureAPI(endpoint, {
        method: 'POST',
        body: JSON.stringify(body)
      });
    }

    // Get Resources
    async function getResources() {
      const subscriptionId = document.getElementById('subscriptionId').value;
      return await callAzureAPI(`/subscriptions/${subscriptionId}/resources?api-version=2021-04-01`);
    }

    // Get Resource Groups
    async function getResourceGroups() {
      const subscriptionId = document.getElementById('subscriptionId').value;
      return await callAzureAPI(`/subscriptions/${subscriptionId}/resourcegroups?api-version=2021-04-01`);
    }

    // Refresh All Data
    async function refreshData() {
      if (!currentAccount) {
        showMessage('Please sign in first', 'error');
        return;
      }

      showMessage('Loading real-time data from Azure...', 'info');
      
      try {
        // Get resources first (these usually work)
        const [resources, resourceGroups] = await Promise.all([
          getResources(),
          getResourceGroups()
        ]);
        
        // Update resource counts immediately
        updateResourceCounts(resources, resourceGroups);
        
        // Then try to get cost data sequentially (to avoid rate limiting)
        let mtdData, weekData;
        try {
          showMessage('Loading cost data (this may take a moment due to API rate limits)...', 'info');
          
          // Get MTD data first
          mtdData = await getCostData('MonthToDate');
          
          // Small delay before next call
          await sleep(1000);
          
          // Get weekly data
          weekData = await getCostData('TheLastWeek');
          
          // Update cost cards with available data
          if (mtdData || weekData) {
            updateCostCards(mtdData, null, null, weekData);
            updateCostBreakdown(mtdData);
            showMessage('Cost data loaded successfully!', 'success');
          }
        } catch (costError) {
          console.error('Cost API error (this may be due to permissions):', costError);
          showMessage('Note: Cost data requires Cost Management Reader role', 'error');
          // Set default values for cost displays
          document.getElementById('mtdCost').textContent = 'N/A';
          document.getElementById('yesterdayCost').textContent = 'N/A';
          document.getElementById('todayCost').textContent = 'N/A';
          document.getElementById('weekCost').textContent = 'N/A';
          document.getElementById('costBreakdownTable').innerHTML = '<tr><td colspan="5" style="text-align: center;">Cost data requires Cost Management Reader role</td></tr>';
        }
        
        // Update resources table
        updateResourcesTable(resources);

        showMessage('Data refreshed successfully!', 'success');
        
      } catch (error) {
        console.error('Data refresh error:', error);
        showMessage('Error loading data: ' + error.message, 'error');
      }
    }

    // Update Cost Cards
    function updateCostCards(mtdData, yesterdayData, todayData, weekData) {
      // MTD Cost
      if (mtdData?.properties?.rows) {
        const total = mtdData.properties.rows.reduce((sum, row) => sum + (row[1] || 0), 0);
        document.getElementById('mtdCost').textContent = `$${total.toFixed(2)}`;
        
        const startDate = new Date();
        startDate.setDate(1);
        document.getElementById('mtdDates').textContent = 
          `${startDate.toLocaleDateString()} - ${new Date().toLocaleDateString()}`;
      }

      // Yesterday's Cost
      if (yesterdayData?.properties?.rows) {
        const total = yesterdayData.properties.rows.reduce((sum, row) => sum + (row[0] || 0), 0);
        document.getElementById('yesterdayCost').textContent = `$${total.toFixed(2)}`;
        document.getElementById('yesterdayDate').textContent = new Date(getYesterdayDate()).toLocaleDateString();
      }

      // Today's Cost
      if (todayData?.properties?.rows) {
        const total = todayData.properties.rows.reduce((sum, row) => sum + (row[0] || 0), 0);
        document.getElementById('todayCost').textContent = `$${total.toFixed(2)}`;
      }

      // Weekly Cost
      if (weekData?.properties?.rows) {
        const total = weekData.properties.rows.reduce((sum, row) => sum + (row[1] || 0), 0);
        document.getElementById('weekCost').textContent = `$${total.toFixed(2)}`;
      }
    }

    // Update Resource Counts
    function updateResourceCounts(resources, resourceGroups) {
      // Resource Groups
      document.getElementById('rgCount').textContent = resourceGroups?.value?.length || 0;

      // Parse resources by type
      if (resources?.value) {
        const resourcesByType = {};
        resources.value.forEach(resource => {
          const type = resource.type.toLowerCase();
          resourcesByType[type] = (resourcesByType[type] || 0) + 1;
        });

        // VMs
        const vmCount = resourcesByType['microsoft.compute/virtualmachines'] || 0;
        document.getElementById('vmCount').textContent = vmCount;
        document.getElementById('vmStatus').textContent = `${vmCount} total VMs`;

        // Storage
        const storageCount = resourcesByType['microsoft.storage/storageaccounts'] || 0;
        document.getElementById('storageCount').textContent = storageCount;

        // Web Apps
        const staticSites = resourcesByType['microsoft.web/staticsites'] || 0;
        const functionApps = resourcesByType['microsoft.web/sites'] || 0;
        document.getElementById('webAppCount').textContent = staticSites + functionApps;
      }
    }

    // Update Cost Breakdown Table
    function updateCostBreakdown(costData) {
      const table = document.getElementById('costBreakdownTable');
      
      if (!costData?.properties?.rows || costData.properties.rows.length === 0) {
        table.innerHTML = '<tr><td colspan="5" style="text-align: center;">No cost data available</td></tr>';
        return;
      }

      // Aggregate by service
      const serviceData = {};
      let totalCost = 0;
      
      costData.properties.rows.forEach(row => {
        const service = row[0] || 'Unknown';
        const cost = row[1] || 0;
        
        if (!serviceData[service]) {
          serviceData[service] = { cost: 0, count: 0 };
        }
        serviceData[service].cost += cost;
        serviceData[service].count++;
        totalCost += cost;
      });

      // Sort by cost
      const sortedServices = Object.entries(serviceData)
        .sort((a, b) => b[1].cost - a[1].cost)
        .slice(0, 10);

      // Generate table rows
      table.innerHTML = sortedServices.map(([service, data]) => {
        const percentage = ((data.cost / totalCost) * 100).toFixed(1);
        const dailyAvg = (data.cost / new Date().getDate()).toFixed(2);
        
        return `
          <tr>
            <td>${service}</td>
            <td>${data.count}</td>
            <td>$${data.cost.toFixed(2)}</td>
            <td>$${dailyAvg}</td>
            <td>${percentage}%</td>
          </tr>
        `;
      }).join('');
    }

    // Update Resources Table
    function updateResourcesTable(resources) {
      const table = document.getElementById('resourcesTable');
      
      if (!resources?.value || resources.value.length === 0) {
        table.innerHTML = '<tr><td colspan="5" style="text-align: center;">No resources found</td></tr>';
        return;
      }

      // Take first 10 resources (in production, you'd sort by cost)
      const topResources = resources.value.slice(0, 10);
      
      table.innerHTML = topResources.map(resource => `
        <tr>
          <td>${resource.name}</td>
          <td>${resource.type.split('/').pop()}</td>
          <td>${resource.resourceGroup || '--'}</td>
          <td>${resource.location}</td>
          <td>--</td>
        </tr>
      `).join('');
    }

    // Helper Functions
    function getTodayDate() {
      return new Date().toISOString().split('T')[0];
    }

    function getYesterdayDate() {
      const date = new Date();
      date.setDate(date.getDate() - 1);
      return date.toISOString().split('T')[0];
    }

    function showMessage(message, type = 'info') {
      const messageEl = document.getElementById('statusMessage');
      messageEl.textContent = message;
      messageEl.className = `status-message active status-${type}`;
      
      if (type !== 'error') {
        setTimeout(() => {
          messageEl.classList.remove('active');
        }, 5000);
      }
    }

    // Update Subscription
    function updateSubscription() {
      const newSubscriptionId = document.getElementById('subscriptionId').value;
      if (newSubscriptionId) {
        localStorage.setItem('azure_subscription', newSubscriptionId);
        refreshData();
      }
    }

    // Test Connection
    async function testConnection() {
      try {
        showMessage('Testing Azure connection...', 'info');
        const groups = await getResourceGroups();
        showMessage(`Connection successful! Found ${groups.value.length} resource groups.`, 'success');
      } catch (error) {
        showMessage('Connection failed: ' + error.message, 'error');
      }
    }

    // Initialize on page load
    window.addEventListener('load', async () => {
      // Load saved subscription ID
      const savedSubscription = localStorage.getItem('azure_subscription');
      if (savedSubscription) {
        document.getElementById('subscriptionId').value = savedSubscription;
      }

      // Initialize MSAL
      await initializeMSAL();
    });
  </script>
</body>
</html>
