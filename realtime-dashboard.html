<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>SAXTech Real-Time Azure Dashboard</title>
  
  <!-- MSAL.js for Azure AD Authentication -->
  <script src="https://alcdn.msauth.net/browser/2.32.2/js/msal-browser.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #060818 100%);
      color: #e2e8f0;
      min-height: 100vh;
    }
    
    .header {
      background: rgba(15, 23, 41, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 212, 255, 0.2);
      padding: 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .user-section {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .user-info {
      display: none;
      align-items: center;
      gap: 15px;
    }
    
    .user-info.active {
      display: flex;
    }
    
    .user-email {
      color: #94a3b8;
      font-size: 14px;
    }
    
    .btn {
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: rgba(124, 58, 237, 0.2);
      border: 1px solid rgba(124, 58, 237, 0.5);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    /* Auth Section */
    .auth-section {
      background: rgba(15, 23, 41, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .auth-section.hidden {
      display: none;
    }
    
    .auth-title {
      font-size: 20px;
      margin-bottom: 15px;
      color: #00d4ff;
    }
    
    .auth-description {
      color: #94a3b8;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    /* Status Messages */
    .status-message {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    
    .status-message.active {
      display: block;
    }
    
    .status-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
    }
    
    .status-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .status-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #3b82f6;
    }
    
    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .metric-card {
      background: rgba(15, 23, 41, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
    }
    
    .metric-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #94a3b8;
      margin-bottom: 10px;
    }
    
    .metric-value {
      font-size: 32px;
      font-weight: 800;
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 5px;
    }
    
    .metric-subtitle {
      font-size: 12px;
      color: #64748b;
    }
    
    .metric-loading {
      opacity: 0.5;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.8; }
    }
    
    /* Data Table */
    .data-section {
      background: rgba(15, 23, 41, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #00d4ff;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      text-align: left;
      padding: 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #94a3b8;
      border-bottom: 1px solid rgba(0, 212, 255, 0.2);
    }
    
    .data-table td {
      padding: 10px;
      color: #e2e8f0;
      border-bottom: 1px solid rgba(0, 212, 255, 0.1);
    }
    
    .data-table tr:hover {
      background: rgba(0, 212, 255, 0.05);
    }
    
    /* Loading Spinner */
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0, 212, 255, 0.3);
      border-top-color: #00d4ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Settings Panel */
    .settings-panel {
      background: rgba(15, 23, 41, 0.8);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-label {
      display: block;
      font-size: 12px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }
    
    .input-field {
      width: 100%;
      background: rgba(6, 8, 24, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.2);
      color: #e2e8f0;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #00d4ff;
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }
    
    .code-block {
      background: rgba(6, 8, 24, 0.8);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 8px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #00d4ff;
      overflow-x: auto;
      margin: 10px 0;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      animation: fadeIn 0.3s;
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #0a0e27 0%, #060818 100%);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 16px;
      padding: 30px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideIn 0.3s;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(0, 212, 255, 0.2);
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #94a3b8;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .modal-close:hover {
      color: #00d4ff;
    }
    
    .modal-body {
      color: #e2e8f0;
    }
    
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .detail-item {
      background: rgba(15, 23, 41, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
    }
    
    .detail-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #94a3b8;
      margin-bottom: 5px;
    }
    
    .detail-value {
      font-size: 18px;
      font-weight: 600;
      color: #00d4ff;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">SAXTech Real-Time Azure Dashboard</div>
      <div class="user-section">
        <button id="signInButton" class="btn" onclick="signIn()">Sign In with Azure AD</button>
        <div id="userInfo" class="user-info">
          <span class="user-email" id="userEmail">Not signed in</span>
          <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
          <button class="btn" onclick="signOut()">Sign Out</button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Authentication Section -->
    <div id="authSection" class="auth-section">
      <h2 class="auth-title">üîê Azure AD Authentication Required</h2>
      <p class="auth-description">
        This dashboard connects directly to Azure Management APIs for real-time data.<br>
        Please sign in with your Azure AD account to continue.
      </p>
      <button class="btn" onclick="signIn()">Sign In with Microsoft Account</button>
    </div>

    <!-- Status Messages -->
    <div id="statusMessage" class="status-message"></div>

    <!-- Main Dashboard (Hidden until authenticated) -->
    <div id="mainDashboard" style="display: none;">
      <!-- Cost Metrics -->
      <div class="dashboard-grid">
        <div class="metric-card" onclick="window.drillDownMetric('mtd')" style="cursor: pointer;" title="Click for details">
          <div class="metric-label">Month-to-Date Cost</div>
          <div class="metric-value" id="mtdCost">--</div>
          <div class="metric-subtitle" id="mtdDates">Loading...</div>
        </div>
        
        <div class="metric-card" onclick="window.drillDownMetric('yesterday')" style="cursor: pointer;" title="Click for details">
          <div class="metric-label">Yesterday's Cost</div>
          <div class="metric-value" id="yesterdayCost">--</div>
          <div class="metric-subtitle" id="yesterdayDate">--</div>
        </div>
        
        <div class="metric-card" onclick="window.drillDownMetric('today')" style="cursor: pointer;" title="Click for details">
          <div class="metric-label">Today's Cost (Live)</div>
          <div class="metric-value" id="todayCost">--</div>
          <div class="metric-subtitle">Real-time from Azure</div>
        </div>
        
        <div class="metric-card" onclick="window.drillDownMetric('week')" style="cursor: pointer;" title="Click for details">
          <div class="metric-label">Last 7 Days</div>
          <div class="metric-value" id="weekCost">--</div>
          <div class="metric-subtitle">Weekly spending</div>
        </div>
      </div>

      <!-- Resource Counts -->
      <div class="dashboard-grid">
        <div class="metric-card" onclick="window.drillDownResourceType('resourceGroups')" style="cursor: pointer;" title="Click for details">
          <div class="metric-label">Resource Groups</div>
          <div class="metric-value" id="rgCount">--</div>
          <div class="metric-subtitle">Active groups</div>
        </div>
        
        <div class="metric-card" onclick="window.drillDownResourceType('virtualMachines')" style="cursor: pointer;" title="Click for details">
          <div class="metric-label">Virtual Machines</div>
          <div class="metric-value" id="vmCount">--</div>
          <div class="metric-subtitle" id="vmStatus">--</div>
        </div>
        
        <div class="metric-card" onclick="window.drillDownResourceType('storageAccounts')" style="cursor: pointer;" title="Click for details">
          <div class="metric-label">Storage Accounts</div>
          <div class="metric-value" id="storageCount">--</div>
          <div class="metric-subtitle">Total accounts</div>
        </div>
        
        <div class="metric-card" onclick="window.drillDownResourceType('webApps')" style="cursor: pointer;" title="Click for details">
          <div class="metric-label">Web Apps</div>
          <div class="metric-value" id="webAppCount">--</div>
          <div class="metric-subtitle">Static + Function</div>
        </div>
      </div>

      <!-- Detailed Cost Breakdown -->
      <div class="data-section">
        <h3 class="section-title">Cost Breakdown by Service (Last 30 Days)</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Service</th>
              <th>Resource Count</th>
              <th>Month-to-Date</th>
              <th>Daily Average</th>
              <th>% of Total</th>
            </tr>
          </thead>
          <tbody id="costBreakdownTable">
            <tr><td colspan="5" style="text-align: center;"><div class="spinner"></div></td></tr>
          </tbody>
        </table>
      </div>

      <!-- Resources List -->
      <div class="data-section">
        <h3 class="section-title">Top 10 Resources by Cost</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Resource Name</th>
              <th>Type</th>
              <th>Resource Group</th>
              <th>Location</th>
              <th>MTD Cost</th>
            </tr>
          </thead>
          <tbody id="resourcesTable">
            <tr><td colspan="5" style="text-align: center;"><div class="spinner"></div></td></tr>
          </tbody>
        </table>
      </div>

      <!-- Settings -->
      <div class="settings-panel">
        <h3 class="section-title">Azure Configuration</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div class="input-group">
            <label class="input-label">Subscription ID</label>
            <input type="text" class="input-field" id="subscriptionId" value="3cfb259a-f02a-484e-9ce3-d83c21fd0ddb">
          </div>
          <div class="input-group">
            <label class="input-label">Tenant ID</label>
            <input type="text" class="input-field" id="tenantId" value="3d659328-eef0-44f7-8481-5833e1051aec" readonly>
          </div>
        </div>
        <div style="margin-top: 15px;">
          <button class="btn btn-secondary" onclick="updateSubscription()">Update Subscription</button>
          <button class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
        </div>
        
        <div class="code-block" style="margin-top: 20px;">
          <strong>API Endpoints Being Used:</strong><br>
          Cost Management: https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.CostManagement/query<br>
          Resources: https://management.azure.com/subscriptions/{subscriptionId}/resources<br>
          Resource Groups: https://management.azure.com/subscriptions/{subscriptionId}/resourcegroups
        </div>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Details</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content will be dynamically inserted here -->
      </div>
    </div>
  </div>

  <script>
    // MSAL Configuration
    const msalConfig = {
      auth: {
        clientId: 'c1a20824-c427-46f0-a819-53d657d6ea7f', // SAXTech Real-Time Dashboard App
        authority: 'https://login.microsoftonline.com/3d659328-eef0-44f7-8481-5833e1051aec',
        // Use the specific domain to avoid redirect URI mismatch
        redirectUri: 'https://repository.saxtechnology.com/realtime-dashboard.html',
        navigateToLoginRequestUrl: false // Prevent automatic navigation to avoid loops
      },
      cache: {
        cacheLocation: 'localStorage',
        storeAuthStateInCookie: true // Enable cookie storage for better compatibility
      },
      system: {
        loggerOptions: {
          loggerCallback: (level, message, containsPii) => {
            if (containsPii) return;
            console.log(message);
          },
          logLevel: msal.LogLevel.Warning
        }
      }
    };

    // MSAL Instance
    const msalInstance = new msal.PublicClientApplication(msalConfig);

    // Azure Management API Scopes
    const loginRequest = {
      scopes: ['https://management.azure.com/user_impersonation']
    };

    const tokenRequest = {
      scopes: ['https://management.azure.com/.default'],
      forceRefresh: false
    };

    let currentAccount = null;
    let isAuthenticating = false; // Guard against concurrent auth attempts

    // Initialize MSAL
    async function initializeMSAL() {
      console.log('Initializing MSAL...');
      
      try {
        // Always handle redirect promise first, even if there's no apparent redirect
        const response = await msalInstance.handleRedirectPromise();
        
        if (response && response.account) {
          console.log('Login successful via redirect!');
          currentAccount = response.account;
          msalInstance.setActiveAccount(response.account);
          
          // Clear the URL parameters to prevent loops
          const urlParams = new URLSearchParams(window.location.search);
          if (urlParams.has('code') || urlParams.has('error') || urlParams.has('state')) {
            window.history.replaceState({}, document.title, window.location.pathname);
          }
          
          showMessage('Successfully signed in!', 'success');
          await onSignIn();
          return;
        }
        
        // Check if we have URL parameters indicating a failed redirect
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('error')) {
          const error = urlParams.get('error');
          const errorDesc = urlParams.get('error_description');
          console.error('Auth error from redirect:', error, errorDesc);
          window.history.replaceState({}, document.title, window.location.pathname);
          showMessage(`Authentication failed: ${errorDesc || error}`, 'error');
        }
        
        // Check for existing accounts
        const accounts = msalInstance.getAllAccounts();
        if (accounts && accounts.length > 0) {
          console.log('Found existing account');
          currentAccount = accounts[0];
          msalInstance.setActiveAccount(accounts[0]);
          await onSignIn();
        } else {
          console.log('No authenticated user, showing login UI');
          document.getElementById('authSection').classList.remove('hidden');
        }
        
      } catch (error) {
        console.error('MSAL initialization error:', error);
        
        // Clear any auth-related URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.has('code') || urlParams.has('error') || urlParams.has('state')) {
          window.history.replaceState({}, document.title, window.location.pathname);
        }
        
        // Only show error if it's not an interaction_in_progress error
        if (!error.errorCode || error.errorCode !== 'interaction_in_progress') {
          showMessage('Authentication error: ' + error.message, 'error');
        }
        
        document.getElementById('authSection').classList.remove('hidden');
      } finally {
        // Reset auth flag
        isAuthenticating = false;
      }
    }

    // Sign In
    async function signIn() {
      // Prevent concurrent authentication attempts
      if (isAuthenticating) {
        console.log('Authentication already in progress, skipping...');
        return;
      }
      
      isAuthenticating = true;
      
      try {
        console.log('Starting sign in process...');
        
        // Check if we're already authenticated
        const accounts = msalInstance.getAllAccounts();
        if (accounts && accounts.length > 0) {
          console.log('Already have an account, using it');
          currentAccount = accounts[0];
          msalInstance.setActiveAccount(accounts[0]);
          await onSignIn();
          return;
        }
        
        // Check for interaction in progress error
        try {
          // Try to get active account first
          const activeAccount = msalInstance.getActiveAccount();
          if (activeAccount) {
            currentAccount = activeAccount;
            await onSignIn();
            return;
          }
        } catch (e) {
          console.log('No active account found');
        }
        
        // Determine authentication method
        const usePopup = localStorage.getItem('usePopupAuth') === 'true';
        
        if (usePopup) {
          console.log('Using popup authentication');
          showMessage('Opening Microsoft login popup...', 'info');
          
          try {
            const response = await msalInstance.loginPopup({
              ...loginRequest,
              prompt: 'select_account'
            });
            
            if (response && response.account) {
              currentAccount = response.account;
              msalInstance.setActiveAccount(response.account);
              showMessage('Successfully signed in!', 'success');
              await onSignIn();
            }
          } catch (popupError) {
            if (popupError.errorCode === 'popup_window_error' || popupError.errorCode === 'empty_window_error') {
              console.warn('Popup blocked or closed, trying redirect');
              localStorage.removeItem('usePopupAuth');
              showMessage('Popup was blocked. Trying redirect authentication...', 'info');
              
              // Try redirect as fallback
              await msalInstance.loginRedirect({
                ...loginRequest,
                redirectUri: 'https://repository.saxtechnology.com/realtime-dashboard.html',
                prompt: 'select_account'
              });
            } else {
              throw popupError;
            }
          }
        } else {
          console.log('Using redirect authentication');
          
          // Check for recent redirect attempts
          const lastRedirect = localStorage.getItem('lastAuthRedirect');
          const now = Date.now();
          
          if (lastRedirect && (now - parseInt(lastRedirect)) < 10000) {
            console.warn('Recent redirect detected, switching to popup to avoid loop');
            localStorage.setItem('usePopupAuth', 'true');
            
            showMessage('Opening Microsoft login popup...', 'info');
            const response = await msalInstance.loginPopup({
              ...loginRequest,
              prompt: 'select_account'
            });
            
            if (response && response.account) {
              currentAccount = response.account;
              msalInstance.setActiveAccount(response.account);
              showMessage('Successfully signed in!', 'success');
              await onSignIn();
            }
          } else {
            showMessage('Redirecting to Microsoft login...', 'info');
            localStorage.setItem('lastAuthRedirect', now.toString());
            
            await msalInstance.loginRedirect({
              ...loginRequest,
              redirectUri: 'https://repository.saxtechnology.com/realtime-dashboard.html',
              prompt: 'select_account'
            });
          }
        }
      } catch (error) {
        console.error('Login error:', error);
        
        // Handle specific error codes
        if (error.errorCode === 'interaction_in_progress') {
          console.log('Interaction already in progress, waiting...');
          showMessage('Authentication in progress, please wait...', 'info');
          
          // Wait a bit and check if we're authenticated
          setTimeout(async () => {
            const accounts = msalInstance.getAllAccounts();
            if (accounts && accounts.length > 0) {
              currentAccount = accounts[0];
              msalInstance.setActiveAccount(accounts[0]);
              await onSignIn();
            } else {
              showMessage('Please try signing in again', 'info');
            }
          }, 2000);
        } else if (error.errorCode === 'user_cancelled') {
          showMessage('Sign in cancelled', 'info');
        } else {
          showMessage('Login failed: ' + (error.message || 'Unknown error'), 'error');
          
          // If redirect fails, suggest popup
          if (error.message && error.message.includes('redirect')) {
            localStorage.setItem('usePopupAuth', 'true');
            showMessage('Redirect failed. Click Sign In to try popup authentication.', 'info');
          }
        }
      } finally {
        // Reset authentication flag after a delay
        setTimeout(() => {
          isAuthenticating = false;
        }, 1000);
      }
    }

    // Sign Out
    function signOut() {
      msalInstance.logoutRedirect({
        account: currentAccount
      });
    }

    // Handle successful sign in
    async function onSignIn() {
      if (!currentAccount) return;

      // Update UI
      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('signInButton').style.display = 'none';
      document.getElementById('userInfo').classList.add('active');
      document.getElementById('userEmail').textContent = currentAccount.username || currentAccount.name;
      document.getElementById('mainDashboard').style.display = 'block';

      // Load data
      await refreshData();
    }

    // Get Access Token
    async function getAccessToken() {
      try {
        const response = await msalInstance.acquireTokenSilent({
          ...tokenRequest,
          account: currentAccount
        });
        return response.accessToken;
      } catch (error) {
        console.error('Token acquisition failed, attempting interactive:', error);
        const response = await msalInstance.acquireTokenRedirect(tokenRequest);
        return response.accessToken;
      }
    }

    // Rate limiting configuration
    const rateLimitConfig = {
      costApiDelay: 10000, // 10 seconds between Cost API calls
      maxRetries: 3,
      retryDelay: 30000 // 30 seconds between retries for 429 errors
    };
    
    let lastCostApiCall = 0;
    
    // Sleep function for delays
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // Azure API Helper with retry logic
    async function callAzureAPI(endpoint, options = {}, retryCount = 0) {
      try {
        // Rate limiting for Cost Management API
        if (endpoint.includes('/providers/Microsoft.CostManagement/')) {
          const now = Date.now();
          const timeSinceLastCall = now - lastCostApiCall;
          if (timeSinceLastCall < rateLimitConfig.costApiDelay) {
            await sleep(rateLimitConfig.costApiDelay - timeSinceLastCall);
          }
          lastCostApiCall = Date.now();
        }
        
        const token = await getAccessToken();
        const response = await fetch(`https://management.azure.com${endpoint}`, {
          ...options,
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            ...options.headers
          }
        });

        if (!response.ok) {
          // Handle rate limiting (429)
          if (response.status === 429 && retryCount < rateLimitConfig.maxRetries) {
            console.log(`Rate limited. Retrying in ${rateLimitConfig.retryDelay}ms... (Attempt ${retryCount + 1}/${rateLimitConfig.maxRetries})`);
            await sleep(rateLimitConfig.retryDelay);
            return callAzureAPI(endpoint, options, retryCount + 1);
          }
          
          // Try to get error details from response
          let errorMessage = `${response.status} ${response.statusText}`;
          try {
            const errorData = await response.json();
            if (errorData.error) {
              errorMessage = errorData.error.message || errorData.error.code || errorMessage;
            }
            console.error('API Error Details:', errorData);
          } catch (e) {
            // Response wasn't JSON
          }
          throw new Error(`API Error: ${errorMessage}`);
        }

        return await response.json();
      } catch (error) {
        console.error('Azure API call failed:', error);
        throw error;
      }
    }

    // Get Cost Data
    async function getCostData(timeframe = 'MonthToDate') {
      const subscriptionId = document.getElementById('subscriptionId').value;
      const endpoint = `/subscriptions/${subscriptionId}/providers/Microsoft.CostManagement/query?api-version=2023-03-01`;
      
      const body = {
        type: 'ActualCost',
        dataSet: {
          granularity: 'Daily',
          aggregation: {
            totalCost: {
              name: 'Cost',
              function: 'Sum'
            },
            totalCostUSD: {
              name: 'CostUSD',
              function: 'Sum'
            }
          },
          grouping: [
            {
              type: 'Dimension',
              name: 'ServiceName'  // This might be returning codes instead of names
            }
          ]
        },
        timeframe: timeframe
      };

      const result = await callAzureAPI(endpoint, {
        method: 'POST',
        body: JSON.stringify(body)
      });
      
      // Log to see what Azure is actually returning
      if (result?.properties?.rows && result.properties.rows.length > 0) {
        console.log('Sample service names from Azure:', result.properties.rows.slice(0, 3).map(r => r[0]));
      }
      
      return result;
    }

    // Get Custom Date Range Cost
    async function getCostForDateRange(startDate, endDate) {
      const subscriptionId = document.getElementById('subscriptionId').value;
      const endpoint = `/subscriptions/${subscriptionId}/providers/Microsoft.CostManagement/query?api-version=2023-03-01`;
      
      const body = {
        type: 'ActualCost',
        dataSet: {
          granularity: 'Daily',
          aggregation: {
            totalCost: {
              name: 'Cost',
              function: 'Sum'
            },
            totalCostUSD: {
              name: 'CostUSD',
              function: 'Sum'
            }
          }
        },
        timeframe: 'Custom',
        timePeriod: {
          from: startDate + 'T00:00:00Z',
          to: endDate + 'T23:59:59Z'
        }
      };

      return await callAzureAPI(endpoint, {
        method: 'POST',
        body: JSON.stringify(body)
      });
    }

    // Get Resources
    async function getResources() {
      const subscriptionId = document.getElementById('subscriptionId').value;
      return await callAzureAPI(`/subscriptions/${subscriptionId}/resources?api-version=2021-04-01`);
    }

    // Get Resource Groups
    async function getResourceGroups() {
      const subscriptionId = document.getElementById('subscriptionId').value;
      return await callAzureAPI(`/subscriptions/${subscriptionId}/resourcegroups?api-version=2021-04-01`);
    }

    // Refresh All Data
    async function refreshData() {
      if (!currentAccount) {
        showMessage('Please sign in first', 'error');
        return;
      }

      showMessage('Loading real-time data from Azure...', 'info');
      
      try {
        // Get resources first (these usually work)
        const [resources, resourceGroups] = await Promise.all([
          getResources(),
          getResourceGroups()
        ]);
        
        // Update resource counts immediately and store for drill-down
        updateResourceCounts(resources, resourceGroups);
        window.allResources = resources;
        window.allResourceGroups = resourceGroups;
        
        // Then try to get cost data sequentially (to avoid rate limiting)
        let mtdData, weekData, yesterdayData, todayData;
        try {
          showMessage('Loading cost data (this may take a moment due to API rate limits)...', 'info');
          
          // Get MTD data first
          mtdData = await getCostData('MonthToDate');
          
          // Store globally for drill-down
          window.lastMtdData = mtdData;
          
          // Longer delay to avoid rate limiting
          await sleep(10000); // Increased to 10 seconds
          
          // Get weekly data
          weekData = await getCostData('TheLastWeek');
          window.lastWeekData = weekData;
          
          // Longer delay to avoid rate limiting
          await sleep(10000); // Increased to 10 seconds
          
          // Get yesterday's data
          yesterdayData = await getCostForDateRange(getYesterdayDate(), getYesterdayDate());
          window.lastYesterdayData = yesterdayData;
          
          // Longer delay to avoid rate limiting
          await sleep(10000); // Increased to 10 seconds
          
          // Get today's data
          todayData = await getCostForDateRange(getTodayDate(), getTodayDate());
          window.lastTodayData = todayData;
          
          // Update cost cards with available data
          if (mtdData || weekData || yesterdayData || todayData) {
            updateCostCards(mtdData, yesterdayData, todayData, weekData);
            updateCostBreakdown(mtdData);
            showMessage('Cost data loaded successfully!', 'success');
          }
        } catch (costError) {
          console.error('Cost API error (this may be due to permissions):', costError);
          showMessage('Note: Cost data requires Cost Management Reader role', 'error');
          // Set default values for cost displays
          document.getElementById('mtdCost').textContent = 'N/A';
          document.getElementById('yesterdayCost').textContent = 'N/A';
          document.getElementById('todayCost').textContent = 'N/A';
          document.getElementById('weekCost').textContent = 'N/A';
          document.getElementById('costBreakdownTable').innerHTML = '<tr><td colspan="5" style="text-align: center;">Cost data requires Cost Management Reader role</td></tr>';
        }
        
        // Update resources table (pass mtdData for costs if available)
        updateResourcesTable(resources, mtdData);

        showMessage('Data refreshed successfully!', 'success');
        
      } catch (error) {
        console.error('Data refresh error:', error);
        showMessage('Error loading data: ' + error.message, 'error');
      }
    }

    // Update Cost Cards
    function updateCostCards(mtdData, yesterdayData, todayData, weekData) {
      // MTD Cost
      if (mtdData?.properties?.rows) {
        const total = mtdData.properties.rows.reduce((sum, row) => sum + (row[1] || 0), 0);
        document.getElementById('mtdCost').textContent = `$${total.toFixed(2)}`;
        
        const startDate = new Date();
        startDate.setDate(1);
        document.getElementById('mtdDates').textContent = 
          `${startDate.toLocaleDateString()} - ${new Date().toLocaleDateString()}`;
      }

      // Yesterday's Cost
      if (yesterdayData?.properties?.rows) {
        const total = yesterdayData.properties.rows.reduce((sum, row) => sum + (row[0] || 0), 0);
        document.getElementById('yesterdayCost').textContent = `$${total.toFixed(2)}`;
        document.getElementById('yesterdayDate').textContent = new Date(getYesterdayDate()).toLocaleDateString();
      }

      // Today's Cost
      if (todayData?.properties?.rows) {
        const total = todayData.properties.rows.reduce((sum, row) => sum + (row[0] || 0), 0);
        document.getElementById('todayCost').textContent = `$${total.toFixed(2)}`;
      }

      // Weekly Cost
      if (weekData?.properties?.rows) {
        const total = weekData.properties.rows.reduce((sum, row) => sum + (row[1] || 0), 0);
        document.getElementById('weekCost').textContent = `$${total.toFixed(2)}`;
      }
    }

    // Update Resource Counts
    function updateResourceCounts(resources, resourceGroups) {
      // Resource Groups
      document.getElementById('rgCount').textContent = resourceGroups?.value?.length || 0;

      // Parse resources by type
      if (resources?.value) {
        const resourcesByType = {};
        resources.value.forEach(resource => {
          const type = resource.type.toLowerCase();
          resourcesByType[type] = (resourcesByType[type] || 0) + 1;
        });

        // VMs
        const vmCount = resourcesByType['microsoft.compute/virtualmachines'] || 0;
        document.getElementById('vmCount').textContent = vmCount;
        document.getElementById('vmStatus').textContent = `${vmCount} total VMs`;

        // Storage
        const storageCount = resourcesByType['microsoft.storage/storageaccounts'] || 0;
        document.getElementById('storageCount').textContent = storageCount;

        // Web Apps
        const staticSites = resourcesByType['microsoft.web/staticsites'] || 0;
        const functionApps = resourcesByType['microsoft.web/sites'] || 0;
        document.getElementById('webAppCount').textContent = staticSites + functionApps;
      }
    }

    // Service name mapping - expanded to handle Azure service codes
    const serviceNameMap = {
      // Common numeric codes from Azure
      '1': 'Virtual Machines',
      '2': 'Storage',
      '3': 'Bandwidth',
      '4': 'Virtual Network',
      '5': 'Azure App Service',
      '6': 'Azure SQL Database',
      '7': 'Key Vault',
      '8': 'Load Balancer',
      '9': 'Azure DNS',
      '10': 'Azure Monitor',
      '11': 'Azure Active Directory',
      '12': 'Container Registry',
      '13': 'Azure Functions',
      '14': 'Azure Kubernetes Service',
      '15': 'Azure Backup',
      '16': 'Logic Apps',
      '17': 'Azure Cognitive Services',
      '18': 'Azure DevOps',
      '19': 'Azure Data Factory',
      '20': 'Static Web Apps',
      // Service codes
      'a1': 'API Management',
      'a2': 'Application Gateway',
      'a3': 'Azure Cosmos DB',
      'a4': 'Azure Database for MySQL',
      'a5': 'Azure Database for PostgreSQL',
      'a6': 'Azure Firewall',
      'a7': 'Azure Front Door',
      'a8': 'Azure IoT Hub',
      'a9': 'Azure Machine Learning',
      'b1': 'Azure Redis Cache',
      'b2': 'Azure Search',
      'b3': 'Azure Service Bus',
      'b4': 'Azure Stream Analytics',
      'b5': 'Azure Synapse Analytics',
      'b6': 'Cognitive Services',
      'b7': 'Event Hubs',
      'b8': 'ExpressRoute',
      'b9': 'HDInsight',
      'c1': 'Media Services',
      'c2': 'Notification Hubs',
      'c3': 'Power BI Embedded',
      'c4': 'Traffic Manager',
      'c5': 'VPN Gateway',
      // Microsoft resource providers
      'microsoft.compute': 'Compute',
      'microsoft.storage': 'Storage',
      'microsoft.network': 'Networking',
      'microsoft.web': 'Web Apps',
      'microsoft.sql': 'SQL Database',
      'microsoft.keyvault': 'Key Vault',
      'microsoft.insights': 'Azure Monitor',
      'microsoft.containerregistry': 'Container Registry',
      'microsoft.kubernetes': 'Kubernetes Service',
      'microsoft.documentdb': 'Cosmos DB',
      'microsoft.cache': 'Redis Cache',
      'microsoft.search': 'Azure Search',
      'microsoft.servicebus': 'Service Bus',
      'microsoft.eventhub': 'Event Hubs',
      'microsoft.streamanalytics': 'Stream Analytics',
      'microsoft.logic': 'Logic Apps',
      'microsoft.apimanagement': 'API Management',
      'microsoft.cognitiveservices': 'Cognitive Services',
      'microsoft.machinelearning': 'Machine Learning',
      'microsoft.devices': 'IoT Hub',
      'microsoft.media': 'Media Services'
    };
    
    // Update Cost Breakdown Table
    function updateCostBreakdown(costData) {
      const table = document.getElementById('costBreakdownTable');
      
      if (!costData?.properties?.rows || costData.properties.rows.length === 0) {
        table.innerHTML = '<tr><td colspan="5" style="text-align: center;">No cost data available</td></tr>';
        return;
      }

      // Log the raw data to understand what Azure is returning
      console.log('Raw cost data rows:', costData.properties.rows.slice(0, 5));

      // Aggregate by service
      const serviceData = {};
      let totalCost = 0;
      
      costData.properties.rows.forEach(row => {
        // Ensure service is a string
        let service = String(row[0] || 'Unknown');
        const cost = row[1] || 0;
        
        // First, check if this looks like a decimal number (common Azure pattern)
        if (/^\d+\.\d+$/.test(service) || /^\d+$/.test(service)) {
          // Try to map common decimal codes to services
          const serviceCode = parseFloat(service).toFixed(0);
          
          // Map based on common Azure service codes
          const decimalServiceMap = {
            '8': 'Storage',
            '7': 'Virtual Network',
            '5': 'Azure DNS',
            '3': 'Load Balancer',
            '2': 'Virtual Machines',
            '1': 'App Service',
            '0': 'Bandwidth',
            '4': 'Azure Active Directory',
            '6': 'Key Vault',
            '9': 'Azure Monitor',
            '10': 'Container Registry',
            '11': 'Azure SQL Database',
            '12': 'Azure Functions',
            '13': 'Static Web Apps',
            '14': 'Application Gateway',
            '15': 'Azure Firewall'
          };
          
          if (decimalServiceMap[serviceCode]) {
            service = decimalServiceMap[serviceCode];
          } else {
            // For unknown codes, try to be more descriptive
            service = `Azure Service (Code: ${service})`;
          }
        } else {
          // Try existing mapping
          const serviceLower = service.toLowerCase();
          if (serviceNameMap[service]) {
            service = serviceNameMap[service];
          } else if (serviceNameMap[serviceLower]) {
            service = serviceNameMap[serviceLower];
          } else if (service.includes('.')) {
            // Handle microsoft.* services
            service = service.replace(/microsoft\./gi, '')
                            .replace(/[_-]/g, ' ')
                            .split(' ')
                            .filter(word => word.length > 0)
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                            .join(' ');
          } else {
            // Clean up any other format
            service = service.replace(/[_-]/g, ' ')
                            .split(' ')
                            .filter(word => word.length > 0)
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
                            .join(' ');
            
            // If still looks weird, prefix it
            if (service.length <= 3 || /^[A-Z0-9]+$/.test(service)) {
              service = `Azure ${service}`;
            }
          }
        }
        
        if (!serviceData[service]) {
          serviceData[service] = { cost: 0, count: 0, originalName: String(row[0] || 'Unknown') };
        }
        serviceData[service].cost += cost;
        serviceData[service].count++;
        totalCost += cost;
      });

      // Sort by cost
      const sortedServices = Object.entries(serviceData)
        .sort((a, b) => b[1].cost - a[1].cost)
        .slice(0, 10);

      // Generate table rows with drill-down capability
      table.innerHTML = sortedServices.map(([service, data]) => {
        const percentage = ((data.cost / totalCost) * 100).toFixed(1);
        const dailyAvg = (data.cost / new Date().getDate()).toFixed(2);
        
        // Escape single quotes in strings for onclick
        const escapedOriginalName = data.originalName.replace(/'/g, "\\'");
        const escapedService = service.replace(/'/g, "\\'");
        
        return `
          <tr style="cursor: pointer;" onclick="window.drillDownService('${escapedOriginalName}', '${escapedService}', ${data.cost})" title="Click to see details">
            <td style="color: #00d4ff; text-decoration: underline;">${service}</td>
            <td>${data.count}</td>
            <td>$${data.cost.toFixed(2)}</td>
            <td>$${dailyAvg}</td>
            <td>${percentage}%</td>
          </tr>
        `;
      }).join('');
    }

    // Update Resources Table
    async function updateResourcesTable(resources, costData) {
      const table = document.getElementById('resourcesTable');
      
      if (!resources?.value || resources.value.length === 0) {
        table.innerHTML = '<tr><td colspan="5" style="text-align: center;">No resources found</td></tr>';
        return;
      }

      // Extract resource group from ID
      const getResourceGroup = (id) => {
        const match = id.match(/resourceGroups\/([^\/]+)/);
        return match ? match[1] : '--';
      };
      
      // Get resource costs if available
      const resourceCosts = {};
      if (costData) {
        try {
          const subscriptionId = document.getElementById('subscriptionId').value;
          const endpoint = `/subscriptions/${subscriptionId}/providers/Microsoft.CostManagement/query?api-version=2023-03-01`;
          
          const body = {
            type: 'ActualCost',
            dataSet: {
              granularity: 'None',
              aggregation: {
                totalCost: {
                  name: 'Cost',
                  function: 'Sum'
                },
                totalCostUSD: {
                  name: 'CostUSD',
                  function: 'Sum'
                }
              },
              grouping: [
                {
                  type: 'Dimension',
                  name: 'ResourceId'
                }
              ]
            },
            timeframe: 'MonthToDate'
          };

          const resourceCostData = await callAzureAPI(endpoint, {
            method: 'POST',
            body: JSON.stringify(body)
          });
          
          if (resourceCostData?.properties?.rows) {
            resourceCostData.properties.rows.forEach(row => {
              const resourceId = row[0];
              const cost = row[1] || 0;
              if (resourceId) {
                const resourceName = resourceId.split('/').pop();
                resourceCosts[resourceName] = cost;
              }
            });
          }
        } catch (error) {
          console.log('Could not fetch resource-level costs:', error);
        }
      }

      // Sort resources by cost (if available) or alphabetically
      const sortedResources = resources.value
        .map(resource => ({
          ...resource,
          cost: resourceCosts[resource.name] || 0,
          resourceGroup: getResourceGroup(resource.id)
        }))
        .sort((a, b) => b.cost - a.cost)
        .slice(0, 10);
      
      table.innerHTML = sortedResources.map(resource => {
        // Escape single quotes in strings for onclick
        const escapedId = resource.id.replace(/'/g, "\\'");
        const escapedName = resource.name.replace(/'/g, "\\'");
        
        return `
          <tr style="cursor: pointer;" onclick="window.drillDownResource('${escapedId}', '${escapedName}', ${resource.cost})" title="Click to see details">
            <td style="color: #00d4ff; text-decoration: underline;">${resource.name}</td>
            <td>${resource.type.split('/').pop()}</td>
            <td>${resource.resourceGroup}</td>
            <td>${resource.location}</td>
            <td>${resource.cost > 0 ? `$${resource.cost.toFixed(2)}` : '--'}</td>
          </tr>
        `;
      }).join('');
    }

    // Helper Functions
    function getTodayDate() {
      return new Date().toISOString().split('T')[0];
    }

    function getYesterdayDate() {
      const date = new Date();
      date.setDate(date.getDate() - 1);
      return date.toISOString().split('T')[0];
    }

    function showMessage(message, type = 'info') {
      const messageEl = document.getElementById('statusMessage');
      messageEl.textContent = message;
      messageEl.className = `status-message active status-${type}`;
      
      if (type !== 'error') {
        setTimeout(() => {
          messageEl.classList.remove('active');
        }, 5000);
      }
    }

    // Update Subscription
    function updateSubscription() {
      const newSubscriptionId = document.getElementById('subscriptionId').value;
      if (newSubscriptionId) {
        localStorage.setItem('azure_subscription', newSubscriptionId);
        refreshData();
      }
    }

    // Test Connection
    async function testConnection() {
      try {
        showMessage('Testing Azure connection...', 'info');
        const groups = await getResourceGroups();
        showMessage(`Connection successful! Found ${groups.value.length} resource groups.`, 'success');
      } catch (error) {
        showMessage('Connection failed: ' + error.message, 'error');
      }
    }

    // Drill-down Functions (make them global so onclick can access them)
    window.drillDownService = async function(serviceId, serviceName, cost) {
      const modal = document.getElementById('detailModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      
      modalTitle.textContent = `Service Details: ${serviceName}`;
      modalBody.innerHTML = '<div class="spinner"></div>';
      modal.classList.add('active');
      
      try {
        // Get detailed cost breakdown for this service
        const subscriptionId = document.getElementById('subscriptionId').value;
        const endpoint = `/subscriptions/${subscriptionId}/providers/Microsoft.CostManagement/query?api-version=2023-03-01`;
        
        const body = {
          type: 'ActualCost',
          dataSet: {
            granularity: 'Daily',
            aggregation: {
              totalCost: {
                name: 'Cost',
                function: 'Sum'
              }
            },
            grouping: [
              {
                type: 'Dimension',
                name: 'ResourceGroup'
              }
            ],
            filter: {
              dimensions: {
                name: 'ServiceName',
                operator: 'In',
                values: [serviceId]
              }
            }
          },
          timeframe: 'MonthToDate'
        };
        
        const detailData = await callAzureAPI(endpoint, {
          method: 'POST',
          body: JSON.stringify(body)
        });
        
        // Build detail view
        let html = `
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Service Name</div>
              <div class="detail-value">${serviceName}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Month-to-Date Cost</div>
              <div class="detail-value">$${cost.toFixed(2)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Daily Average</div>
              <div class="detail-value">$${(cost / new Date().getDate()).toFixed(2)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Projected Monthly</div>
              <div class="detail-value">$${(cost / new Date().getDate() * 30).toFixed(2)}</div>
            </div>
          </div>
        `;
        
        if (detailData?.properties?.rows && detailData.properties.rows.length > 0) {
          html += `
            <h3 style="margin-top: 20px; color: #00d4ff;">Cost by Resource Group</h3>
            <table class="data-table" style="margin-top: 10px;">
              <thead>
                <tr>
                  <th>Resource Group</th>
                  <th>Cost</th>
                  <th>% of Service</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          const sortedGroups = detailData.properties.rows
            .sort((a, b) => (b[1] || 0) - (a[1] || 0))
            .slice(0, 10);
          
          sortedGroups.forEach(row => {
            const rgName = row[0] || 'Unknown';
            const rgCost = row[1] || 0;
            const percentage = ((rgCost / cost) * 100).toFixed(1);
            
            html += `
              <tr>
                <td>${rgName}</td>
                <td>$${rgCost.toFixed(2)}</td>
                <td>${percentage}%</td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
        }
        
        modalBody.innerHTML = html;
        
      } catch (error) {
        modalBody.innerHTML = `
          <div style="color: #ef4444; text-align: center;">
            <p>Error loading details: ${error.message}</p>
          </div>
        `;
      }
    }
    
    window.drillDownResource = async function(resourceId, resourceName, cost) {
      const modal = document.getElementById('detailModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      
      modalTitle.textContent = `Resource Details: ${resourceName}`;
      modalBody.innerHTML = '<div class="spinner"></div>';
      modal.classList.add('active');
      
      try {
        // Get resource details
        const subscriptionId = document.getElementById('subscriptionId').value;
        const resourceEndpoint = `${resourceId}?api-version=2021-04-01`;
        const resourceData = await callAzureAPI(resourceEndpoint);
        
        // Extract resource group from ID
        const rgMatch = resourceId.match(/resourceGroups\/([^\/]+)/);
        const resourceGroup = rgMatch ? rgMatch[1] : 'Unknown';
        
        // Build detail view
        let html = `
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Resource Name</div>
              <div class="detail-value">${resourceName}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Resource Type</div>
              <div class="detail-value">${resourceData.type || 'Unknown'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Resource Group</div>
              <div class="detail-value">${resourceGroup}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Location</div>
              <div class="detail-value">${resourceData.location || 'Unknown'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Month-to-Date Cost</div>
              <div class="detail-value">${cost > 0 ? `$${cost.toFixed(2)}` : 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Status</div>
              <div class="detail-value" style="color: #10b981;">Active</div>
            </div>
          </div>
        `;
        
        // Add tags if present
        if (resourceData.tags && Object.keys(resourceData.tags).length > 0) {
          html += `
            <h3 style="margin-top: 20px; color: #00d4ff;">Resource Tags</h3>
            <table class="data-table" style="margin-top: 10px;">
              <thead>
                <tr>
                  <th>Tag Name</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          Object.entries(resourceData.tags).forEach(([key, value]) => {
            html += `
              <tr>
                <td>${key}</td>
                <td>${value}</td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
        }
        
        // Add properties if present
        if (resourceData.properties) {
          html += `
            <h3 style="margin-top: 20px; color: #00d4ff;">Additional Information</h3>
            <div class="code-block" style="margin-top: 10px; max-height: 300px; overflow-y: auto;">
              ${JSON.stringify(resourceData.properties, null, 2)}
            </div>
          `;
        }
        
        modalBody.innerHTML = html;
        
      } catch (error) {
        modalBody.innerHTML = `
          <div style="color: #ef4444; text-align: center;">
            <p>Error loading details: ${error.message}</p>
          </div>
        `;
      }
    }
    
    // Drill-down for metric cards
    window.drillDownMetric = async function(metricType) {
      const modal = document.getElementById('detailModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      
      let title, data;
      switch(metricType) {
        case 'mtd':
          title = 'Month-to-Date Cost Breakdown';
          data = window.lastMtdData;
          break;
        case 'yesterday':
          title = 'Yesterday\'s Cost Breakdown';
          data = window.lastYesterdayData;
          break;
        case 'today':
          title = 'Today\'s Cost Breakdown';
          data = window.lastTodayData;
          break;
        case 'week':
          title = 'Last 7 Days Cost Breakdown';
          data = window.lastWeekData;
          break;
      }
      
      modalTitle.textContent = title;
      modalBody.innerHTML = '<div class="spinner"></div>';
      modal.classList.add('active');
      
      if (!data || !data.properties || !data.properties.rows) {
        modalBody.innerHTML = `
          <div style="color: #ef4444; text-align: center;">
            <p>No detailed data available for this period</p>
          </div>
        `;
        return;
      }
      
      // Process the data by service
      const serviceData = {};
      let totalCost = 0;
      
      data.properties.rows.forEach(row => {
        let service = String(row[0] || 'Unknown');
        const cost = row[1] || row[0] || 0; // Some responses have cost at index 0
        
        // Map service names
        const serviceLower = service.toLowerCase();
        if (serviceNameMap[service]) {
          service = serviceNameMap[service];
        } else if (serviceNameMap[serviceLower]) {
          service = serviceNameMap[serviceLower];
        } else if (!isNaN(service)) {
          // If it's still a number, give it a better name
          service = `Service ${service}`;
        } else {
          // Clean up the service name
          service = service.replace(/microsoft\./gi, '')
                          .replace(/[_-]/g, ' ')
                          .split(' ')
                          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                          .join(' ');
        }
        
        if (!serviceData[service]) {
          serviceData[service] = 0;
        }
        serviceData[service] += cost;
        totalCost += cost;
      });
      
      // Sort services by cost
      const sortedServices = Object.entries(serviceData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 15); // Show top 15
      
      // Build the detail view
      let html = `
        <div class="detail-grid">
          <div class="detail-item">
            <div class="detail-label">Total Cost</div>
            <div class="detail-value">$${totalCost.toFixed(2)}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Services</div>
            <div class="detail-value">${sortedServices.length}</div>
          </div>
        </div>
        
        <h3 style="margin-top: 20px; color: #00d4ff;">Cost by Service</h3>
        <table class="data-table" style="margin-top: 10px;">
          <thead>
            <tr>
              <th>Service</th>
              <th>Cost</th>
              <th>% of Total</th>
            </tr>
          </thead>
          <tbody>
      `;
      
      sortedServices.forEach(([service, cost]) => {
        const percentage = ((cost / totalCost) * 100).toFixed(1);
        html += `
          <tr>
            <td>${service}</td>
            <td>$${cost.toFixed(2)}</td>
            <td>${percentage}%</td>
          </tr>
        `;
      });
      
      html += '</tbody></table>';
      modalBody.innerHTML = html;
    }
    
    // Drill-down for resource type metric cards
    window.drillDownResourceType = async function(resourceType) {
      const modal = document.getElementById('detailModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      
      let title, resources = [];
      
      switch(resourceType) {
        case 'resourceGroups':
          title = 'Resource Groups Details';
          if (window.allResourceGroups?.value) {
            resources = window.allResourceGroups.value.map(rg => ({
              name: rg.name,
              location: rg.location,
              id: rg.id,
              type: 'Resource Group',
              tags: rg.tags
            }));
          }
          break;
          
        case 'virtualMachines':
          title = 'Virtual Machines Details';
          if (window.allResources?.value) {
            resources = window.allResources.value
              .filter(r => r.type.toLowerCase() === 'microsoft.compute/virtualmachines')
              .map(vm => ({
                name: vm.name,
                location: vm.location,
                id: vm.id,
                type: 'Virtual Machine',
                resourceGroup: vm.id.match(/resourceGroups\/([^\/]+)/)?.[1] || 'Unknown',
                tags: vm.tags
              }));
          }
          break;
          
        case 'storageAccounts':
          title = 'Storage Accounts Details';
          if (window.allResources?.value) {
            resources = window.allResources.value
              .filter(r => r.type.toLowerCase() === 'microsoft.storage/storageaccounts')
              .map(sa => ({
                name: sa.name,
                location: sa.location,
                id: sa.id,
                type: 'Storage Account',
                resourceGroup: sa.id.match(/resourceGroups\/([^\/]+)/)?.[1] || 'Unknown',
                kind: sa.kind,
                tags: sa.tags
              }));
          }
          break;
          
        case 'webApps':
          title = 'Web Apps Details';
          if (window.allResources?.value) {
            const staticSites = window.allResources.value
              .filter(r => r.type.toLowerCase() === 'microsoft.web/staticsites')
              .map(app => ({
                name: app.name,
                location: app.location || 'Global',
                id: app.id,
                type: 'Static Web App',
                resourceGroup: app.id.match(/resourceGroups\/([^\/]+)/)?.[1] || 'Unknown',
                tags: app.tags
              }));
            
            const functionApps = window.allResources.value
              .filter(r => r.type.toLowerCase() === 'microsoft.web/sites')
              .map(app => ({
                name: app.name,
                location: app.location,
                id: app.id,
                type: app.kind?.includes('functionapp') ? 'Function App' : 'Web App',
                resourceGroup: app.id.match(/resourceGroups\/([^\/]+)/)?.[1] || 'Unknown',
                tags: app.tags
              }));
            
            resources = [...staticSites, ...functionApps];
          }
          break;
      }
      
      modalTitle.textContent = title;
      modalBody.innerHTML = '<div class="spinner"></div>';
      modal.classList.add('active');
      
      if (resources.length === 0) {
        modalBody.innerHTML = `
          <div style="color: #94a3b8; text-align: center;">
            <p>No resources found</p>
          </div>
        `;
        return;
      }
      
      // Build the detail view
      let html = `
        <div class="detail-grid">
          <div class="detail-item">
            <div class="detail-label">Total Count</div>
            <div class="detail-value">${resources.length}</div>
          </div>
          <div class="detail-item">
            <div class="detail-label">Locations</div>
            <div class="detail-value">${[...new Set(resources.map(r => r.location))].length}</div>
          </div>
        </div>
        
        <h3 style="margin-top: 20px; color: #00d4ff;">Resources List</h3>
        <div style="max-height: 400px; overflow-y: auto; margin-top: 10px;">
          <table class="data-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Type</th>
                ${resourceType !== 'resourceGroups' ? '<th>Resource Group</th>' : ''}
                <th>Location</th>
                <th>Tags</th>
              </tr>
            </thead>
            <tbody>
      `;
      
      // Sort resources by name
      resources.sort((a, b) => a.name.localeCompare(b.name));
      
      resources.forEach(resource => {
        const tagCount = resource.tags ? Object.keys(resource.tags).length : 0;
        const escapedId = resource.id.replace(/'/g, "\\'");
        const escapedName = resource.name.replace(/'/g, "\\'");
        
        html += `
          <tr style="cursor: pointer;" onclick="window.drillDownResource('${escapedId}', '${escapedName}', 0)" title="Click for more details">
            <td style="color: #00d4ff; text-decoration: underline;">${resource.name}</td>
            <td>${resource.type}</td>
            ${resourceType !== 'resourceGroups' ? `<td>${resource.resourceGroup || '--'}</td>` : ''}
            <td>${resource.location}</td>
            <td>${tagCount > 0 ? `${tagCount} tags` : '--'}</td>
          </tr>
        `;
      });
      
      html += `
            </tbody>
          </table>
        </div>
      `;
      
      // Add location breakdown
      const locationCounts = {};
      resources.forEach(r => {
        locationCounts[r.location] = (locationCounts[r.location] || 0) + 1;
      });
      
      const sortedLocations = Object.entries(locationCounts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 10);
      
      if (sortedLocations.length > 0) {
        html += `
          <h3 style="margin-top: 20px; color: #00d4ff;">Distribution by Location</h3>
          <table class="data-table" style="margin-top: 10px;">
            <thead>
              <tr>
                <th>Location</th>
                <th>Count</th>
                <th>Percentage</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        sortedLocations.forEach(([location, count]) => {
          const percentage = ((count / resources.length) * 100).toFixed(1);
          html += `
            <tr>
              <td>${location}</td>
              <td>${count}</td>
              <td>${percentage}%</td>
            </tr>
          `;
        });
        
        html += '</tbody></table>';
      }
      
      modalBody.innerHTML = html;
    }
    
    window.closeModal = function() {
      const modal = document.getElementById('detailModal');
      modal.classList.remove('active');
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('detailModal');
      if (event.target === modal) {
        modal.classList.remove('active');
      }
    }

    // Initialize on page load
    window.addEventListener('load', async () => {
      // Load saved subscription ID
      const savedSubscription = localStorage.getItem('azure_subscription');
      if (savedSubscription) {
        document.getElementById('subscriptionId').value = savedSubscription;
      }

      // Initialize MSAL
      await initializeMSAL();
    });
  </script>
</body>
</html>
