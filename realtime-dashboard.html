<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>SAXTech Real-Time Azure Dashboard</title>
  
  <!-- MSAL.js for Azure AD Authentication -->
  <script src="https://alcdn.msauth.net/browser/2.32.2/js/msal-browser.min.js"></script>
  
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #060818 100%);
      color: #e2e8f0;
      min-height: 100vh;
    }
    
    .header {
      background: rgba(15, 23, 41, 0.9);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 212, 255, 0.2);
      padding: 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .user-section {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .user-info {
      display: none;
      align-items: center;
      gap: 15px;
    }
    
    .user-info.active {
      display: flex;
    }
    
    .user-email {
      color: #94a3b8;
      font-size: 14px;
    }
    
    .btn {
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: rgba(124, 58, 237, 0.2);
      border: 1px solid rgba(124, 58, 237, 0.5);
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    /* Auth Section */
    .auth-section {
      background: rgba(15, 23, 41, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      text-align: center;
    }
    
    .auth-section.hidden {
      display: none;
    }
    
    .auth-title {
      font-size: 20px;
      margin-bottom: 15px;
      color: #00d4ff;
    }
    
    .auth-description {
      color: #94a3b8;
      margin-bottom: 20px;
      font-size: 14px;
    }
    
    /* Status Messages */
    .status-message {
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: none;
    }
    
    .status-message.active {
      display: block;
    }
    
    .status-success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
    }
    
    .status-error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
    }
    
    .status-info {
      background: rgba(59, 130, 246, 0.1);
      border: 1px solid rgba(59, 130, 246, 0.3);
      color: #3b82f6;
    }
    
    /* Dashboard Grid */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .metric-card {
      background: rgba(15, 23, 41, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .metric-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
    }
    
    .metric-label {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #94a3b8;
      margin-bottom: 10px;
    }
    
    .metric-value {
      font-size: 32px;
      font-weight: 800;
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 5px;
    }
    
    .metric-subtitle {
      font-size: 12px;
      color: #64748b;
    }
    
    .metric-loading {
      opacity: 0.5;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.8; }
    }
    
    /* Data Table */
    .data-section {
      background: rgba(15, 23, 41, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .section-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 15px;
      color: #00d4ff;
    }
    
    .data-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .data-table th {
      text-align: left;
      padding: 10px;
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #94a3b8;
      border-bottom: 1px solid rgba(0, 212, 255, 0.2);
    }
    
    .data-table td {
      padding: 10px;
      color: #e2e8f0;
      border-bottom: 1px solid rgba(0, 212, 255, 0.1);
    }
    
    .data-table tr:hover {
      background: rgba(0, 212, 255, 0.05);
    }
    
    /* Loading Spinner */
    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid rgba(0, 212, 255, 0.3);
      border-top-color: #00d4ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Settings Panel */
    .settings-panel {
      background: rgba(15, 23, 41, 0.8);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .input-group {
      margin-bottom: 15px;
    }
    
    .input-label {
      display: block;
      font-size: 12px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 5px;
    }
    
    .input-field {
      width: 100%;
      background: rgba(6, 8, 24, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.2);
      color: #e2e8f0;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #00d4ff;
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }
    
    .code-block {
      background: rgba(6, 8, 24, 0.8);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 8px;
      padding: 15px;
      font-family: 'Courier New', monospace;
      font-size: 12px;
      color: #00d4ff;
      overflow-x: auto;
      margin: 10px 0;
    }
    
    /* Modal Styles */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.8);
      animation: fadeIn 0.3s;
    }
    
    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .modal-content {
      background: linear-gradient(135deg, #0a0e27 0%, #060818 100%);
      border: 1px solid rgba(0, 212, 255, 0.3);
      border-radius: 16px;
      padding: 30px;
      width: 90%;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      animation: slideIn 0.3s;
    }
    
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid rgba(0, 212, 255, 0.2);
    }
    
    .modal-title {
      font-size: 24px;
      font-weight: 700;
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .modal-close {
      background: none;
      border: none;
      font-size: 28px;
      color: #94a3b8;
      cursor: pointer;
      transition: color 0.2s;
    }
    
    .modal-close:hover {
      color: #00d4ff;
    }
    
    .modal-body {
      color: #e2e8f0;
    }
    
    .detail-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin: 20px 0;
    }
    
    .detail-item {
      background: rgba(15, 23, 41, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.1);
      border-radius: 8px;
      padding: 15px;
    }
    
    .detail-label {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: #94a3b8;
      margin-bottom: 5px;
    }
    
    .detail-value {
      font-size: 18px;
      font-weight: 600;
      color: #00d4ff;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideIn {
      from {
        transform: translateY(-50px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">SAXTech Real-Time Azure Dashboard</div>
      <div class="user-section">
        <button id="signInButton" class="btn" onclick="signIn()">Sign In with Azure AD</button>
        <div id="userInfo" class="user-info">
          <span class="user-email" id="userEmail">Not signed in</span>
          <button class="btn btn-secondary" onclick="refreshData()">üîÑ Refresh</button>
          <button class="btn" onclick="signOut()">Sign Out</button>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Authentication Section -->
    <div id="authSection" class="auth-section">
      <h2 class="auth-title">üîê Azure AD Authentication Required</h2>
      <p class="auth-description">
        This dashboard connects directly to Azure Management APIs for real-time data.<br>
        Please sign in with your Azure AD account to continue.
      </p>
      <button class="btn" onclick="signIn()">Sign In with Microsoft Account</button>
    </div>

    <!-- Status Messages -->
    <div id="statusMessage" class="status-message"></div>

    <!-- Main Dashboard (Hidden until authenticated) -->
    <div id="mainDashboard" style="display: none;">
      <!-- Cost Metrics -->
      <div class="dashboard-grid">
        <div class="metric-card">
          <div class="metric-label">Month-to-Date Cost</div>
          <div class="metric-value" id="mtdCost">--</div>
          <div class="metric-subtitle" id="mtdDates">Loading...</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Yesterday's Cost</div>
          <div class="metric-value" id="yesterdayCost">--</div>
          <div class="metric-subtitle" id="yesterdayDate">--</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Today's Cost (Live)</div>
          <div class="metric-value" id="todayCost">--</div>
          <div class="metric-subtitle">Real-time from Azure</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Last 7 Days</div>
          <div class="metric-value" id="weekCost">--</div>
          <div class="metric-subtitle">Weekly spending</div>
        </div>
      </div>

      <!-- Resource Counts -->
      <div class="dashboard-grid">
        <div class="metric-card">
          <div class="metric-label">Resource Groups</div>
          <div class="metric-value" id="rgCount">--</div>
          <div class="metric-subtitle">Active groups</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Virtual Machines</div>
          <div class="metric-value" id="vmCount">--</div>
          <div class="metric-subtitle" id="vmStatus">--</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Storage Accounts</div>
          <div class="metric-value" id="storageCount">--</div>
          <div class="metric-subtitle">Total accounts</div>
        </div>
        
        <div class="metric-card">
          <div class="metric-label">Web Apps</div>
          <div class="metric-value" id="webAppCount">--</div>
          <div class="metric-subtitle">Static + Function</div>
        </div>
      </div>

      <!-- Detailed Cost Breakdown -->
      <div class="data-section">
        <h3 class="section-title">Cost Breakdown by Service (Last 30 Days)</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Service</th>
              <th>Resource Count</th>
              <th>Month-to-Date</th>
              <th>Daily Average</th>
              <th>% of Total</th>
            </tr>
          </thead>
          <tbody id="costBreakdownTable">
            <tr><td colspan="5" style="text-align: center;"><div class="spinner"></div></td></tr>
          </tbody>
        </table>
      </div>

      <!-- Resources List -->
      <div class="data-section">
        <h3 class="section-title">Top 10 Resources by Cost</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Resource Name</th>
              <th>Type</th>
              <th>Resource Group</th>
              <th>Location</th>
              <th>MTD Cost</th>
            </tr>
          </thead>
          <tbody id="resourcesTable">
            <tr><td colspan="5" style="text-align: center;"><div class="spinner"></div></td></tr>
          </tbody>
        </table>
      </div>

      <!-- Settings -->
      <div class="settings-panel">
        <h3 class="section-title">Azure Configuration</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
          <div class="input-group">
            <label class="input-label">Subscription ID</label>
            <input type="text" class="input-field" id="subscriptionId" value="3cfb259a-f02a-484e-9ce3-d83c21fd0ddb">
          </div>
          <div class="input-group">
            <label class="input-label">Tenant ID</label>
            <input type="text" class="input-field" id="tenantId" value="3d659328-eef0-44f7-8481-5833e1051aec" readonly>
          </div>
        </div>
        <div style="margin-top: 15px;">
          <button class="btn btn-secondary" onclick="updateSubscription()">Update Subscription</button>
          <button class="btn btn-secondary" onclick="testConnection()">Test Connection</button>
        </div>
        
        <div class="code-block" style="margin-top: 20px;">
          <strong>API Endpoints Being Used:</strong><br>
          Cost Management: https://management.azure.com/subscriptions/{subscriptionId}/providers/Microsoft.CostManagement/query<br>
          Resources: https://management.azure.com/subscriptions/{subscriptionId}/resources<br>
          Resource Groups: https://management.azure.com/subscriptions/{subscriptionId}/resourcegroups
        </div>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div id="detailModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title" id="modalTitle">Details</h2>
        <button class="modal-close" onclick="closeModal()">&times;</button>
      </div>
      <div class="modal-body" id="modalBody">
        <!-- Content will be dynamically inserted here -->
      </div>
    </div>
  </div>

  <script>
    // MSAL Configuration
    const msalConfig = {
      auth: {
        clientId: 'c1a20824-c427-46f0-a819-53d657d6ea7f', // SAXTech Real-Time Dashboard App
        authority: 'https://login.microsoftonline.com/3d659328-eef0-44f7-8481-5833e1051aec',
        redirectUri: window.location.origin + '/realtime-dashboard.html'
      },
      cache: {
        cacheLocation: 'localStorage',
        storeAuthStateInCookie: false
      }
    };

    // MSAL Instance
    const msalInstance = new msal.PublicClientApplication(msalConfig);

    // Azure Management API Scopes
    const loginRequest = {
      scopes: ['https://management.azure.com/user_impersonation']
    };

    const tokenRequest = {
      scopes: ['https://management.azure.com/.default'],
      forceRefresh: false
    };

    let currentAccount = null;

    // Initialize MSAL
    async function initializeMSAL() {
      try {
        // Handle redirect response
        const response = await msalInstance.handleRedirectPromise();
        if (response) {
          currentAccount = response.account;
          showMessage('Successfully signed in!', 'success');
          await onSignIn();
        }

        // Check if user is already signed in
        const accounts = msalInstance.getAllAccounts();
        if (accounts.length > 0) {
          currentAccount = accounts[0];
          await onSignIn();
        }
      } catch (error) {
        console.error('MSAL initialization error:', error);
        showMessage('Authentication error: ' + error.message, 'error');
      }
    }

    // Sign In
    async function signIn() {
      try {
        showMessage('Redirecting to Microsoft login...', 'info');
        await msalInstance.loginRedirect(loginRequest);
      } catch (error) {
        console.error('Login error:', error);
        showMessage('Login failed: ' + error.message, 'error');
      }
    }

    // Sign Out
    function signOut() {
      msalInstance.logoutRedirect({
        account: currentAccount
      });
    }

    // Handle successful sign in
    async function onSignIn() {
      if (!currentAccount) return;

      // Update UI
      document.getElementById('authSection').classList.add('hidden');
      document.getElementById('signInButton').style.display = 'none';
      document.getElementById('userInfo').classList.add('active');
      document.getElementById('userEmail').textContent = currentAccount.username || currentAccount.name;
      document.getElementById('mainDashboard').style.display = 'block';

      // Load data
      await refreshData();
    }

    // Get Access Token
    async function getAccessToken() {
      try {
        const response = await msalInstance.acquireTokenSilent({
          ...tokenRequest,
          account: currentAccount
        });
        return response.accessToken;
      } catch (error) {
        console.error('Token acquisition failed, attempting interactive:', error);
        const response = await msalInstance.acquireTokenRedirect(tokenRequest);
        return response.accessToken;
      }
    }

    // Rate limiting configuration
    const rateLimitConfig = {
      costApiDelay: 5000, // 5 seconds between Cost API calls (increased from 2s)
      maxRetries: 3,
      retryDelay: 10000 // 10 seconds between retries (increased from 5s)
    };
    
    let lastCostApiCall = 0;
    
    // Sleep function for delays
    function sleep(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    // Azure API Helper with retry logic
    async function callAzureAPI(endpoint, options = {}, retryCount = 0) {
      try {
        // Rate limiting for Cost Management API
        if (endpoint.includes('/providers/Microsoft.CostManagement/')) {
          const now = Date.now();
          const timeSinceLastCall = now - lastCostApiCall;
          if (timeSinceLastCall < rateLimitConfig.costApiDelay) {
            await sleep(rateLimitConfig.costApiDelay - timeSinceLastCall);
          }
          lastCostApiCall = Date.now();
        }
        
        const token = await getAccessToken();
        const response = await fetch(`https://management.azure.com${endpoint}`, {
          ...options,
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            ...options.headers
          }
        });

        if (!response.ok) {
          // Handle rate limiting (429)
          if (response.status === 429 && retryCount < rateLimitConfig.maxRetries) {
            console.log(`Rate limited. Retrying in ${rateLimitConfig.retryDelay}ms... (Attempt ${retryCount + 1}/${rateLimitConfig.maxRetries})`);
            await sleep(rateLimitConfig.retryDelay);
            return callAzureAPI(endpoint, options, retryCount + 1);
          }
          
          // Try to get error details from response
          let errorMessage = `${response.status} ${response.statusText}`;
          try {
            const errorData = await response.json();
            if (errorData.error) {
              errorMessage = errorData.error.message || errorData.error.code || errorMessage;
            }
            console.error('API Error Details:', errorData);
          } catch (e) {
            // Response wasn't JSON
          }
          throw new Error(`API Error: ${errorMessage}`);
        }

        return await response.json();
      } catch (error) {
        console.error('Azure API call failed:', error);
        throw error;
      }
    }

    // Get Cost Data
    async function getCostData(timeframe = 'MonthToDate') {
      const subscriptionId = document.getElementById('subscriptionId').value;
      const endpoint = `/subscriptions/${subscriptionId}/providers/Microsoft.CostManagement/query?api-version=2023-03-01`;
      
      const body = {
        type: 'ActualCost',
        dataSet: {
          granularity: 'Daily',
          aggregation: {
            totalCost: {
              name: 'Cost',
              function: 'Sum'
            },
            totalCostUSD: {
              name: 'CostUSD',
              function: 'Sum'
            }
          },
          grouping: [
            {
              type: 'Dimension',
              name: 'ServiceName'
            }
          ]
        },
        timeframe: timeframe
      };

      return await callAzureAPI(endpoint, {
        method: 'POST',
        body: JSON.stringify(body)
      });
    }

    // Get Custom Date Range Cost
    async function getCostForDateRange(startDate, endDate) {
      const subscriptionId = document.getElementById('subscriptionId').value;
      const endpoint = `/subscriptions/${subscriptionId}/providers/Microsoft.CostManagement/query?api-version=2023-03-01`;
      
      const body = {
        type: 'ActualCost',
        dataSet: {
          granularity: 'Daily',
          aggregation: {
            totalCost: {
              name: 'Cost',
              function: 'Sum'
            },
            totalCostUSD: {
              name: 'CostUSD',
              function: 'Sum'
            }
          }
        },
        timeframe: 'Custom',
        timePeriod: {
          from: startDate + 'T00:00:00Z',
          to: endDate + 'T23:59:59Z'
        }
      };

      return await callAzureAPI(endpoint, {
        method: 'POST',
        body: JSON.stringify(body)
      });
    }

    // Get Resources
    async function getResources() {
      const subscriptionId = document.getElementById('subscriptionId').value;
      return await callAzureAPI(`/subscriptions/${subscriptionId}/resources?api-version=2021-04-01`);
    }

    // Get Resource Groups
    async function getResourceGroups() {
      const subscriptionId = document.getElementById('subscriptionId').value;
      return await callAzureAPI(`/subscriptions/${subscriptionId}/resourcegroups?api-version=2021-04-01`);
    }

    // Refresh All Data
    async function refreshData() {
      if (!currentAccount) {
        showMessage('Please sign in first', 'error');
        return;
      }

      showMessage('Loading real-time data from Azure...', 'info');
      
      try {
        // Get resources first (these usually work)
        const [resources, resourceGroups] = await Promise.all([
          getResources(),
          getResourceGroups()
        ]);
        
        // Update resource counts immediately
        updateResourceCounts(resources, resourceGroups);
        
        // Then try to get cost data sequentially (to avoid rate limiting)
        let mtdData, weekData, yesterdayData, todayData;
        try {
          showMessage('Loading cost data (this may take a moment due to API rate limits)...', 'info');
          
          // Get MTD data first
          mtdData = await getCostData('MonthToDate');
          
          // Longer delay to avoid rate limiting
          await sleep(3000);
          
          // Get weekly data
          weekData = await getCostData('TheLastWeek');
          
          // Longer delay to avoid rate limiting
          await sleep(3000);
          
          // Get yesterday's data
          yesterdayData = await getCostForDateRange(getYesterdayDate(), getYesterdayDate());
          
          // Longer delay to avoid rate limiting
          await sleep(3000);
          
          // Get today's data
          todayData = await getCostForDateRange(getTodayDate(), getTodayDate());
          
          // Update cost cards with available data
          if (mtdData || weekData || yesterdayData || todayData) {
            updateCostCards(mtdData, yesterdayData, todayData, weekData);
            updateCostBreakdown(mtdData);
            showMessage('Cost data loaded successfully!', 'success');
          }
        } catch (costError) {
          console.error('Cost API error (this may be due to permissions):', costError);
          showMessage('Note: Cost data requires Cost Management Reader role', 'error');
          // Set default values for cost displays
          document.getElementById('mtdCost').textContent = 'N/A';
          document.getElementById('yesterdayCost').textContent = 'N/A';
          document.getElementById('todayCost').textContent = 'N/A';
          document.getElementById('weekCost').textContent = 'N/A';
          document.getElementById('costBreakdownTable').innerHTML = '<tr><td colspan="5" style="text-align: center;">Cost data requires Cost Management Reader role</td></tr>';
        }
        
        // Update resources table
        updateResourcesTable(resources);

        showMessage('Data refreshed successfully!', 'success');
        
      } catch (error) {
        console.error('Data refresh error:', error);
        showMessage('Error loading data: ' + error.message, 'error');
      }
    }

    // Update Cost Cards
    function updateCostCards(mtdData, yesterdayData, todayData, weekData) {
      // MTD Cost
      if (mtdData?.properties?.rows) {
        const total = mtdData.properties.rows.reduce((sum, row) => sum + (row[1] || 0), 0);
        document.getElementById('mtdCost').textContent = `$${total.toFixed(2)}`;
        
        const startDate = new Date();
        startDate.setDate(1);
        document.getElementById('mtdDates').textContent = 
          `${startDate.toLocaleDateString()} - ${new Date().toLocaleDateString()}`;
      }

      // Yesterday's Cost
      if (yesterdayData?.properties?.rows) {
        const total = yesterdayData.properties.rows.reduce((sum, row) => sum + (row[0] || 0), 0);
        document.getElementById('yesterdayCost').textContent = `$${total.toFixed(2)}`;
        document.getElementById('yesterdayDate').textContent = new Date(getYesterdayDate()).toLocaleDateString();
      }

      // Today's Cost
      if (todayData?.properties?.rows) {
        const total = todayData.properties.rows.reduce((sum, row) => sum + (row[0] || 0), 0);
        document.getElementById('todayCost').textContent = `$${total.toFixed(2)}`;
      }

      // Weekly Cost
      if (weekData?.properties?.rows) {
        const total = weekData.properties.rows.reduce((sum, row) => sum + (row[1] || 0), 0);
        document.getElementById('weekCost').textContent = `$${total.toFixed(2)}`;
      }
    }

    // Update Resource Counts
    function updateResourceCounts(resources, resourceGroups) {
      // Resource Groups
      document.getElementById('rgCount').textContent = resourceGroups?.value?.length || 0;

      // Parse resources by type
      if (resources?.value) {
        const resourcesByType = {};
        resources.value.forEach(resource => {
          const type = resource.type.toLowerCase();
          resourcesByType[type] = (resourcesByType[type] || 0) + 1;
        });

        // VMs
        const vmCount = resourcesByType['microsoft.compute/virtualmachines'] || 0;
        document.getElementById('vmCount').textContent = vmCount;
        document.getElementById('vmStatus').textContent = `${vmCount} total VMs`;

        // Storage
        const storageCount = resourcesByType['microsoft.storage/storageaccounts'] || 0;
        document.getElementById('storageCount').textContent = storageCount;

        // Web Apps
        const staticSites = resourcesByType['microsoft.web/staticsites'] || 0;
        const functionApps = resourcesByType['microsoft.web/sites'] || 0;
        document.getElementById('webAppCount').textContent = staticSites + functionApps;
      }
    }

    // Service name mapping
    const serviceNameMap = {
      '1': 'Virtual Machines',
      '2': 'Storage',
      '3': 'Bandwidth',
      '4': 'Virtual Network',
      '5': 'Azure App Service',
      '6': 'Azure SQL Database',
      '7': 'Key Vault',
      '8': 'Load Balancer',
      '9': 'Azure DNS',
      '10': 'Azure Monitor',
      '11': 'Azure Active Directory',
      '12': 'Container Registry',
      '13': 'Azure Functions',
      '14': 'Azure Kubernetes Service',
      '15': 'Azure Backup',
      '16': 'Logic Apps',
      '17': 'Azure Cognitive Services',
      '18': 'Azure DevOps',
      '19': 'Azure Data Factory',
      '20': 'Static Web Apps',
      'microsoft.compute': 'Compute',
      'microsoft.storage': 'Storage',
      'microsoft.network': 'Networking',
      'microsoft.web': 'Web Apps',
      'microsoft.sql': 'SQL Database',
      'microsoft.keyvault': 'Key Vault',
      'microsoft.insights': 'Azure Monitor',
      'microsoft.containerregistry': 'Container Registry',
      'microsoft.kubernetes': 'Kubernetes Service'
    };
    
    // Update Cost Breakdown Table
    function updateCostBreakdown(costData) {
      const table = document.getElementById('costBreakdownTable');
      
      if (!costData?.properties?.rows || costData.properties.rows.length === 0) {
        table.innerHTML = '<tr><td colspan="5" style="text-align: center;">No cost data available</td></tr>';
        return;
      }

      // Aggregate by service
      const serviceData = {};
      let totalCost = 0;
      
      costData.properties.rows.forEach(row => {
        let service = row[0] || 'Unknown';
        const cost = row[1] || 0;
        
        // Map numeric or short service names to readable names
        const serviceLower = service.toLowerCase();
        if (serviceNameMap[service]) {
          service = serviceNameMap[service];
        } else if (serviceNameMap[serviceLower]) {
          service = serviceNameMap[serviceLower];
        } else {
          // Try to make the service name more readable
          service = service.replace(/microsoft\./gi, '')
                          .replace(/[_-]/g, ' ')
                          .split(' ')
                          .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                          .join(' ');
        }
        
        if (!serviceData[service]) {
          serviceData[service] = { cost: 0, count: 0, originalName: row[0] };
        }
        serviceData[service].cost += cost;
        serviceData[service].count++;
        totalCost += cost;
      });

      // Sort by cost
      const sortedServices = Object.entries(serviceData)
        .sort((a, b) => b[1].cost - a[1].cost)
        .slice(0, 10);

      // Generate table rows with drill-down capability
      table.innerHTML = sortedServices.map(([service, data]) => {
        const percentage = ((data.cost / totalCost) * 100).toFixed(1);
        const dailyAvg = (data.cost / new Date().getDate()).toFixed(2);
        
        return `
          <tr style="cursor: pointer;" onclick="drillDownService('${data.originalName}', '${service}', ${data.cost})" title="Click to see details">
            <td style="color: #00d4ff; text-decoration: underline;">${service}</td>
            <td>${data.count}</td>
            <td>$${data.cost.toFixed(2)}</td>
            <td>$${dailyAvg}</td>
            <td>${percentage}%</td>
          </tr>
        `;
      }).join('');
    }

    // Update Resources Table
    async function updateResourcesTable(resources, costData) {
      const table = document.getElementById('resourcesTable');
      
      if (!resources?.value || resources.value.length === 0) {
        table.innerHTML = '<tr><td colspan="5" style="text-align: center;">No resources found</td></tr>';
        return;
      }

      // Extract resource group from ID
      const getResourceGroup = (id) => {
        const match = id.match(/resourceGroups\/([^\/]+)/);
        return match ? match[1] : '--';
      };
      
      // Get resource costs if available
      const resourceCosts = {};
      if (costData) {
        try {
          const subscriptionId = document.getElementById('subscriptionId').value;
          const endpoint = `/subscriptions/${subscriptionId}/providers/Microsoft.CostManagement/query?api-version=2023-03-01`;
          
          const body = {
            type: 'ActualCost',
            dataSet: {
              granularity: 'None',
              aggregation: {
                totalCost: {
                  name: 'Cost',
                  function: 'Sum'
                },
                totalCostUSD: {
                  name: 'CostUSD',
                  function: 'Sum'
                }
              },
              grouping: [
                {
                  type: 'Dimension',
                  name: 'ResourceId'
                }
              ]
            },
            timeframe: 'MonthToDate'
          };

          const resourceCostData = await callAzureAPI(endpoint, {
            method: 'POST',
            body: JSON.stringify(body)
          });
          
          if (resourceCostData?.properties?.rows) {
            resourceCostData.properties.rows.forEach(row => {
              const resourceId = row[0];
              const cost = row[1] || 0;
              if (resourceId) {
                const resourceName = resourceId.split('/').pop();
                resourceCosts[resourceName] = cost;
              }
            });
          }
        } catch (error) {
          console.log('Could not fetch resource-level costs:', error);
        }
      }

      // Sort resources by cost (if available) or alphabetically
      const sortedResources = resources.value
        .map(resource => ({
          ...resource,
          cost: resourceCosts[resource.name] || 0,
          resourceGroup: getResourceGroup(resource.id)
        }))
        .sort((a, b) => b.cost - a.cost)
        .slice(0, 10);
      
      table.innerHTML = sortedResources.map(resource => `
        <tr style="cursor: pointer;" onclick="drillDownResource('${resource.id}', '${resource.name}', ${resource.cost})" title="Click to see details">
          <td style="color: #00d4ff; text-decoration: underline;">${resource.name}</td>
          <td>${resource.type.split('/').pop()}</td>
          <td>${resource.resourceGroup}</td>
          <td>${resource.location}</td>
          <td>${resource.cost > 0 ? `$${resource.cost.toFixed(2)}` : '--'}</td>
        </tr>
      `).join('');
    }

    // Helper Functions
    function getTodayDate() {
      return new Date().toISOString().split('T')[0];
    }

    function getYesterdayDate() {
      const date = new Date();
      date.setDate(date.getDate() - 1);
      return date.toISOString().split('T')[0];
    }

    function showMessage(message, type = 'info') {
      const messageEl = document.getElementById('statusMessage');
      messageEl.textContent = message;
      messageEl.className = `status-message active status-${type}`;
      
      if (type !== 'error') {
        setTimeout(() => {
          messageEl.classList.remove('active');
        }, 5000);
      }
    }

    // Update Subscription
    function updateSubscription() {
      const newSubscriptionId = document.getElementById('subscriptionId').value;
      if (newSubscriptionId) {
        localStorage.setItem('azure_subscription', newSubscriptionId);
        refreshData();
      }
    }

    // Test Connection
    async function testConnection() {
      try {
        showMessage('Testing Azure connection...', 'info');
        const groups = await getResourceGroups();
        showMessage(`Connection successful! Found ${groups.value.length} resource groups.`, 'success');
      } catch (error) {
        showMessage('Connection failed: ' + error.message, 'error');
      }
    }

    // Drill-down Functions (make them global so onclick can access them)
    window.drillDownService = async function(serviceId, serviceName, cost) {
      const modal = document.getElementById('detailModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      
      modalTitle.textContent = `Service Details: ${serviceName}`;
      modalBody.innerHTML = '<div class="spinner"></div>';
      modal.classList.add('active');
      
      try {
        // Get detailed cost breakdown for this service
        const subscriptionId = document.getElementById('subscriptionId').value;
        const endpoint = `/subscriptions/${subscriptionId}/providers/Microsoft.CostManagement/query?api-version=2023-03-01`;
        
        const body = {
          type: 'ActualCost',
          dataSet: {
            granularity: 'Daily',
            aggregation: {
              totalCost: {
                name: 'Cost',
                function: 'Sum'
              }
            },
            grouping: [
              {
                type: 'Dimension',
                name: 'ResourceGroup'
              }
            ],
            filter: {
              dimensions: {
                name: 'ServiceName',
                operator: 'In',
                values: [serviceId]
              }
            }
          },
          timeframe: 'MonthToDate'
        };
        
        const detailData = await callAzureAPI(endpoint, {
          method: 'POST',
          body: JSON.stringify(body)
        });
        
        // Build detail view
        let html = `
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Service Name</div>
              <div class="detail-value">${serviceName}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Month-to-Date Cost</div>
              <div class="detail-value">$${cost.toFixed(2)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Daily Average</div>
              <div class="detail-value">$${(cost / new Date().getDate()).toFixed(2)}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Projected Monthly</div>
              <div class="detail-value">$${(cost / new Date().getDate() * 30).toFixed(2)}</div>
            </div>
          </div>
        `;
        
        if (detailData?.properties?.rows && detailData.properties.rows.length > 0) {
          html += `
            <h3 style="margin-top: 20px; color: #00d4ff;">Cost by Resource Group</h3>
            <table class="data-table" style="margin-top: 10px;">
              <thead>
                <tr>
                  <th>Resource Group</th>
                  <th>Cost</th>
                  <th>% of Service</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          const sortedGroups = detailData.properties.rows
            .sort((a, b) => (b[1] || 0) - (a[1] || 0))
            .slice(0, 10);
          
          sortedGroups.forEach(row => {
            const rgName = row[0] || 'Unknown';
            const rgCost = row[1] || 0;
            const percentage = ((rgCost / cost) * 100).toFixed(1);
            
            html += `
              <tr>
                <td>${rgName}</td>
                <td>$${rgCost.toFixed(2)}</td>
                <td>${percentage}%</td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
        }
        
        modalBody.innerHTML = html;
        
      } catch (error) {
        modalBody.innerHTML = `
          <div style="color: #ef4444; text-align: center;">
            <p>Error loading details: ${error.message}</p>
          </div>
        `;
      }
    }
    
    window.drillDownResource = async function(resourceId, resourceName, cost) {
      const modal = document.getElementById('detailModal');
      const modalTitle = document.getElementById('modalTitle');
      const modalBody = document.getElementById('modalBody');
      
      modalTitle.textContent = `Resource Details: ${resourceName}`;
      modalBody.innerHTML = '<div class="spinner"></div>';
      modal.classList.add('active');
      
      try {
        // Get resource details
        const subscriptionId = document.getElementById('subscriptionId').value;
        const resourceEndpoint = `${resourceId}?api-version=2021-04-01`;
        const resourceData = await callAzureAPI(resourceEndpoint);
        
        // Extract resource group from ID
        const rgMatch = resourceId.match(/resourceGroups\/([^\/]+)/);
        const resourceGroup = rgMatch ? rgMatch[1] : 'Unknown';
        
        // Build detail view
        let html = `
          <div class="detail-grid">
            <div class="detail-item">
              <div class="detail-label">Resource Name</div>
              <div class="detail-value">${resourceName}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Resource Type</div>
              <div class="detail-value">${resourceData.type || 'Unknown'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Resource Group</div>
              <div class="detail-value">${resourceGroup}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Location</div>
              <div class="detail-value">${resourceData.location || 'Unknown'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Month-to-Date Cost</div>
              <div class="detail-value">${cost > 0 ? `$${cost.toFixed(2)}` : 'N/A'}</div>
            </div>
            <div class="detail-item">
              <div class="detail-label">Status</div>
              <div class="detail-value" style="color: #10b981;">Active</div>
            </div>
          </div>
        `;
        
        // Add tags if present
        if (resourceData.tags && Object.keys(resourceData.tags).length > 0) {
          html += `
            <h3 style="margin-top: 20px; color: #00d4ff;">Resource Tags</h3>
            <table class="data-table" style="margin-top: 10px;">
              <thead>
                <tr>
                  <th>Tag Name</th>
                  <th>Value</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          Object.entries(resourceData.tags).forEach(([key, value]) => {
            html += `
              <tr>
                <td>${key}</td>
                <td>${value}</td>
              </tr>
            `;
          });
          
          html += '</tbody></table>';
        }
        
        // Add properties if present
        if (resourceData.properties) {
          html += `
            <h3 style="margin-top: 20px; color: #00d4ff;">Additional Information</h3>
            <div class="code-block" style="margin-top: 10px; max-height: 300px; overflow-y: auto;">
              ${JSON.stringify(resourceData.properties, null, 2)}
            </div>
          `;
        }
        
        modalBody.innerHTML = html;
        
      } catch (error) {
        modalBody.innerHTML = `
          <div style="color: #ef4444; text-align: center;">
            <p>Error loading details: ${error.message}</p>
          </div>
        `;
      }
    }
    
    window.closeModal = function() {
      const modal = document.getElementById('detailModal');
      modal.classList.remove('active');
    }
    
    // Close modal when clicking outside
    window.onclick = function(event) {
      const modal = document.getElementById('detailModal');
      if (event.target === modal) {
        modal.classList.remove('active');
      }
    }

    // Initialize on page load
    window.addEventListener('load', async () => {
      // Load saved subscription ID
      const savedSubscription = localStorage.getItem('azure_subscription');
      if (savedSubscription) {
        document.getElementById('subscriptionId').value = savedSubscription;
      }

      // Initialize MSAL
      await initializeMSAL();
    });
  </script>
</body>
</html>
