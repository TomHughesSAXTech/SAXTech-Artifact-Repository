<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <title>SAXTech Admin Dashboard - Live Azure Data</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #0a0e27 0%, #060818 100%);
      color: #e2e8f0;
      min-height: 100vh;
    }
    
    /* Header */
    .header {
      background: rgba(15, 23, 41, 0.8);
      backdrop-filter: blur(10px);
      border-bottom: 1px solid rgba(0, 212, 255, 0.2);
      padding: 20px;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .logo {
      font-size: 24px;
      font-weight: 800;
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 20px;
    }
    
    .user-email {
      color: #94a3b8;
      font-size: 14px;
    }
    
    .btn {
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: transform 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-2px);
    }
    
    .btn-secondary {
      background: rgba(124, 58, 237, 0.2);
      border: 1px solid rgba(124, 58, 237, 0.5);
    }
    
    /* Main Container */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    /* Status Bar */
    .status-bar {
      background: rgba(15, 23, 41, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 15px 20px;
      margin-bottom: 30px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .status-text {
      color: #10b981;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .status-indicator {
      width: 8px;
      height: 8px;
      background: #10b981;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    /* Grid Layout */
    .dashboard-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    /* Cards */
    .card {
      background: rgba(15, 23, 41, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 30px rgba(0, 212, 255, 0.2);
    }
    
    .card-title {
      font-size: 12px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #94a3b8;
      margin-bottom: 10px;
    }
    
    .card-value {
      font-size: 32px;
      font-weight: 800;
      background: linear-gradient(135deg, #00d4ff 0%, #7c3aed 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 5px;
    }
    
    .card-subtitle {
      font-size: 12px;
      color: #64748b;
    }
    
    .card-loading {
      opacity: 0.5;
      animation: shimmer 2s infinite;
    }
    
    @keyframes shimmer {
      0%, 100% { opacity: 0.5; }
      50% { opacity: 0.8; }
    }
    
    /* Large Cards */
    .card-large {
      grid-column: span 2;
    }
    
    .card-full {
      grid-column: 1 / -1;
    }
    
    /* Tables */
    .data-table {
      width: 100%;
      margin-top: 15px;
    }
    
    .data-table th,
    .data-table td {
      text-align: left;
      padding: 10px;
      border-bottom: 1px solid rgba(0, 212, 255, 0.1);
    }
    
    .data-table th {
      font-size: 11px;
      text-transform: uppercase;
      letter-spacing: 1px;
      color: #94a3b8;
    }
    
    .data-table td {
      font-size: 14px;
      color: #e2e8f0;
    }
    
    .data-table tr:hover {
      background: rgba(0, 212, 255, 0.05);
    }
    
    /* Cost Badges */
    .cost-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
    }
    
    .cost-low { background: rgba(16, 185, 129, 0.2); color: #10b981; }
    .cost-medium { background: rgba(245, 158, 11, 0.2); color: #f59e0b; }
    .cost-high { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    
    /* Tabs */
    .tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 1px solid rgba(0, 212, 255, 0.2);
    }
    
    .tab {
      padding: 12px 20px;
      background: none;
      border: none;
      color: #94a3b8;
      cursor: pointer;
      font-weight: 500;
      position: relative;
      transition: color 0.2s;
    }
    
    .tab:hover {
      color: #e2e8f0;
    }
    
    .tab.active {
      color: #00d4ff;
    }
    
    .tab.active::after {
      content: '';
      position: absolute;
      bottom: -1px;
      left: 0;
      right: 0;
      height: 2px;
      background: linear-gradient(90deg, #00d4ff, #7c3aed);
    }
    
    .tab-content {
      display: none;
    }
    
    .tab-content.active {
      display: block;
    }
    
    /* Loading Spinner */
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(0, 212, 255, 0.3);
      border-top-color: #00d4ff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Error State */
    .error {
      background: rgba(239, 68, 68, 0.1);
      border: 1px solid rgba(239, 68, 68, 0.3);
      color: #ef4444;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    /* Success State */
    .success {
      background: rgba(16, 185, 129, 0.1);
      border: 1px solid rgba(16, 185, 129, 0.3);
      color: #10b981;
      padding: 15px;
      border-radius: 8px;
      margin: 10px 0;
    }
    
    /* Settings Panel */
    .settings-panel {
      background: rgba(15, 23, 41, 0.8);
      border: 1px solid rgba(0, 212, 255, 0.2);
      border-radius: 12px;
      padding: 20px;
      margin-top: 30px;
    }
    
    .settings-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }
    
    .input-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    .input-label {
      font-size: 12px;
      color: #94a3b8;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .input-field {
      background: rgba(6, 8, 24, 0.6);
      border: 1px solid rgba(0, 212, 255, 0.2);
      color: #e2e8f0;
      padding: 10px;
      border-radius: 6px;
      font-size: 14px;
    }
    
    .input-field:focus {
      outline: none;
      border-color: #00d4ff;
      box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-content">
      <div class="logo">SAXTech Admin Dashboard</div>
      <div class="user-info">
        <span class="user-email" id="userEmail">Loading...</span>
        <button class="btn btn-secondary" onclick="refreshAll()">🔄 Refresh</button>
        <button class="btn" onclick="logout()">Logout</button>
      </div>
    </div>
  </header>

  <div class="container">
    <!-- Status Bar -->
    <div class="status-bar">
      <div class="status-text">
        <span class="status-indicator"></span>
        <span id="statusText">Connecting to Azure...</span>
      </div>
      <div class="status-text">
        Last Updated: <span id="lastUpdated">--</span>
      </div>
    </div>

    <!-- Main Dashboard Tabs -->
    <div class="tabs">
      <button class="tab active" onclick="switchTab('overview')">Overview</button>
      <button class="tab" onclick="switchTab('costs')">Cost Analysis</button>
      <button class="tab" onclick="switchTab('resources')">Resources</button>
      <button class="tab" onclick="switchTab('projects')">Projects</button>
      <button class="tab" onclick="switchTab('settings')">Settings</button>
    </div>

    <!-- Overview Tab -->
    <div id="overview" class="tab-content active">
      <div class="dashboard-grid">
        <!-- Cost Cards -->
        <div class="card">
          <div class="card-title">Month-to-Date Cost</div>
          <div class="card-value" id="mtdCost">--</div>
          <div class="card-subtitle" id="mtdPeriod">Loading...</div>
        </div>
        
        <div class="card">
          <div class="card-title">Yesterday's Cost</div>
          <div class="card-value" id="yesterdayCost">--</div>
          <div class="card-subtitle">24-hour period</div>
        </div>
        
        <div class="card">
          <div class="card-title">Today's Cost (Live)</div>
          <div class="card-value" id="todayCost">--</div>
          <div class="card-subtitle" id="todayHours">--</div>
        </div>
        
        <div class="card">
          <div class="card-title">Projected Monthly</div>
          <div class="card-value" id="projectedCost">--</div>
          <div class="card-subtitle">Based on current usage</div>
        </div>
        
        <!-- Resource Counts -->
        <div class="card">
          <div class="card-title">Resource Groups</div>
          <div class="card-value" id="rgCount">--</div>
          <div class="card-subtitle">Active groups</div>
        </div>
        
        <div class="card">
          <div class="card-title">Virtual Machines</div>
          <div class="card-value" id="vmCount">--</div>
          <div class="card-subtitle" id="vmRunning">--</div>
        </div>
        
        <div class="card">
          <div class="card-title">Storage Accounts</div>
          <div class="card-value" id="storageCount">--</div>
          <div class="card-subtitle" id="storageSize">--</div>
        </div>
        
        <div class="card">
          <div class="card-title">Web Apps</div>
          <div class="card-value" id="webAppCount">--</div>
          <div class="card-subtitle">Static + Function Apps</div>
        </div>
      </div>
      
      <!-- Quick Stats Table -->
      <div class="card card-full">
        <h3 style="margin-bottom: 15px;">Top Resources by Cost</h3>
        <table class="data-table">
          <thead>
            <tr>
              <th>Resource</th>
              <th>Type</th>
              <th>Resource Group</th>
              <th>Daily Cost</th>
              <th>MTD Cost</th>
            </tr>
          </thead>
          <tbody id="topResourcesTable">
            <tr><td colspan="5" style="text-align: center;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Cost Analysis Tab -->
    <div id="costs" class="tab-content">
      <div class="dashboard-grid">
        <div class="card card-large">
          <h3>Cost Breakdown by Service</h3>
          <div id="costByService" style="margin-top: 15px;">
            <div class="spinner"></div> Loading cost data...
          </div>
        </div>
        
        <div class="card">
          <h3>Budget Status</h3>
          <div id="budgetStatus" style="margin-top: 15px;">
            <div class="spinner"></div> Loading...
          </div>
        </div>
      </div>
      
      <div class="card card-full">
        <h3>Daily Cost Trend (Last 30 Days)</h3>
        <canvas id="costTrendChart" height="80"></canvas>
      </div>
    </div>

    <!-- Resources Tab -->
    <div id="resources" class="tab-content">
      <div class="card card-full">
        <h3>All Azure Resources</h3>
        <div style="margin: 15px 0;">
          <input type="text" class="input-field" placeholder="🔍 Search resources..." id="resourceSearch" onkeyup="filterResources()" style="width: 300px;">
        </div>
        <table class="data-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Type</th>
              <th>Resource Group</th>
              <th>Location</th>
              <th>Status</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="resourcesTable">
            <tr><td colspan="6" style="text-align: center;">Loading...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Projects Tab -->
    <div id="projects" class="tab-content">
      <div style="margin-bottom: 20px;">
        <button class="btn" onclick="openProjectModal()">+ New Project</button>
      </div>
      <div class="dashboard-grid" id="projectsGrid">
        <!-- Projects will be loaded here -->
      </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings" class="tab-content">
      <div class="settings-panel">
        <h3>Azure Configuration</h3>
        <div class="settings-grid">
          <div class="input-group">
            <label class="input-label">Subscription ID</label>
            <input type="text" class="input-field" id="subscriptionId" value="3cfb259a-f02a-484e-9ce3-d83c21fd0ddb">
          </div>
          <div class="input-group">
            <label class="input-label">Tenant ID</label>
            <input type="text" class="input-field" id="tenantId" value="3d659328-eef0-44f7-8481-5833e1051aec">
          </div>
          <div class="input-group">
            <label class="input-label">API Refresh Rate (seconds)</label>
            <input type="number" class="input-field" id="refreshRate" value="300" min="30">
          </div>
          <div class="input-group">
            <label class="input-label">Cost Alert Threshold ($)</label>
            <input type="number" class="input-field" id="costThreshold" value="500">
          </div>
        </div>
        <div style="margin-top: 20px;">
          <button class="btn" onclick="saveSettings()">Save Settings</button>
          <button class="btn btn-secondary" onclick="testAzureConnection()">Test Connection</button>
        </div>
      </div>
      
      <div class="settings-panel">
        <h3>API Endpoints</h3>
        <div id="apiEndpoints" style="margin-top: 15px; font-family: monospace; font-size: 12px;">
          <!-- Will be populated with actual endpoints -->
        </div>
      </div>
    </div>
  </div>

  <script>
    // Azure REST API Integration
    class AzureAPI {
      constructor() {
        this.subscriptionId = localStorage.getItem('azure_subscription') || '3cfb259a-f02a-484e-9ce3-d83c21fd0ddb';
        this.tenantId = localStorage.getItem('azure_tenant') || '3d659328-eef0-44f7-8481-5833e1051aec';
        this.apiVersion = '2023-01-01';
        this.token = null;
        this.tokenExpiry = null;
      }
      
      async getToken() {
        // Check if we have a valid token
        if (this.token && this.tokenExpiry && new Date() < this.tokenExpiry) {
          return this.token;
        }
        
        // In production, this would use MSAL.js or Azure AD auth
        // For now, we'll use the static web app's built-in auth
        try {
          const response = await fetch('/.auth/refresh');
          if (response.ok) {
            const authData = await this.getUserInfo();
            // This is a placeholder - in reality, you'd exchange this for an Azure Management API token
            this.token = 'placeholder_token';
            this.tokenExpiry = new Date(Date.now() + 3600000); // 1 hour
            return this.token;
          }
        } catch (error) {
          console.error('Auth error:', error);
        }
        return null;
      }
      
      async getUserInfo() {
        try {
          const response = await fetch('/.auth/me');
          const data = await response.json();
          return data;
        } catch (error) {
          console.error('Error getting user info:', error);
          return null;
        }
      }
      
      async callAzureAPI(endpoint, options = {}) {
        const token = await this.getToken();
        if (!token) {
          throw new Error('Authentication required');
        }
        
        const url = `https://management.azure.com${endpoint}`;
        const response = await fetch(url, {
          ...options,
          headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json',
            ...options.headers
          }
        });
        
        if (!response.ok) {
          throw new Error(`Azure API error: ${response.status}`);
        }
        
        return response.json();
      }
      
      // Cost Management API
      async getCostData(scope, timeframe = 'MonthToDate') {
        const endpoint = `/${scope}/providers/Microsoft.CostManagement/query?api-version=2023-03-01`;
        const body = {
          type: 'ActualCost',
          dataSet: {
            granularity: 'Daily',
            aggregation: {
              totalCost: {
                name: 'Cost',
                function: 'Sum'
              }
            }
          },
          timeframe: timeframe
        };
        
        return this.callAzureAPI(endpoint, {
          method: 'POST',
          body: JSON.stringify(body)
        });
      }
      
      // Resource Management API
      async getResources() {
        const endpoint = `/subscriptions/${this.subscriptionId}/resources?api-version=2021-04-01`;
        return this.callAzureAPI(endpoint);
      }
      
      async getResourceGroups() {
        const endpoint = `/subscriptions/${this.subscriptionId}/resourcegroups?api-version=2021-04-01`;
        return this.callAzureAPI(endpoint);
      }
      
      async getStorageAccounts() {
        const endpoint = `/subscriptions/${this.subscriptionId}/providers/Microsoft.Storage/storageAccounts?api-version=2023-01-01`;
        return this.callAzureAPI(endpoint);
      }
      
      async getVirtualMachines() {
        const endpoint = `/subscriptions/${this.subscriptionId}/providers/Microsoft.Compute/virtualMachines?api-version=2023-03-01`;
        return this.callAzureAPI(endpoint);
      }
      
      async getWebApps() {
        const endpoint = `/subscriptions/${this.subscriptionId}/providers/Microsoft.Web/sites?api-version=2022-03-01`;
        return this.callAzureAPI(endpoint);
      }
    }
    
    // Initialize Azure API client
    const azure = new AzureAPI();
    
    // Dashboard Functions
    let currentTab = 'overview';
    let resources = [];
    let projects = [];
    
    function switchTab(tabName) {
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      event.target.classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(tabName).classList.add('active');
      
      currentTab = tabName;
      
      // Load tab-specific data
      if (tabName === 'costs') {
        loadCostAnalysis();
      } else if (tabName === 'resources') {
        loadResources();
      } else if (tabName === 'projects') {
        loadProjects();
      }
    }
    
    async function refreshAll() {
      updateStatus('Refreshing all data...', 'loading');
      
      try {
        // Get all data in parallel
        const [costData, resourceData, rgData, vmData, storageData, webAppData] = await Promise.all([
          azure.getCostData(`subscriptions/${azure.subscriptionId}`),
          azure.getResources(),
          azure.getResourceGroups(),
          azure.getVirtualMachines(),
          azure.getStorageAccounts(),
          azure.getWebApps()
        ]);
        
        // Update UI with real data
        updateCostCards(costData);
        updateResourceCounts(resourceData, rgData, vmData, storageData, webAppData);
        updateTopResources(costData);
        
        updateStatus('Connected to Azure', 'success');
        document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
        
      } catch (error) {
        console.error('Error refreshing data:', error);
        updateStatus('Error loading data', 'error');
        
        // Fall back to our metrics API
        fallbackToMetricsAPI();
      }
    }
    
    async function fallbackToMetricsAPI() {
      try {
        const response = await fetch('https://saxtech-metrics-api.azurewebsites.net/api/metrics?_t=' + Date.now());
        const data = await response.json();
        
        // Update with API data
        document.getElementById('mtdCost').textContent = `$${(data.costs?.monthToDate || 0).toFixed(2)}`;
        document.getElementById('yesterdayCost').textContent = `$${(data.costs?.yesterday || 0).toFixed(2)}`;
        document.getElementById('todayCost').textContent = `$${(data.costs?.today || 0).toFixed(2)}`;
        
        updateStatus('Using cached data (API)', 'warning');
      } catch (error) {
        console.error('Fallback API error:', error);
      }
    }
    
    function updateStatus(message, type = 'info') {
      const statusText = document.getElementById('statusText');
      statusText.textContent = message;
      
      const indicator = document.querySelector('.status-indicator');
      if (type === 'success') {
        indicator.style.background = '#10b981';
      } else if (type === 'error') {
        indicator.style.background = '#ef4444';
      } else if (type === 'warning') {
        indicator.style.background = '#f59e0b';
      } else {
        indicator.style.background = '#3b82f6';
      }
    }
    
    function updateCostCards(costData) {
      // Process cost data from Azure Cost Management API
      if (costData && costData.properties && costData.properties.rows) {
        let total = 0;
        costData.properties.rows.forEach(row => {
          total += row[0]; // Assuming first column is cost
        });
        
        document.getElementById('mtdCost').textContent = `$${total.toFixed(2)}`;
        
        // Calculate projected monthly
        const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth() + 1, 0).getDate();
        const daysPassed = new Date().getDate();
        const projected = (total / daysPassed) * daysInMonth;
        document.getElementById('projectedCost').textContent = `$${projected.toFixed(2)}`;
      }
    }
    
    function updateResourceCounts(resources, resourceGroups, vms, storage, webApps) {
      document.getElementById('rgCount').textContent = resourceGroups?.value?.length || 0;
      document.getElementById('vmCount').textContent = vms?.value?.length || 0;
      document.getElementById('storageCount').textContent = storage?.value?.length || 0;
      document.getElementById('webAppCount').textContent = webApps?.value?.length || 0;
      
      // Update running VMs
      if (vms?.value) {
        const running = vms.value.filter(vm => vm.properties?.instanceView?.statuses?.some(s => s.code === 'PowerState/running')).length;
        document.getElementById('vmRunning').textContent = `${running} running`;
      }
    }
    
    function updateTopResources(costData) {
      // This would parse and display top resources by cost
      const table = document.getElementById('topResourcesTable');
      table.innerHTML = '<tr><td colspan="5" style="text-align: center;">No cost data available</td></tr>';
    }
    
    async function loadCostAnalysis() {
      // Load detailed cost analysis
      console.log('Loading cost analysis...');
    }
    
    async function loadResources() {
      try {
        const data = await azure.getResources();
        resources = data.value || [];
        
        const table = document.getElementById('resourcesTable');
        if (resources.length === 0) {
          table.innerHTML = '<tr><td colspan="6" style="text-align: center;">No resources found</td></tr>';
          return;
        }
        
        table.innerHTML = resources.map(resource => `
          <tr>
            <td>${resource.name}</td>
            <td>${resource.type.split('/').pop()}</td>
            <td>${resource.resourceGroup || '--'}</td>
            <td>${resource.location}</td>
            <td><span class="cost-badge cost-low">Active</span></td>
            <td>
              <button class="btn btn-secondary" style="padding: 5px 10px; font-size: 12px;" 
                      onclick="window.open('https://portal.azure.com/#@/resource${resource.id}', '_blank')">
                View in Azure
              </button>
            </td>
          </tr>
        `).join('');
      } catch (error) {
        console.error('Error loading resources:', error);
      }
    }
    
    function filterResources() {
      const search = document.getElementById('resourceSearch').value.toLowerCase();
      const rows = document.querySelectorAll('#resourcesTable tr');
      
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(search) ? '' : 'none';
      });
    }
    
    function loadProjects() {
      // Load projects from localStorage or blob storage
      const stored = localStorage.getItem('saxtech_projects');
      if (stored) {
        projects = JSON.parse(stored);
        renderProjects();
      }
    }
    
    function renderProjects() {
      const grid = document.getElementById('projectsGrid');
      if (projects.length === 0) {
        grid.innerHTML = '<div class="card card-full"><p style="text-align: center; color: #94a3b8;">No projects found. Create your first project!</p></div>';
        return;
      }
      
      grid.innerHTML = projects.map(project => `
        <div class="card">
          <h3>${project.name}</h3>
          <p style="color: #94a3b8; margin: 10px 0;">${project.client}</p>
          <p style="font-size: 14px;">${project.type}</p>
          <div style="margin-top: 15px;">
            <span class="cost-badge ${project.status === 'Active' ? 'cost-low' : 'cost-medium'}">${project.status}</span>
          </div>
        </div>
      `).join('');
    }
    
    function openProjectModal() {
      // This would open a modal to create a new project
      alert('Project creation modal would open here');
    }
    
    async function saveSettings() {
      const settings = {
        subscriptionId: document.getElementById('subscriptionId').value,
        tenantId: document.getElementById('tenantId').value,
        refreshRate: document.getElementById('refreshRate').value,
        costThreshold: document.getElementById('costThreshold').value
      };
      
      localStorage.setItem('azure_settings', JSON.stringify(settings));
      azure.subscriptionId = settings.subscriptionId;
      azure.tenantId = settings.tenantId;
      
      alert('Settings saved successfully!');
      refreshAll();
    }
    
    async function testAzureConnection() {
      updateStatus('Testing Azure connection...', 'loading');
      try {
        await azure.getResourceGroups();
        updateStatus('Azure connection successful!', 'success');
      } catch (error) {
        updateStatus('Azure connection failed', 'error');
        console.error('Connection test failed:', error);
      }
    }
    
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        window.location.href = '/.auth/logout';
      }
    }
    
    // Initialize on load
    window.addEventListener('DOMContentLoaded', async () => {
      // Check authentication
      const userInfo = await azure.getUserInfo();
      if (userInfo && userInfo.clientPrincipal) {
        document.getElementById('userEmail').textContent = userInfo.clientPrincipal.userDetails || 'User';
      }
      
      // Load settings
      const savedSettings = localStorage.getItem('azure_settings');
      if (savedSettings) {
        const settings = JSON.parse(savedSettings);
        document.getElementById('subscriptionId').value = settings.subscriptionId || '';
        document.getElementById('tenantId').value = settings.tenantId || '';
        document.getElementById('refreshRate').value = settings.refreshRate || 300;
        document.getElementById('costThreshold').value = settings.costThreshold || 500;
      }
      
      // Display API endpoints
      document.getElementById('apiEndpoints').innerHTML = `
        <div>Cost Management: https://management.azure.com/subscriptions/{subId}/providers/Microsoft.CostManagement/</div>
        <div>Resources: https://management.azure.com/subscriptions/{subId}/resources</div>
        <div>Resource Groups: https://management.azure.com/subscriptions/{subId}/resourcegroups</div>
        <div>Storage: https://management.azure.com/subscriptions/{subId}/providers/Microsoft.Storage/</div>
      `.replace(/{subId}/g, azure.subscriptionId);
      
      // Initial data load
      refreshAll();
      
      // Auto-refresh based on settings
      const refreshRate = parseInt(document.getElementById('refreshRate').value) || 300;
      setInterval(refreshAll, refreshRate * 1000);
    });
  </script>
</body>
</html>
