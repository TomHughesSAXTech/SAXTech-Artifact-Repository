<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>Debug Console - JavaScript Diagnostics</title>
  <style>
    body { 
      background: #0a0e27; 
      color: #e2e8f0; 
      font-family: system-ui, -apple-system, sans-serif;
      padding: 40px;
      max-width: 1200px;
      margin: 0 auto;
    }
    h1 { color: #00d4ff; }
    .info-box { 
      padding: 20px; 
      background: rgba(0,212,255,0.1); 
      border: 1px solid rgba(0,212,255,0.3);
      border-radius: 8px;
      margin: 20px 0;
      font-family: 'Courier New', monospace;
      white-space: pre-wrap;
    }
    .error { 
      background: rgba(239,68,68,0.1); 
      border-color: rgba(239,68,68,0.3);
      color: #ef4444;
    }
    .success { 
      background: rgba(16,185,129,0.1); 
      border-color: rgba(16,185,129,0.3);
      color: #10b981;
    }
    button {
      background: linear-gradient(135deg, #00d4ff, #7c3aed);
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      margin: 10px 10px 10px 0;
      font-weight: 600;
    }
  </style>
</head>
<body>
  <h1>üîç JavaScript Debug Console</h1>
  
  <div id="main-status" class="info-box">
    Checking JavaScript execution...
  </div>

  <h2>Quick Diagnostics:</h2>
  <div>
    <button onclick="checkConsole()">1. Check Console</button>
    <button onclick="checkAPI()">2. Check API</button>
    <button onclick="checkScripts()">3. Check Scripts</button>
    <button onclick="checkDashboard()">4. Load Dashboard Scripts</button>
  </div>

  <h2>Results:</h2>
  <div id="results"></div>

  <script>
    // === IMMEDIATE EXECUTION TEST ===
    (function() {
      console.log('===== DEBUG CONSOLE STARTED =====');
      console.log('Time:', new Date().toISOString());
      console.log('URL:', window.location.href);
      console.log('Ready State:', document.readyState);
      
      // Update status immediately
      const statusEl = document.getElementById('main-status');
      if (statusEl) {
        statusEl.textContent = '‚úÖ JavaScript is executing!\n\n' +
                               'Open browser console (F12) to see detailed logs.\n' +
                               'Click the buttons above to run specific tests.';
        statusEl.className = 'info-box success';
      }
    })();

    // Helper to add results to page
    function addResult(title, content, type = 'info') {
      const div = document.createElement('div');
      div.className = 'info-box ' + type;
      div.innerHTML = `<strong>${title}</strong>\n${content}`;
      document.getElementById('results').appendChild(div);
    }

    // Test 1: Console functionality
    function checkConsole() {
      console.log('=== CONSOLE TEST ===');
      console.log('Regular log');
      console.warn('Warning message');
      console.error('Error message (this is just a test)');
      console.info('Info message');
      console.group('Grouped messages');
      console.log('Message 1');
      console.log('Message 2');
      console.groupEnd();
      
      const testObj = {
        string: 'test',
        number: 123,
        boolean: true,
        array: [1, 2, 3],
        nested: { foo: 'bar' }
      };
      console.table(testObj);
      
      addResult('Console Test', 'All console methods executed.\nCheck browser console for output.', 'success');
    }

    // Test 2: API connectivity
    async function checkAPI() {
      console.log('=== API TEST ===');
      addResult('API Test', 'Fetching from metrics API...', 'info');
      
      try {
        const response = await fetch('https://saxtech-metrics-api.azurewebsites.net/api/metrics');
        console.log('Response status:', response.status);
        console.log('Response headers:', response.headers);
        
        const data = await response.json();
        console.log('API Data:', data);
        
        const summary = `Status: ${response.status}
Headers: ${response.headers.get('content-type')}
Data keys: ${Object.keys(data).join(', ')}
MTD Cost: $${data.costs?.monthToDate || 'N/A'}`;
        
        addResult('API Response', summary, 'success');
      } catch (error) {
        console.error('API Error:', error);
        addResult('API Error', error.toString(), 'error');
      }
    }

    // Test 3: Script loading
    function checkScripts() {
      console.log('=== SCRIPT CHECK ===');
      
      const scripts = document.querySelectorAll('script');
      console.log(`Found ${scripts.length} script tags`);
      
      // Check for expected global objects
      const checks = {
        'Chart.js': typeof Chart !== 'undefined',
        'ChartDataLabels': typeof ChartDataLabels !== 'undefined',
        'Window.blobManager': typeof window.blobManager !== 'undefined',
        'Window.azureAuth': typeof window.azureAuth !== 'undefined',
        'LocalStorage': !!window.localStorage,
        'Fetch API': !!window.fetch,
        'Console': !!window.console
      };
      
      let summary = 'Global Objects Status:\n';
      for (const [name, exists] of Object.entries(checks)) {
        summary += `${exists ? '‚úÖ' : '‚ùå'} ${name}\n`;
        console.log(`${name}:`, exists);
      }
      
      addResult('Script Check', summary, 'info');
    }

    // Test 4: Load dashboard scripts
    function checkDashboard() {
      console.log('=== LOADING DASHBOARD SCRIPTS ===');
      
      const scriptsToLoad = [
        { src: 'chart.min.js?v=2', name: 'Chart.js' },
        { src: 'chartjs-plugin-datalabels.min.js?v=2', name: 'Chart DataLabels' },
        { src: 'azure-auth-integration.js', name: 'Azure Auth' },
        { src: 'azure-metrics-fetcher.js', name: 'Metrics Fetcher' }
      ];
      
      let loadedCount = 0;
      const total = scriptsToLoad.length;
      
      scriptsToLoad.forEach(({ src, name }) => {
        const script = document.createElement('script');
        script.src = src;
        script.onload = () => {
          loadedCount++;
          console.log(`‚úÖ Loaded: ${name}`);
          if (loadedCount === total) {
            addResult('Scripts Loaded', `All ${total} scripts loaded successfully!`, 'success');
            
            // Try to initialize the dashboard
            setTimeout(() => {
              if (typeof refreshAllWithCharts === 'function') {
                console.log('Dashboard function found! Calling refreshAllWithCharts()');
                refreshAllWithCharts();
              } else {
                console.log('Dashboard functions not found in global scope');
              }
            }, 500);
          }
        };
        script.onerror = () => {
          console.error(`‚ùå Failed to load: ${name}`);
          addResult('Script Error', `Failed to load: ${name}`, 'error');
        };
        document.head.appendChild(script);
      });
      
      addResult('Loading Scripts', `Loading ${total} dashboard scripts...`, 'info');
    }

    // Listen for any errors
    window.addEventListener('error', (e) => {
      console.error('Window Error:', e);
      addResult('JavaScript Error', `${e.message}\nFile: ${e.filename}\nLine: ${e.lineno}`, 'error');
    });

    window.addEventListener('unhandledrejection', (e) => {
      console.error('Unhandled Promise Rejection:', e);
      addResult('Promise Rejection', e.reason, 'error');
    });

    // Log when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        console.log('DOM fully loaded');
      });
    } else {
      console.log('DOM already loaded');
    }

    console.log('===== DEBUG SCRIPT LOADED SUCCESSFULLY =====');
  </script>
</body>
</html>
