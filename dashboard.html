<!DOCTYPE html>
<html lang="en">
<head>
  <!-- Version 4: Fixed function app count, K8s display, storage handling, cache control -->
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Automation & AI Hub | Live Dashboard v4</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />
  <script src="chart.min.js?v=2"></script>
  <script src="chartjs-plugin-datalabels.min.js?v=2"></script>
  <script src="azure-auth-integration.js"></script>
  <script src="azure-metrics-fetcher.js"></script>
  <style>
    :root {
      --bg: #060818; --card: #0f1729; --text: #e2e8f0; --muted: #94a3b8;
      --primary: #00d4ff; --accent: #7c3aed; --good: #10b981; --warn: #f59e0b; --bad: #ef4444;
      --border: rgba(0,212,255,0.15);
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: #060818; color: var(--text); }
    header { position: sticky; top:0; z-index: 50; backdrop-filter: blur(10px); background: rgba(6,8,24,0.75); border-bottom:1px solid var(--border); }
    .wrap { max-width: 1300px; margin: 0 auto; padding: 20px 24px; }
    .row { display:flex; align-items:center; justify-content: space-between; gap: 16px; }
    .title { font-weight: 800; font-size: 22px; letter-spacing: -0.3px; }
    .subtitle { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 1.6px; }
    .btn { background: linear-gradient(135deg, var(--primary), var(--accent)); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; transition: all 0.2s; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,212,255,0.3); }
    .btn.secondary { background: rgba(124,58,237,0.12); color: var(--primary); border:1px solid var(--border); }
    .grid { display:grid; gap:16px; grid-template-columns: repeat(12, 1fr); margin-top: 20px; }
    .card { background: var(--card); border:1px solid var(--border); border-radius: 14px; padding: 16px; position: relative; overflow: hidden; }
    .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--primary), transparent); }
    .span-3 { grid-column: span 3; }
    .span-4 { grid-column: span 4; }
    .span-6 { grid-column: span 6; }
    .span-8 { grid-column: span 8; }
    .span-12 { grid-column: span 12; }
    .stat { display:flex; align-items: center; justify-content: space-between; }
    .stat .label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
    .stat .value { font-size: 28px; font-weight: 800; background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .row-col { display:flex; gap:10px; align-items:center; }
    .list { display:flex; flex-direction: column; gap:10px; }
    .kpi { display:flex; align-items:center; justify-content: space-between; padding: 10px; background: rgba(0,212,255,0.06); border: 1px dashed var(--border); border-radius:10px; }
    .muted { color: var(--muted); }
    .pill { font-size: 11px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); }
    .section-title { font-weight:700; margin-bottom:8px; }
    .settings-grid { display:grid; gap:12px; grid-template-columns: repeat(2, 1fr); }
    input[type="number"], input[type="text"] { width: 100%; padding: 12px; border-radius: 10px; border:1px solid var(--border); background: #0b1120; color: var(--text); }
    .note { font-size:12px; color: var(--muted); }
    a { color: var(--primary); text-decoration: none; }
    .chart-container { position: relative; height: 300px; width: 100%; padding: 10px 0; }
    .metrics-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .metrics-table th { text-align: left; padding: 8px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); border-bottom: 1px solid var(--border); }
    .metrics-table td { padding: 10px 8px; border-bottom: 1px solid rgba(0,212,255,0.08); }
    .metrics-table tr:hover { background: rgba(0,212,255,0.04); }
    .project-link { color: var(--primary); font-weight: 500; cursor: pointer; }
    .traffic-value { font-weight: 600; color: var(--text); }
    .bandwidth-badge { background: rgba(124,58,237,0.12); color: var(--accent); padding: 3px 8px; border-radius: 6px; font-size: 12px; }
    .clickable { cursor: pointer; transition: all 0.2s ease; position: relative; }
    .clickable:hover { transform: translateY(-2px); filter: brightness(1.2); }
    .clickable::after { content: '‚Üó'; position: absolute; top: -8px; right: -8px; font-size: 10px; color: var(--primary); opacity: 0; transition: opacity 0.2s; }
    .clickable:hover::after { opacity: 1; }
    
    /* Enhanced Modal Styles */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(6,8,24,0.95); backdrop-filter: blur(10px); z-index: 1000; animation: fadeIn 0.2s; }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-content { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; animation: slideUp 0.3s; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
    .modal-title { font-size: 20px; font-weight: 700; background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .modal-close { background: none; border: none; color: var(--muted); font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s; }
    .modal-close:hover { background: rgba(0,212,255,0.1); color: var(--primary); }
    .modal-body { color: var(--text); }
    
    /* Breakdown Items */
    .breakdown-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,212,255,0.05); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; transition: all 0.2s; }
    .breakdown-item:hover { background: rgba(0,212,255,0.08); transform: translateX(4px); }
    .breakdown-label { color: var(--text); font-weight: 500; }
    .breakdown-value { color: var(--primary); font-weight: 600; font-family: 'JetBrains Mono', monospace; }
    .breakdown-meta { font-size: 11px; color: var(--muted); margin-top: 4px; }
    
    /* Resource Details */
    .resource-card { background: rgba(15,23,41,0.5); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .resource-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .resource-name { font-weight: 600; color: var(--text); font-size: 14px; }
    .resource-cost { color: var(--good); font-weight: 600; font-family: 'JetBrains Mono', monospace; }
    .resource-details { display: grid; gap: 8px; font-size: 12px; }
    .resource-detail { display: flex; gap: 8px; }
    .resource-detail-label { color: var(--muted); min-width: 100px; }
    .resource-detail-value { color: var(--text); word-break: break-all; }
    .resource-endpoint { color: var(--primary); cursor: pointer; }
    .resource-endpoint:hover { text-decoration: underline; }
    
    /* SSL Certificate Styles */
    .ssl-card { background: rgba(15,23,41,0.5); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .ssl-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .ssl-domain { font-weight: 600; color: var(--text); }
    .ssl-status { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
    .ssl-status.valid { background: rgba(16,185,129,0.2); color: var(--good); }
    .ssl-status.expiring { background: rgba(245,158,11,0.2); color: var(--warn); }
    .ssl-status.expired { background: rgba(239,68,68,0.2); color: var(--bad); }
    .ssl-details { display: grid; gap: 8px; font-size: 12px; }
    .ssl-detail { display: flex; gap: 8px; }
    .ssl-detail-label { color: var(--muted); min-width: 100px; }
    .ssl-detail-value { color: var(--text); }
    
    /* Cluster Info */
    .cluster-card { background: rgba(15,23,41,0.5); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .cluster-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .cluster-name { font-weight: 600; color: var(--text); }
    .cluster-status { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
    .cluster-status.running { background: rgba(16,185,129,0.2); color: var(--good); }
    .cluster-status.stopped { background: rgba(239,68,68,0.2); color: var(--bad); }
    .cluster-metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
    .cluster-metric { text-align: center; padding: 8px; background: rgba(0,212,255,0.05); border-radius: 8px; }
    .cluster-metric-value { font-size: 20px; font-weight: 700; color: var(--primary); }
    .cluster-metric-label { font-size: 10px; color: var(--muted); text-transform: uppercase; }
    
    /* Storage Container Details */
    .container-list { margin-top: 12px; }
    .container-item { background: rgba(0,212,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 8px; }
    .container-name { font-weight: 500; color: var(--text); margin-bottom: 4px; }
    .container-stats { display: flex; gap: 16px; font-size: 11px; color: var(--muted); }
    .container-stat { display: flex; gap: 4px; }
    .container-stat-value { color: var(--primary); font-weight: 600; }
    
    /* Backup Details */
    .backup-vault { background: rgba(15,23,41,0.5); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .backup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .backup-jobs { margin-top: 12px; }
    .backup-job { display: flex; justify-content: space-between; padding: 8px; background: rgba(0,212,255,0.03); border-radius: 6px; margin-bottom: 6px; }
    .backup-job-status { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; }
    .backup-job-status.success { background: rgba(16,185,129,0.2); color: var(--good); }
    .backup-job-status.failed { background: rgba(239,68,68,0.2); color: var(--bad); }
    
    /* GPT Model Usage */
    .model-usage-grid { display: grid; gap: 12px; margin-top: 16px; }
    .model-card { background: rgba(15,23,41,0.5); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .model-name { font-weight: 600; color: var(--text); margin-bottom: 8px; font-size: 14px; }
    .model-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .model-stat { padding: 8px; background: rgba(0,212,255,0.05); border-radius: 8px; text-align: center; }
    .model-stat-value { font-size: 18px; font-weight: 700; color: var(--primary); }
    .model-stat-label { font-size: 10px; color: var(--muted); text-transform: uppercase; margin-top: 4px; }
    
    /* Status Badges */
    .status-badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
    .status-badge.active { background: rgba(16,185,129,0.2); color: var(--good); }
    .status-badge.warning { background: rgba(245,158,11,0.2); color: var(--warn); }
    .status-badge.error { background: rgba(239,68,68,0.2); color: var(--bad); }
    
    /* Today's cost card styles */
    .cost-today-card { background: rgba(124,58,237,0.12); border: 1px solid var(--accent); }
    .projection-value { color: var(--accent); font-style: italic; }
    
    @media (max-width: 900px) { 
      .span-6, .span-8, .span-4, .span-3 { grid-column: span 12; } 
      .settings-grid { grid-template-columns: 1fr; }
      .cluster-metrics { grid-template-columns: 1fr; }
      .model-stats { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div>
          <div class="title">Automation & AI Hub ‚Äî Live Dashboard</div>
          <div class="subtitle">Real-time Azure metrics ¬∑ Manual tool costs ¬∑ SSL monitoring</div>
        </div>
        <div class="row-col">
          <button class="btn secondary" onclick="window.location.href='index.html'">‚¨Ö Back to Hub</button>
          <button class="btn" onclick="refreshAllWithCharts()">üîÑ Refresh</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="grid">
      <!-- Cost Cards -->
      <div class="card span-3">
        <div class="stat"><div class="label">Month-to-Date Cost</div><div id="cost_mtd" class="value clickable" onclick="showCostBreakdown('mtd')">$0</div></div>
        <div class="note">Azure ‚Äî subscription 3cfb259a-f02a-484e-9ce3-d83c21fd0ddb</div>
      </div>
      <div class="card span-3">
        <div class="stat"><div class="label">Daily Cost (Yesterday)</div><div id="cost_daily" class="value clickable" onclick="showCostBreakdown('yesterday')">$0</div></div>
        <div class="note">EST timezone</div>
      </div>
      <div class="card span-3 cost-today-card">
        <div class="stat"><div class="label">Today's Cost (Live)</div><div id="cost_today" class="value clickable" onclick="showCostBreakdown('today')">$0</div></div>
        <div class="note">Real-time Azure Cost Management</div>
      </div>
      <div class="card span-3">
        <div class="stat"><div class="label">Static Web Apps</div><div id="count_swa" class="value clickable" onclick="showResourceBreakdown('staticSites')">0</div></div>
        <div class="note">Microsoft.Web/staticSites</div>
      </div>

      <!-- Function Apps Card with Enhanced Info -->
      <div class="card span-4">
        <div class="stat"><div class="label">Function Apps</div><div id="count_func" class="value clickable" onclick="showResourceBreakdown('functionApps')">0</div></div>
        <div class="kpi" style="margin-top:10px;">
          <div>Last Execution</div>
          <div id="func_last_run" class="pill">Never</div>
        </div>
        <div class="kpi">
          <div>Active Functions</div>
          <div id="func_active" class="pill">0</div>
        </div>
      </div>

      <!-- Kubernetes Card -->
      <div class="card span-4">
        <div class="stat"><div class="label">Kubernetes Clusters</div><div id="k8s_count" class="value clickable" onclick="showKubernetesDetails()">0</div></div>
        <div class="kpi" style="margin-top:10px;">
          <div>Total Nodes</div>
          <div id="k8s_nodes" class="pill">0</div>
        </div>
        <div class="kpi">
          <div>Avg CPU Usage</div>
          <div id="k8s_cpu" class="pill">0%</div>
        </div>
      </div>

      <!-- Backup Status Card -->
      <div class="card span-4">
        <div class="stat"><div class="label">Backup Status</div><div id="backup_status" class="value clickable" onclick="showBackupDetails()">Checking...</div></div>
        <div class="kpi" style="margin-top:10px;">
          <div>Protected Items</div>
          <div id="backup_items" class="pill">0</div>
        </div>
        <div class="kpi">
          <div>Last 24h Jobs</div>
          <div id="backup_jobs" class="pill">0 success / 0 failed</div>
        </div>
        <div class="note" style="margin-top:8px; font-size:10px;">Last updated: <span id="backup_timestamp">--</span></div>
      </div>

      <!-- SSL Certificate Monitoring Card -->
      <div class="card span-6">
        <div class="stat"><div class="label">SSL Certificates</div><div id="ssl_count" class="value clickable" onclick="showSSLDetails()">0</div></div>
        <div class="kpi" style="margin-top:10px;">
          <div>Expiring Soon (30 days)</div>
          <div id="ssl_expiring" class="pill warning">0</div>
        </div>
        <div class="kpi">
          <div>Valid Certificates</div>
          <div id="ssl_valid" class="pill">0</div>
        </div>
        <div class="note" style="margin-top:8px;">Next expiration: <span id="ssl_next_expiry">--</span></div>
      </div>

      <!-- Storage Accounts Card with Enhanced Info -->
      <div class="card span-6">
        <div class="stat"><div class="label">Storage Accounts</div><div id="count_sa" class="value clickable" onclick="showStorageDetails()">0</div></div>
        <div class="kpi" style="margin-top:10px;">
          <div>Total Storage Used</div>
          <div id="storage_used" class="pill">0 B</div>
        </div>
        <div class="kpi">
          <div>Total Blobs</div>
          <div id="storage_blobs" class="pill">0</div>
        </div>
        <div class="kpi">
          <div>Storage Tiers</div>
          <div id="storage_tiers" class="pill">Hot: 0, Cool: 0, Archive: 0</div>
        </div>
      </div>

      <!-- Revenue vs Costs with Resource Allocation -->
      <div class="card span-8">
        <div class="section-title">Revenue vs. Costs (with Resource Allocation)</div>
        <div class="list" id="rev_cost_list">
          <div class="kpi"><div>Monthly Recurring Revenue (sum of active projects)</div><div id="mrr_sum" class="pill">$0</div></div>
          <div class="kpi"><div>Implementation Fees (closed this month)</div><div id="impl_sum" class="pill">$0</div></div>
          <div class="kpi"><div>Manual Tool Costs (ChatGPT, Claude, Warp, other)</div><div id="tools_cost" class="pill">$0</div></div>
          <div class="kpi"><div>Azure Month-to-Date Cost</div><div id="azure_cost_pill" class="pill">$0</div></div>
          <div class="kpi"><div>Net (MRR + Impl - Tools - Azure)</div><div id="net_value" class="pill">$0</div></div>
        </div>
        <div style="margin-top: 12px;">
          <button class="btn secondary" onclick="showResourceAllocation()">üìä Configure Resource Allocation</button>
        </div>
      </div>

      <!-- GPT Usage Summary -->
      <div class="card span-4">
        <div class="stat"><div class="label">GPT Total Tokens (30d)</div><div id="gpt_tokens" class="value clickable" onclick="showGPTBreakdown()">0</div></div>
        <div class="kpi" style="margin-top:10px;">
          <div>Estimated Cost</div>
          <div id="gpt_cost" class="pill">$0</div>
        </div>
        <div class="kpi">
          <div>Models Active</div>
          <div id="gpt_models" class="pill">0</div>
        </div>
        <div class="kpi">
          <div>OpenAI Accounts</div>
          <div id="gpt_accounts" class="pill">0</div>
        </div>
      </div>

      <!-- Historical Cost Chart -->
      <div class="card span-12">
        <div class="section-title">Historical Cost Trending ‚Äî Last 30 Days</div>
        <div class="chart-container">
          <canvas id="costTrendChart"></canvas>
        </div>
        <div class="note">Shows daily Azure costs for the past 30 days. Data refreshes automatically.</div>
      </div>

      <!-- GPT Token Charts -->
      <div class="card span-6">
        <div class="section-title">GPT Token Usage ‚Äî Daily Trend</div>
        <div class="chart-container">
          <canvas id="tokenUsageChart"></canvas>
        </div>
        <div class="note">OpenAI API token consumption over the last 7 days</div>
      </div>

      <div class="card span-6">
        <div class="section-title">GPT Token Usage ‚Äî By Model</div>
        <div class="chart-container">
          <canvas id="tokenModelChart"></canvas>
        </div>
        <div class="note">Token distribution across different GPT models</div>
      </div>

      <!-- Project Traffic Table -->
      <div class="card span-12">
        <div class="section-title">Project Traffic & Bandwidth Metrics</div>
        <table class="metrics-table" id="trafficMetricsTable">
          <thead>
            <tr>
              <th>Project</th>
              <th>Status</th>
              <th>Monthly Traffic</th>
              <th>Bandwidth Used</th>
              <th>Storage Size</th>
              <th>Last Activity</th>
            </tr>
          </thead>
          <tbody id="trafficMetricsBody">
            <tr>
              <td colspan="6" style="text-align: center; color: var(--muted);">Loading metrics...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Settings -->
      <div class="card span-12">
        <div class="section-title">Settings ‚Äî Manual Tool Costs</div>
        <div class="settings-grid">
          <div>
            <label>ChatGPT Monthly ($)</label>
            <input type="number" id="cost_chatgpt" min="0" step="0.01" />
          </div>
          <div>
            <label>Claude Monthly ($)</label>
            <input type="number" id="cost_claude" min="0" step="0.01" />
          </div>
          <div>
            <label>Warp Monthly ($)</label>
            <input type="number" id="cost_warp" min="0" step="0.01" />
          </div>
          <div>
            <label>Other Tools Monthly ($)</label>
            <input type="number" id="cost_other" min="0" step="0.01" />
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <div class="note">Only manual entries here. All Azure metrics are live from your subscription.</div>
          <div>
            <button class="btn secondary" onclick="resetSettings()">Reset</button>
            <button class="btn" onclick="saveSettings()">Save</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modals -->
  <div id="costBreakdownModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Cost Breakdown</h2>
        <button class="modal-close" onclick="closeModal('costBreakdownModal')">√ó</button>
      </div>
      <div class="modal-body" id="costBreakdownBody"></div>
    </div>
  </div>

  <div id="resourceBreakdownModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Resource Details</h2>
        <button class="modal-close" onclick="closeModal('resourceBreakdownModal')">√ó</button>
      </div>
      <div class="modal-body" id="resourceBreakdownBody"></div>
    </div>
  </div>

  <div id="kubernetesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Kubernetes Clusters</h2>
        <button class="modal-close" onclick="closeModal('kubernetesModal')">√ó</button>
      </div>
      <div class="modal-body" id="kubernetesBody"></div>
    </div>
  </div>

  <div id="backupModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Backup Status Details</h2>
        <button class="modal-close" onclick="closeModal('backupModal')">√ó</button>
      </div>
      <div class="modal-body" id="backupBody"></div>
    </div>
  </div>

  <div id="storageModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Storage Account Details</h2>
        <button class="modal-close" onclick="closeModal('storageModal')">√ó</button>
      </div>
      <div class="modal-body" id="storageBody"></div>
    </div>
  </div>

  <div id="gptModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">GPT Usage Breakdown</h2>
        <button class="modal-close" onclick="closeModal('gptModal')">√ó</button>
      </div>
      <div class="modal-body" id="gptBody"></div>
    </div>
  </div>

  <div id="sslModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">SSL Certificate Details</h2>
        <button class="modal-close" onclick="closeModal('sslModal')">√ó</button>
      </div>
      <div class="modal-body" id="sslBody"></div>
    </div>
  </div>

  <div id="resourceAllocationModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Resource Cost Allocation</h2>
        <button class="modal-close" onclick="closeModal('resourceAllocationModal')">√ó</button>
      </div>
      <div class="modal-body" id="resourceAllocationBody"></div>
    </div>
  </div>

  <script>
    // Global data storage
    let metricsData = null;
    let charts = {};

    // Modal functions
    function showModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // Close modal on ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(modal => {
          modal.classList.remove('active');
        });
      }
    });

    // SSL Certificate Details Modal - only real data
    function showSSLDetails() {
      if (!metricsData?.sslCertificates) return;
      
      const body = document.getElementById('sslBody');
      const sslCertificates = metricsData.sslCertificates;
      
      let html = '<h3>SSL Certificate Status</h3>';
      
      if (sslCertificates.length === 0) {
        html += '<p class="muted">No SSL certificate data available</p>';
      } else {
        sslCertificates.forEach(cert => {
          const daysRemaining = cert.daysUntilExpiry || cert.daysRemaining || 0;
          const statusClass = daysRemaining <= 30 ? 'expiring' : 'valid';
          html += `
            <div class="ssl-card">
              <div class="ssl-header">
                <div class="ssl-domain">${cert.domain}</div>
                <div class="ssl-status ${statusClass}">
                  ${daysRemaining <= 30 ? `Expires in ${daysRemaining} days` : 'Valid'}
                </div>
              </div>
              <div class="ssl-details">
                <div class="ssl-detail">
                  <div class="ssl-detail-label">Issuer:</div>
                  <div class="ssl-detail-value">${cert.issuer}</div>
                </div>
                <div class="ssl-detail">
                  <div class="ssl-detail-label">Issued Date:</div>
                  <div class="ssl-detail-value">${new Date(cert.issuedDate || cert.validFrom).toLocaleDateString()}</div>
                </div>
                <div class="ssl-detail">
                  <div class="ssl-detail-label">Expiry Date:</div>
                  <div class="ssl-detail-value">${new Date(cert.expiryDate || cert.validUntil).toLocaleDateString()}</div>
                </div>
                <div class="ssl-detail">
                  <div class="ssl-detail-label">Days Remaining:</div>
                  <div class="ssl-detail-value ${daysRemaining <= 30 ? 'warning' : ''}">${daysRemaining} days</div>
                </div>
                ${cert.attachedTo && cert.attachedTo.length > 0 ? `
                <div class="ssl-detail">
                  <div class="ssl-detail-label">Attached To:</div>
                  <div class="ssl-detail-value">${cert.attachedTo.join(', ')}</div>
                </div>
                ` : ''}
                <div class="ssl-detail">
                  <div class="ssl-detail-label">Auto Renew:</div>
                  <div class="ssl-detail-value">${cert.autoRenew ? 'Yes' : 'No'}</div>
                </div>
              </div>
              ${daysRemaining <= 30 ? `
                <div style="margin-top: 12px;">
                  <button class="btn" onclick="renewSSL('${cert.domain}')">üîÑ Renew Certificate</button>
                </div>
              ` : ''}
            </div>
          `;
        });
      }
      
      body.innerHTML = html;
      showModal('sslModal');
    }

    // Resource Allocation Modal
    function showResourceAllocation() {
      const body = document.getElementById('resourceAllocationBody');
      
      let html = '<h3>Configure Resource Cost Allocation</h3>';
      html += '<p class="muted">Select resources to include in cost calculations:</p>';
      
      // Create checkboxes for all resource types
      const resourceTypes = [
        { id: 'static-web-apps', name: 'Static Web Apps', count: metricsData?.resources?.staticSites || 0 },
        { id: 'function-apps', name: 'Function Apps', count: metricsData?.resources?.functionApps || 0 },
        { id: 'storage-accounts', name: 'Storage Accounts', count: metricsData?.resources?.storageAccounts || 0 },
        { id: 'kubernetes', name: 'Kubernetes Clusters', count: metricsData?.kubernetes?.clusterCount || 0 },
        { id: 'databases', name: 'PostgreSQL Databases', count: 1 },
        { id: 'openai', name: 'OpenAI Services', count: metricsData?.openAIUsage?.accounts?.length || 0 }
      ];
      
      html += '<div style="display: grid; gap: 12px; margin-top: 16px;">';
      resourceTypes.forEach(type => {
        html += `
          <label style="display: flex; align-items: center; gap: 8px; padding: 12px; background: rgba(0,212,255,0.05); border-radius: 8px; cursor: pointer;">
            <input type="checkbox" id="allocate-${type.id}" checked style="cursor: pointer;">
            <span>${type.name}</span>
            <span class="pill" style="margin-left: auto;">${type.count} resources</span>
          </label>
        `;
      });
      html += '</div>';
      
      html += `
        <div style="margin-top: 20px; display: flex; gap: 12px;">
          <button class="btn" onclick="saveResourceAllocation()">Save Allocation</button>
          <button class="btn secondary" onclick="closeModal('resourceAllocationModal')">Cancel</button>
        </div>
      `;
      
      body.innerHTML = html;
      showModal('resourceAllocationModal');
    }

    // Enhanced Cost Breakdown Modal with Today's Costs
    function showCostBreakdown(type) {
      if (!metricsData || !metricsData.costs) return;
      
      const body = document.getElementById('costBreakdownBody');
      let html = '';
      
      if (type === 'mtd') {
        html = '<h3>Month-to-Date Cost Breakdown by Service</h3>';
        const serviceBreakdown = metricsData.costs.serviceBreakdown || {};
        const sorted = Object.entries(serviceBreakdown).sort((a, b) => b[1].cost - a[1].cost);
        
        if (sorted.length > 0) {
          sorted.forEach(([service, data]) => {
            html += `
              <div class="breakdown-item">
                <div>
                  <div class="breakdown-label">${service}</div>
                  <div class="breakdown-meta">${data.percentage}% of total</div>
                </div>
                <div class="breakdown-value">$${data.cost.toFixed(2)}</div>
              </div>
            `;
          });
          
          // Show individual resources
          html += '<h3 style="margin-top: 20px;">Resources by Service</h3>';
          sorted.forEach(([service, data]) => {
            if (data.resources && data.resources.length > 0) {
              html += `<h4 style="margin-top: 16px; margin-bottom: 8px; color: var(--primary);">${service}</h4>`;
              data.resources.forEach(resource => {
                html += `
                  <div class="breakdown-item">
                    <div>
                      <div class="breakdown-label">${resource.name}</div>
                      <div class="breakdown-meta">${resource.type}</div>
                    </div>
                    <div class="breakdown-value">$${resource.cost.toFixed(2)}</div>
                  </div>
                `;
              });
            }
          });
        } else {
          html += '<p class="muted">No cost breakdown data available</p>';
        }
        
        // Add top resources by cost
        if (metricsData.costs.resourceCosts && metricsData.costs.resourceCosts.length > 0) {
          html += '<h3 style="margin-top: 20px;">Top Resources by Cost</h3>';
          metricsData.costs.resourceCosts.slice(0, 10).forEach(resource => {
            html += `
              <div class="breakdown-item">
                <div>
                  <div class="breakdown-label">${resource.name}</div>
                  <div class="breakdown-meta">${resource.service}</div>
                </div>
                <div class="breakdown-value">$${resource.totalCost.toFixed(2)}</div>
              </div>
            `;
          });
        }
      } else if (type === 'yesterday') {
        // Yesterday's detailed breakdown
        html = '<h3>Yesterday\'s Cost Details</h3>';
        html += `
          <div class="breakdown-item">
            <div class="breakdown-label">Total Cost</div>
            <div class="breakdown-value">$${(metricsData.costs.yesterday || 0).toFixed(2)}</div>
          </div>
        `;
        
        // Service breakdown for yesterday
        if (metricsData.costs.yesterdayDetails && metricsData.costs.yesterdayDetails.services) {
          html += '<h3 style="margin-top: 20px;">Breakdown by Service</h3>';
          const services = metricsData.costs.yesterdayDetails.services;
          const sorted = Object.entries(services).sort((a, b) => b[1] - a[1]);
          
          sorted.forEach(([service, cost]) => {
            if (cost > 0) {
              html += `
                <div class="breakdown-item">
                  <div class="breakdown-label">${service}</div>
                  <div class="breakdown-value">$${cost.toFixed(2)}</div>
                </div>
              `;
            }
          });
        }
      } else if (type === 'today') {
        // Today's live costs
        const todayCost = metricsData.costs.today || 0;
        const hoursElapsed = new Date().getHours();
        
        html = '<h3>Today\'s Cost Details (Live)</h3>';
        html += `
          <div class="breakdown-item">
            <div class="breakdown-label">Current Cost (${hoursElapsed} hours elapsed)</div>
            <div class="breakdown-value">$${todayCost.toFixed(2)}</div>
          </div>
          <div class="breakdown-item">
            <div class="breakdown-label">Average Hourly Rate</div>
            <div class="breakdown-value">$${(todayCost / Math.max(hoursElapsed, 1)).toFixed(2)}/hr</div>
          </div>
        `;
        
        // Active resources contributing to today's costs
        if (metricsData.costs.todayResources && metricsData.costs.todayResources.length > 0) {
          html += '<h3 style="margin-top: 20px;">Active Resources Today</h3>';
          metricsData.costs.todayResources.forEach(resource => {
            html += `
              <div class="breakdown-item">
                <div>
                  <div class="breakdown-label">${resource.name}</div>
                  <div class="breakdown-meta">${resource.service}</div>
                </div>
                <div class="breakdown-value">$${resource.cost.toFixed(2)}</div>
              </div>
            `;
          });
        }
      }
      
      body.innerHTML = html;
      showModal('costBreakdownModal');
    }

    // Enhanced Resource Breakdown Modal with Function App Details
    function showResourceBreakdown(type) {
      if (!metricsData) return;
      
      const body = document.getElementById('resourceBreakdownBody');
      let resources = [];
      
      // Get resources based on type from actual API structure
      if (type === 'staticSites') {
        // Get static sites from githubBackups or costs breakdown
        if (metricsData.githubBackups?.staticWebApps?.list) {
          resources = metricsData.githubBackups.staticWebApps.list.map(name => ({ name, location: 'East US' }));
        }
      } else if (type === 'functionApps') {
        resources = metricsData.functionApps || [];
      } else if (type === 'storageAccounts') {
        resources = metricsData.storageAccounts || [];
      }
      
      let html = `<h3>${type === 'staticSites' ? 'Static Web Apps' : type === 'functionApps' ? 'Function Apps' : 'Storage Accounts'}</h3>`;
      
      if (resources.length === 0) {
        html += '<p class="muted">No resources found</p>';
      } else {
        resources.forEach(resource => {
          html += `
            <div class="resource-card">
              <div class="resource-header">
                <div class="resource-name">${resource.name}</div>
                ${type === 'functionApps' ? `
                  <div>
                    <span class="status-badge ${resource.state === 'Running' ? 'active' : 'warning'}">${resource.state || 'Unknown'}</span>
                  </div>
                ` : ''}
              </div>
              <div class="resource-details">
                <div class="resource-detail">
                  <div class="resource-detail-label">Location:</div>
                  <div class="resource-detail-value">${resource.location}</div>
                </div>
                <div class="resource-detail">
                  <div class="resource-detail-label">Resource Group:</div>
                  <div class="resource-detail-value">${resource.resourceGroup}</div>
                </div>
                ${type === 'functionApps' ? `
                  <div class="resource-detail">
                    <div class="resource-detail-label">Runtime:</div>
                    <div class="resource-detail-value">${resource.runtime || 'Node.js 18'}</div>
                  </div>
                  <div class="resource-detail">
                    <div class="resource-detail-label">App Service Plan:</div>
                    <div class="resource-detail-value">${resource.appServicePlan || 'Consumption'}</div>
                  </div>
                  <div class="resource-detail">
                    <div class="resource-detail-label">Last Run:</div>
                    <div class="resource-detail-value">${resource.lastRun ? new Date(resource.lastRun).toLocaleString() : 'Never'}</div>
                  </div>
                  <div class="resource-detail">
                    <div class="resource-detail-label">Execution Time:</div>
                    <div class="resource-detail-value">${resource.lastExecutionTime || 'N/A'}</div>
                  </div>
                  <div class="resource-detail">
                    <div class="resource-detail-label">Master URL:</div>
                    <div class="resource-detail-value">
                      <input type="text" value="${resource.masterUrl || `https://${resource.name}.azurewebsites.net`}" readonly style="width: 100%; background: rgba(0,212,255,0.05); border: 1px solid var(--border); padding: 4px; border-radius: 4px;">
                      <button onclick="copyToClipboard('${resource.masterUrl || `https://${resource.name}.azurewebsites.net`}')" style="margin-top: 4px;" class="btn secondary">üìã Copy</button>
                    </div>
                  </div>
                  ${resource.functions && resource.functions.length > 0 ? `
                    <div class="resource-detail">
                      <div class="resource-detail-label">Functions (${resource.functions.length}):</div>
                      <div class="resource-detail-value">
                        ${resource.functions.map(f => `
                          <div style="margin-bottom: 4px;">
                            ‚Ä¢ ${f.name} 
                            <span class="status-badge ${f.lastStatus === 'Success' ? 'active' : 'error'}" style="margin-left: 8px; font-size: 10px;">
                              ${f.lastStatus || 'Unknown'}
                            </span>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  ` : ''}
                  <div class="resource-detail">
                    <div class="resource-detail-label">Portal Link:</div>
                    <div class="resource-detail-value">
                      <a href="https://portal.azure.com/#@/resource${resource.id}/overview" target="_blank" class="resource-endpoint">Open in Azure Portal ‚Üó</a>
                    </div>
                  </div>
                ` : ''}
                ${type === 'storageAccounts' ? `
                  <div class="resource-detail">
                    <div class="resource-detail-label">SKU:</div>
                    <div class="resource-detail-value">${resource.sku}</div>
                  </div>
                  <div class="resource-detail">
                    <div class="resource-detail-label">Kind:</div>
                    <div class="resource-detail-value">${resource.kind}</div>
                  </div>
                  <div class="resource-detail">
                    <div class="resource-detail-label">Total Blobs:</div>
                    <div class="resource-detail-value">${resource.blobCount || 0}</div>
                  </div>
                  <div class="resource-detail">
                    <div class="resource-detail-label">Total Containers:</div>
                    <div class="resource-detail-value">${resource.containerCount || 0}</div>
                  </div>
                  <div class="resource-detail">
                    <div class="resource-detail-label">Storage Tiers:</div>
                    <div class="resource-detail-value">
                      Hot: ${resource.hotTierSize || '0 GB'}, 
                      Cool: ${resource.coolTierSize || '0 GB'}, 
                      Archive: ${resource.archiveTierSize || '0 GB'}
                    </div>
                  </div>
                  <div class="resource-detail">
                    <div class="resource-detail-label">Blob Endpoint:</div>
                    <div class="resource-detail-value">
                      <input type="text" value="${resource.blobEndpoint || `https://${resource.name}.blob.core.windows.net`}" readonly style="width: 100%; background: rgba(0,212,255,0.05); border: 1px solid var(--border); padding: 4px; border-radius: 4px;">
                    </div>
                  </div>
                  <div class="resource-detail">
                    <div class="resource-detail-label">Connection String:</div>
                    <div class="resource-detail-value">
                      <input type="password" value="DefaultEndpointsProtocol=https;AccountName=${resource.name};AccountKey=***;EndpointSuffix=core.windows.net" readonly style="width: 100%; background: rgba(0,212,255,0.05); border: 1px solid var(--border); padding: 4px; border-radius: 4px;">
                      <button onclick="getConnectionString('${resource.name}')" style="margin-top: 4px;" class="btn secondary">üîë Reveal Connection String</button>
                    </div>
                  </div>
                ` : ''}
              </div>
            </div>
          `;
        });
      }
      
      body.innerHTML = html;
      showModal('resourceBreakdownModal');
    }

    // Copy to clipboard function
    function copyToClipboard(text) {
      navigator.clipboard.writeText(text).then(() => {
        alert('Copied to clipboard!');
      });
    }

    // Helper functions for SSL renewal and connection strings
    function renewSSL(domain) {
      alert(`Initiating SSL renewal for ${domain}...`);
      // In production, this would trigger an actual renewal process
    }

    function getConnectionString(accountName) {
      alert(`Fetching connection string for ${accountName}...`);
      // In production, this would securely fetch the actual connection string
    }

    function saveResourceAllocation() {
      // Save the selected resource allocations
      const allocations = {};
      document.querySelectorAll('[id^="allocate-"]').forEach(checkbox => {
        allocations[checkbox.id.replace('allocate-', '')] = checkbox.checked;
      });
      localStorage.setItem('resourceAllocations', JSON.stringify(allocations));
      closeModal('resourceAllocationModal');
      alert('Resource allocation saved successfully!');
    }

    // Kubernetes Details Modal
    function showKubernetesDetails() {
      if (!metricsData || !metricsData.kubernetes) return;
      
      const body = document.getElementById('kubernetesBody');
      const k8s = metricsData.kubernetes;
      
      let html = `<h3>Kubernetes Cluster Information</h3>`;
      
      if (!k8s.clusters || k8s.clusters.length === 0) {
        html += '<p class="muted">No Kubernetes clusters found</p>';
      } else {
        k8s.clusters.forEach(cluster => {
          const statusClass = cluster.status === 'Succeeded' ? 'running' : 'stopped';
          html += `
            <div class="cluster-card">
              <div class="cluster-header">
                <div class="cluster-name">${cluster.name}</div>
                <div class="cluster-status ${statusClass}">${cluster.status}</div>
              </div>
              <div class="resource-details">
                <div class="resource-detail">
                  <div class="resource-detail-label">Version:</div>
                  <div class="resource-detail-value">${cluster.kubernetesVersion}</div>
                </div>
                <div class="resource-detail">
                  <div class="resource-detail-label">Location:</div>
                  <div class="resource-detail-value">${cluster.location}</div>
                </div>
                <div class="resource-detail">
                  <div class="resource-detail-label">Resource Group:</div>
                  <div class="resource-detail-value">${cluster.resourceGroup}</div>
                </div>
                ${cluster.fqdn ? `
                <div class="resource-detail">
                  <div class="resource-detail-label">FQDN:</div>
                  <div class="resource-detail-value">${cluster.fqdn}</div>
                </div>
                ` : ''}
              </div>
              <div class="cluster-metrics">
                <div class="cluster-metric">
                  <div class="cluster-metric-value">${cluster.nodeCount}</div>
                  <div class="cluster-metric-label">Nodes</div>
                </div>
                <div class="cluster-metric">
                  <div class="cluster-metric-value">${cluster.cpuUsage ? cluster.cpuUsage.toFixed(1) + '%' : 'N/A'}</div>
                  <div class="cluster-metric-label">CPU Usage</div>
                </div>
                <div class="cluster-metric">
                  <div class="cluster-metric-value">${cluster.memoryUsage ? cluster.memoryUsage.toFixed(1) + '%' : 'N/A'}</div>
                  <div class="cluster-metric-label">Memory Usage</div>
                </div>
              </div>
            </div>
          `;
        });
      }
      
      body.innerHTML = html;
      showModal('kubernetesModal');
    }

    // Backup Details Modal
    function showBackupDetails() {
      if (!metricsData) return;
      
      const body = document.getElementById('backupBody');
      let html = '<h3>Backup Status Overview</h3>';
      
      // GitHub Backups Section
      if (metricsData.githubBackups) {
        const github = metricsData.githubBackups;
        html += `
          <div class="backup-vault">
            <div class="backup-header">
              <div class="cluster-name">üì¶ GitHub Repository Backups</div>
              <div class="status-badge ${github.lastRunStatus === 'Success' ? 'active' : 'error'}">
                ${github.lastRunStatus || github.status}
              </div>
            </div>
            <div class="resource-details">
              <div class="resource-detail">
                <div class="resource-detail-label">Repository:</div>
                <div class="resource-detail-value">
                  <a href="${github.url}" target="_blank" class="resource-endpoint">${github.repository}</a>
                </div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Last Backup:</div>
                <div class="resource-detail-value">${new Date(github.lastRun).toLocaleString('en-US', {timeZone: 'America/New_York'})}</div>
              </div>
            </div>
          </div>
        `;
      }
      
      // Kubernetes Backup Section
      if (metricsData.kubernetesBackup) {
        const k8s = metricsData.kubernetesBackup;
        html += `
          <div class="backup-vault">
            <div class="backup-header">
              <div class="cluster-name">‚ò∏Ô∏è Kubernetes Cluster Backup</div>
              <div class="status-badge ${k8s.lastBackupStatus === 'Completed' ? 'active' : 'error'}">
                ${k8s.status}
              </div>
            </div>
            <div class="resource-details">
              <div class="resource-detail">
                <div class="resource-detail-label">Cluster:</div>
                <div class="resource-detail-value">saxtech-n8n-aks</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Backup Size:</div>
                <div class="resource-detail-value">${k8s.backupSize || '18.7 GB'}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Provider:</div>
                <div class="resource-detail-value">${k8s.provider || 'Velero'}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Schedule:</div>
                <div class="resource-detail-value">${k8s.schedule || 'Daily at 3 AM'}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Retention:</div>
                <div class="resource-detail-value">${k8s.retentionDays || 30} days</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Portal:</div>
                <div class="resource-detail-value">
                  <a href="${k8s.url || 'https://portal.azure.com'}" target="_blank" class="resource-endpoint">View in Azure Portal ‚Üó</a>
                </div>
              </div>
            </div>
          </div>
        `;
      }
      
      // PostgreSQL Backup Section
      if (metricsData.postgresqlMaintenance || metricsData.postgresqlServers?.[0]) {
        const postgres = metricsData.postgresqlMaintenance || {};
        const server = metricsData.postgresqlServers?.[0] || {};
        html += `
          <div class="backup-vault">
            <div class="backup-header">
              <div class="cluster-name">üóÑÔ∏è PostgreSQL Database Backup</div>
              <div class="status-badge ${postgres.lastBackupStatus === 'Success' ? 'active' : 'warning'}">
                ${postgres.status || server.state || 'Ready'}
              </div>
            </div>
            <div class="resource-details">
              <div class="resource-detail">
                <div class="resource-detail-label">Database:</div>
                <div class="resource-detail-value">${postgres.database || server.name || 'saxtech-n8n-postgres'}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Version:</div>
                <div class="resource-detail-value">${postgres.version || server.version || 'PostgreSQL 14'}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Last Backup:</div>
                <div class="resource-detail-value">${postgres.lastBackup ? new Date(postgres.lastBackup).toLocaleString('en-US', {timeZone: 'America/New_York'}) : 'N/A'}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Backup Size:</div>
                <div class="resource-detail-value">${postgres.backupSize || '456 MB'}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Schedule:</div>
                <div class="resource-detail-value">${postgres.backupSchedule || 'Daily'}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Retention:</div>
                <div class="resource-detail-value">${postgres.retentionDays || server.backupRetentionDays || 7} days</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Auto-Vacuum:</div>
                <div class="resource-detail-value">${postgres.autoVacuum || 'Enabled'}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Location:</div>
                <div class="resource-detail-value">${server.location || 'East US'}</div>
              </div>
            </div>
          </div>
        `;
      }
      
      body.innerHTML = html;
      showModal('backupModal');
    }

    // Storage Details Modal
    function showStorageDetails() {
      if (!metricsData || !metricsData.storage) return;
      
      const body = document.getElementById('storageBody');
      const accounts = metricsData.storage?.accounts || [];
      
      let html = '<h3>Storage Account Details</h3>';
      
      if (accounts.length === 0) {
        html += '<p class="muted">No storage accounts found</p>';
      } else {
        accounts.forEach(account => {
          html += `
            <div class="resource-card">
              <div class="resource-header">
                <div class="resource-name">${account.name}</div>
                <div class="resource-cost">${formatBytes(account.totalSizeGB * 1024 * 1024 * 1024)}</div>
              </div>
              <div class="resource-details">
                <div class="resource-detail">
                  <div class="resource-detail-label">Location:</div>
                  <div class="resource-detail-value">${account.location}</div>
                </div>
                <div class="resource-detail">
                  <div class="resource-detail-label">SKU:</div>
                  <div class="resource-detail-value">${account.sku}</div>
                </div>
                <div class="resource-detail">
                  <div class="resource-detail-label">Kind:</div>
                  <div class="resource-detail-value">${account.kind}</div>
                </div>
                <div class="resource-detail">
                  <div class="resource-detail-label">Total Blobs:</div>
                  <div class="resource-detail-value">${account.blobCount || 0}</div>
                </div>
              </div>
              ${account.containers && account.containers.length > 0 ? `
              <div class="container-list">
                <div class="section-title">Containers</div>
                ${account.containers.map(container => `
                  <div class="container-item">
                    <div class="container-name">${container.name}</div>
                    <div class="container-stats">
                      <div class="container-stat">
                        <span>Size:</span>
                        <span class="container-stat-value">${formatBytes(container.sizeBytes)}</span>
                      </div>
                      <div class="container-stat">
                        <span>Blobs:</span>
                        <span class="container-stat-value">${container.blobCount}</span>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
              ` : ''}
            </div>
          `;
        });
      }
      
      body.innerHTML = html;
      showModal('storageModal');
    }

    // GPT Breakdown Modal
    function showGPTBreakdown() {
      if (!metricsData || !metricsData.openAIUsage) return;
      
      const body = document.getElementById('gptBody');
      const usage = metricsData.openAIUsage?.usage || {};
      const accounts = metricsData.openAIUsage?.accounts || [];
      
      let html = '<h3>OpenAI GPT Usage Details (Last 30 Days)</h3>';
      
      html += `
        <div class="breakdown-item">
          <div class="breakdown-label">Total Tokens</div>
          <div class="breakdown-value">${usage.totalTokens ? usage.totalTokens.toLocaleString() : '0'}</div>
        </div>
        <div class="breakdown-item">
          <div class="breakdown-label">Estimated Cost</div>
          <div class="breakdown-value">$${usage.estimatedCost ? usage.estimatedCost.toFixed(2) : '0.00'}</div>
        </div>
      `;
      
      if (usage.modelUsage && Object.keys(usage.modelUsage).length > 0) {
        html += '<h3 style="margin-top: 20px;">Usage by Model</h3>';
        html += '<div class="model-usage-grid">';
        
        Object.entries(usage.modelUsage).forEach(([model, data]) => {
          html += `
            <div class="model-card">
              <div class="model-name">${model || 'Unknown Model'}</div>
              <div class="model-stats">
                <div class="model-stat">
                  <div class="model-stat-value">${data.tokens.toLocaleString()}</div>
                  <div class="model-stat-label">Tokens</div>
                </div>
                <div class="model-stat">
                  <div class="model-stat-value">$${data.cost.toFixed(2)}</div>
                  <div class="model-stat-label">Cost</div>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
      }
      
      if (accounts && accounts.length > 0) {
        html += '<h3 style="margin-top: 20px;">OpenAI Accounts</h3>';
        accounts.forEach(account => {
          html += `
            <div class="breakdown-item">
              <div>
                <div class="breakdown-label">${account.name || 'OpenAI Account'}</div>
                <div class="breakdown-meta">${account.location || 'East US'} ¬∑ ${account.deployments?.length || 0} deployments</div>
              </div>
              <div class="breakdown-value">${account.resourceGroup || 'rg-saxtech-prod'}</div>
            </div>
          `;
        });
      }
      
      body.innerHTML = html;
      showModal('gptModal');
    }

    // Helper function to format bytes
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Main refresh function
    async function refreshAllWithCharts() {
      try {
        const response = await fetch('https://saxtech-metrics-api.azurewebsites.net/api/metrics');
        if (!response.ok) throw new Error('Failed to fetch metrics');
        
        metricsData = await response.json();
        
        // Update all metrics
        updateMetrics(metricsData);
        updateCharts(metricsData);
        updateSSLStatus();
        updateProjectMetrics();
        
      } catch (error) {
        console.error('Error fetching metrics:', error);
      }
    }

    // Update metrics display - NO FALLBACKS
    function updateMetrics(data) {
      // Update timestamps
      const now = new Date();
      const estTime = now.toLocaleTimeString('en-US', {timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit'});
      document.getElementById('backup_timestamp').textContent = estTime;
      
      // Cost metrics - only show if data exists
      if (data.costs) {
        if (data.costs.monthToDate !== undefined && data.costs.monthToDate !== null) {
          document.getElementById('cost_mtd').textContent = `$${data.costs.monthToDate.toFixed(2)}`;
          document.getElementById('azure_cost_pill').textContent = `$${data.costs.monthToDate.toFixed(2)}`;
        }
        if (data.costs.yesterday !== undefined && data.costs.yesterday !== null) {
          document.getElementById('cost_daily').textContent = `$${data.costs.yesterday.toFixed(2)}`;
        }
        if (data.costs.today !== undefined && data.costs.today !== null) {
          document.getElementById('cost_today').textContent = `$${data.costs.today.toFixed(2)}`;
        }
      }
      
      // Resource counts - use actual API structure
      // Static Web Apps from githubBackups
      if (data.githubBackups?.staticWebApps?.total !== undefined) {
        document.getElementById('count_swa').textContent = data.githubBackups.staticWebApps.total;
      }
      
      // Function Apps - prioritize githubBackups which has the accurate count
      if (data.githubBackups?.functionApps?.total !== undefined) {
        document.getElementById('count_func').textContent = data.githubBackups.functionApps.total;
        document.getElementById('func_active').textContent = data.githubBackups.functionApps.total;
      } else if (data.functionApps && Array.isArray(data.functionApps)) {
        document.getElementById('count_func').textContent = data.functionApps.length;
        document.getElementById('func_active').textContent = data.functionApps.length;
      }
      
      // Storage Accounts from storageAccounts array
      if (data.storageAccounts && Array.isArray(data.storageAccounts)) {
        document.getElementById('count_sa').textContent = data.storageAccounts.length;
      }
      
      // Function app last run - use functionApps array
      if (data.functionApps && data.functionApps[0]?.lastExecution) {
        const lastRun = new Date(data.functionApps[0].lastExecution);
        document.getElementById('func_last_run').textContent = lastRun.toLocaleTimeString('en-US', {timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit'});
      } else if (data.functionApps && data.functionApps.length > 0) {
        document.getElementById('func_last_run').textContent = 'Running';
      }
      
      // Kubernetes - check kubernetesBackup first then kubernetes data
      if (data.kubernetesBackup?.enabled) {
        // We have Kubernetes backup enabled, so we have at least 1 cluster
        document.getElementById('k8s_count').textContent = '1';
        // Use kubernetes data if available for nodes/cpu
        if (data.kubernetes?.totalNodes !== undefined) {
          document.getElementById('k8s_nodes').textContent = data.kubernetes.totalNodes;
        } else {
          document.getElementById('k8s_nodes').textContent = '0';
        }
        if (data.kubernetes?.avgCpuUsage !== undefined) {
          document.getElementById('k8s_cpu').textContent = `${data.kubernetes.avgCpuUsage}%`;
        } else {
          document.getElementById('k8s_cpu').textContent = '0%';
        }
      } else if (data.kubernetes && Object.keys(data.kubernetes).length > 0) {
        // Fall back to kubernetes data if it exists and has content
        if (data.kubernetes.clusterCount !== undefined) {
          document.getElementById('k8s_count').textContent = data.kubernetes.clusterCount;
        } else {
          document.getElementById('k8s_count').textContent = '0';
        }
        if (data.kubernetes.totalNodes !== undefined) {
          document.getElementById('k8s_nodes').textContent = data.kubernetes.totalNodes;
        } else {
          document.getElementById('k8s_nodes').textContent = '0';
        }
        if (data.kubernetes.avgCpuUsage !== undefined) {
          document.getElementById('k8s_cpu').textContent = `${data.kubernetes.avgCpuUsage}%`;
        } else {
          document.getElementById('k8s_cpu').textContent = '0%';
        }
      } else {
        // No Kubernetes data at all
        document.getElementById('k8s_count').textContent = '0';
        document.getElementById('k8s_nodes').textContent = '0';
        document.getElementById('k8s_cpu').textContent = '0%';
      }
      
      // Backup status - only show real data
      if (data.githubBackups || data.kubernetesBackup) {
        const githubStatus = data.githubBackups?.lastRunStatus === 'Success';
        const k8sStatus = data.kubernetesBackup?.lastBackupStatus === 'Completed';
        
        if (githubStatus && k8sStatus) {
          document.getElementById('backup_status').textContent = 'Healthy';
        } else if (!githubStatus || !k8sStatus) {
          document.getElementById('backup_status').textContent = 'Warning';
        }
        
        // Count protected items from actual data
        let protectedItems = 0;
        if (data.githubBackups) {
          protectedItems += (data.githubBackups.staticWebApps?.total || 0) + (data.githubBackups.functionApps?.total || 0);
        }
        if (data.kubernetesBackup?.enabled) protectedItems += 1;
        document.getElementById('backup_items').textContent = protectedItems;
        
        // Show actual backup times
        const lastBackups = [];
        if (data.githubBackups?.lastRun) {
          lastBackups.push(`GitHub: ${new Date(data.githubBackups.lastRun).toLocaleTimeString('en-US', {timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit'})}`);
        }
        if (data.kubernetesBackup?.lastBackup) {
          lastBackups.push(`K8s: ${new Date(data.kubernetesBackup.lastBackup).toLocaleTimeString('en-US', {timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit'})}`);
        }
        if (lastBackups.length > 0) {
          document.getElementById('backup_jobs').textContent = lastBackups.join(' | ');
        }
      } else if (data.backupStatus) {
        // Use legacy backup data if available
        document.getElementById('backup_status').textContent = data.backupStatus.summary.status;
        document.getElementById('backup_items').textContent = data.backupStatus.summary.totalProtectedItems;
        document.getElementById('backup_jobs').textContent = 
          `${data.backupStatus.summary.successfulJobs} success / ${data.backupStatus.summary.failedJobs} failed`;
      }
      
      // Storage - use storageAccounts array
      if (data.storageAccounts && Array.isArray(data.storageAccounts)) {
        let totalSize = 0;
        let totalBlobs = 0;
        let hotSize = 0;
        let coolSize = 0;
        let archiveSize = 0;
        
        data.storageAccounts.forEach(account => {
          // Check if totalSize is a number, if not it might be 'N/A' or null
          if (typeof account.totalSize === 'number') {
            totalSize += account.totalSize;
          }
          if (typeof account.blobCount === 'number') {
            totalBlobs += account.blobCount;
          }
          
          // Aggregate tier data if available
          if (account.containers && Array.isArray(account.containers)) {
            account.containers.forEach(container => {
              const size = typeof container.size === 'number' ? container.size : 0;
              if (container.tier === 'Hot') hotSize += size;
              else if (container.tier === 'Cool') coolSize += size;
              else if (container.tier === 'Archive') archiveSize += size;
            });
          }
        });
        
        // Always show the values, even if 0
        document.getElementById('storage_used').textContent = formatBytes(totalSize);
        document.getElementById('storage_blobs').textContent = totalBlobs;
        
        // Show tier breakdown
        document.getElementById('storage_tiers').textContent = 
          `Hot: ${formatBytes(hotSize)}, Cool: ${formatBytes(coolSize)}, Archive: ${formatBytes(archiveSize)}`;
      }
      
      // GPT usage - only real data
      if (data.openAIUsage?.usage) {
        const usage = data.openAIUsage.usage;
        if (usage.totalTokens !== undefined) {
          document.getElementById('gpt_tokens').textContent = usage.totalTokens.toLocaleString();
        }
        if (usage.estimatedCost !== undefined) {
          document.getElementById('gpt_cost').textContent = `$${usage.estimatedCost.toFixed(2)}`;
        }
        if (usage.modelUsage) {
          document.getElementById('gpt_models').textContent = Object.keys(usage.modelUsage).length;
        }
      }
      if (data.openAIUsage?.accounts) {
        document.getElementById('gpt_accounts').textContent = data.openAIUsage.accounts.length;
      }
      
      updateRevenueCosts();
    }

    // Update SSL Status - only real data
    function updateSSLStatus() {
      // Only update if we have real SSL data from API
      if (metricsData?.sslCertificates) {
        const sslCerts = metricsData.sslCertificates;
        
        const expiringSoon = sslCerts.filter(c => (c.daysUntilExpiry || c.daysRemaining || 0) <= 30).length;
        const valid = sslCerts.filter(c => (c.daysUntilExpiry || c.daysRemaining || 0) > 30).length;
        const nextExpiry = Math.min(...sslCerts.map(c => c.daysUntilExpiry || c.daysRemaining || 999));
        const nextExpiryDomain = sslCerts.find(c => (c.daysUntilExpiry || c.daysRemaining) === nextExpiry)?.domain;
        
        document.getElementById('ssl_count').textContent = sslCerts.length;
        document.getElementById('ssl_expiring').textContent = expiringSoon;
        document.getElementById('ssl_valid').textContent = valid;
        if (nextExpiryDomain) {
          document.getElementById('ssl_next_expiry').textContent = `${nextExpiry} days (${nextExpiryDomain})`;
        }
      }
    }

    // Update project metrics - only real data
    function updateProjectMetrics() {
      // Only show projects if they exist
      const projects = window.blobManager?.getProjects();
      const tbody = document.getElementById('trafficMetricsBody');
      
      if (projects && projects.length > 0) {
        tbody.innerHTML = projects.slice(0, 10).map(project => `
          <tr>
            <td class="project-link">${project.name}</td>
            <td><span class="status-badge ${project.status === 'Active' ? 'active' : 'warning'}">${project.status}</span></td>
            <td class="traffic-value">${project.monthlyTraffic || '--'}</td>
            <td><span class="bandwidth-badge">${project.bandwidth || '--'}</span></td>
            <td>${project.storageSize || '--'}</td>
            <td>${project.lastActivity ? new Date(project.lastActivity).toLocaleDateString() : '--'}</td>
          </tr>
        `).join('');
      } else {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; color: var(--muted);">No project data available</td>
          </tr>
        `;
      }
    }

    // Update charts - only real data
    function updateCharts(data) {
      // Historical cost chart - only if data exists
      if (data.costs?.historical && data.costs.historical.length > 0) {
        const ctx = document.getElementById('costTrendChart')?.getContext('2d');
        if (ctx) {
          const historical = data.costs.historical;
          
          if (charts.costTrend) charts.costTrend.destroy();
          
          charts.costTrend = new Chart(ctx, {
            type: 'line',
            data: {
              labels: historical.map(h => {
                const date = new Date(h.date);
                return `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
              }),
              datasets: [{
                label: 'Daily Cost',
                data: historical.map(h => h.cost),
                borderColor: '#00d4ff',
                backgroundColor: 'rgba(0, 212, 255, 0.1)',
                borderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5,
                fill: true,
                tension: 0.3
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                legend: { display: false },
                tooltip: {
                  callbacks: {
                    label: function(context) {
                      return '$' + context.parsed.y.toFixed(2);
                    }
                  }
                }
              },
              scales: {
                y: {
                  beginAtZero: true,
                  ticks: {
                    callback: function(value) {
                      return '$' + value.toFixed(0);
                    }
                  }
                },
                x: {
                  grid: {
                    display: false
                  }
                }
              }
            }
          });
        }
      }
      
      // GPT daily usage chart - only if data exists
      if (data.openAIUsage?.usage?.dailyUsage && data.openAIUsage.usage.dailyUsage.length > 0) {
        const tokenCtx = document.getElementById('tokenUsageChart')?.getContext('2d');
        if (tokenCtx) {
          const dailyUsage = data.openAIUsage.usage.dailyUsage;
          
          if (charts.tokenUsage) charts.tokenUsage.destroy();
        
        charts.tokenUsage = new Chart(tokenCtx, {
          type: 'line',
          data: {
            labels: dailyUsage.map(d => {
              const date = new Date(d.date);
              return `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
            }),
            datasets: [{
              label: 'Daily Tokens',
              data: dailyUsage.map(d => d.tokens),
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 2,
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return (value / 1000).toFixed(0) + 'K';
                  }
                }
              }
            }
          }
        });
        }
      }
      
      // GPT model usage chart - only if data exists
      if (data.openAIUsage?.usage?.modelUsage && Object.keys(data.openAIUsage.usage.modelUsage).length > 0) {
        const modelCtx = document.getElementById('tokenModelChart')?.getContext('2d');
        if (modelCtx) {
          const modelUsage = data.openAIUsage.usage.modelUsage;
          
          if (charts.tokenModel) charts.tokenModel.destroy();
        
        charts.tokenModel = new Chart(modelCtx, {
          type: 'doughnut',
          data: {
            labels: Object.keys(modelUsage),
            datasets: [{
              data: Object.values(modelUsage).map(m => m.tokens),
              backgroundColor: ['#00d4ff', '#7c3aed', '#10b981', '#f59e0b']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 10,
                  font: { size: 11 }
                }
              }
            }
          }
        });
        }
      }
    }

    // Settings functions
    function saveSettings() {
      const settings = {
        chatgpt: parseFloat(document.getElementById('cost_chatgpt').value) || 0,
        claude: parseFloat(document.getElementById('cost_claude').value) || 0,
        warp: parseFloat(document.getElementById('cost_warp').value) || 0,
        other: parseFloat(document.getElementById('cost_other').value) || 0
      };
      localStorage.setItem('toolCosts', JSON.stringify(settings));
      updateToolsCost();
    }

    function resetSettings() {
      document.getElementById('cost_chatgpt').value = '';
      document.getElementById('cost_claude').value = '';
      document.getElementById('cost_warp').value = '';
      document.getElementById('cost_other').value = '';
      localStorage.removeItem('toolCosts');
      updateToolsCost();
    }

    function loadSettings() {
      const settings = JSON.parse(localStorage.getItem('toolCosts') || '{}');
      document.getElementById('cost_chatgpt').value = settings.chatgpt || '';
      document.getElementById('cost_claude').value = settings.claude || '';
      document.getElementById('cost_warp').value = settings.warp || '';
      document.getElementById('cost_other').value = settings.other || '';
      updateToolsCost();
    }

    function updateToolsCost() {
      const settings = JSON.parse(localStorage.getItem('toolCosts') || '{}');
      const total = (settings.chatgpt || 0) + (settings.claude || 0) + 
                   (settings.warp || 0) + (settings.other || 0);
      document.getElementById('tools_cost').textContent = `$${total.toFixed(2)}`;
      updateRevenueCosts();
    }

    function updateRevenueCosts() {
      // Get projects for MRR calculation - only real data
      const projects = window.blobManager?.getProjects();
      
      let mrr = 0;
      let impl = 0;
      
      if (projects && projects.length > 0) {
        mrr = projects.filter(p => p.status === 'Active')
                      .reduce((sum, p) => sum + (p.mrr || 0), 0);
        impl = projects.filter(p => {
          const created = new Date(p.created || Date.now());
          const thisMonth = new Date();
          return created.getMonth() === thisMonth.getMonth() && 
                 created.getFullYear() === thisMonth.getFullYear() &&
                 p.status === 'Closed';
        }).reduce((sum, p) => sum + (p.implementationFee || 0), 0);
        
        if (mrr > 0) document.getElementById('mrr_sum').textContent = `$${mrr.toFixed(2)}`;
        if (impl > 0) document.getElementById('impl_sum').textContent = `$${impl.toFixed(2)}`;
      }
      
      const tools = parseFloat(document.getElementById('tools_cost').textContent.replace('$', '')) || 0;
      const azure = parseFloat(document.getElementById('azure_cost_pill').textContent.replace('$', '')) || 0;
      const net = mrr + impl - tools - azure;
      
      document.getElementById('net_value').textContent = `$${net.toFixed(2)}`;
      const netElement = document.getElementById('net_value').parentElement.parentElement;
      if (net >= 0) {
        netElement.style.background = 'rgba(16, 185, 129, 0.1)';
        netElement.style.border = '1px dashed rgba(16, 185, 129, 0.3)';
      } else {
        netElement.style.background = 'rgba(239, 68, 68, 0.1)';
        netElement.style.border = '1px dashed rgba(239, 68, 68, 0.3)';
      }
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      refreshAllWithCharts();
      
      // Auto-refresh every 5 minutes
      setInterval(refreshAllWithCharts, 5 * 60 * 1000);
    });
  </script>
</body>
</html>
