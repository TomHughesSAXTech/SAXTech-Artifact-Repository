<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Automation & AI Hub | Live Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;600&display=swap" rel="stylesheet" />
  <script src="chart.min.js?v=2"></script>
  <script src="chartjs-plugin-datalabels.min.js?v=2"></script>
  <script src="azure-auth-integration.js"></script>
  <style>
    :root {
      --bg: #060818; --card: #0f1729; --text: #e2e8f0; --muted: #94a3b8;
      --primary: #00d4ff; --accent: #7c3aed; --good: #10b981; --warn: #f59e0b; --bad: #ef4444;
      --border: rgba(0,212,255,0.15);
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: #060818; color: var(--text); }
    header { position: sticky; top:0; z-index: 50; backdrop-filter: blur(10px); background: rgba(6,8,24,0.75); border-bottom:1px solid var(--border); }
    .wrap { max-width: 1300px; margin: 0 auto; padding: 20px 24px; }
    .row { display:flex; align-items:center; justify-content: space-between; gap: 16px; }
    .title { font-weight: 800; font-size: 22px; letter-spacing: -0.3px; }
    .subtitle { font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: 1.6px; }
    .btn { background: linear-gradient(135deg, var(--primary), var(--accent)); color:#fff; border:0; padding:10px 14px; border-radius:10px; cursor:pointer; font-weight:600; transition: all 0.2s; }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(0,212,255,0.3); }
    .btn.secondary { background: rgba(124,58,237,0.12); color: var(--primary); border:1px solid var(--border); }
    .grid { display:grid; gap:16px; grid-template-columns: repeat(12, 1fr); margin-top: 20px; }
    .card { background: var(--card); border:1px solid var(--border); border-radius: 14px; padding: 16px; position: relative; overflow: hidden; }
    .card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 1px; background: linear-gradient(90deg, transparent, var(--primary), transparent); }
    .span-3 { grid-column: span 3; }
    .span-4 { grid-column: span 4; }
    .span-6 { grid-column: span 6; }
    .span-8 { grid-column: span 8; }
    .span-12 { grid-column: span 12; }
    .stat { display:flex; align-items: center; justify-content: space-between; }
    .stat .label { color: var(--muted); font-size: 12px; text-transform: uppercase; letter-spacing: 1px; }
    .stat .value { font-size: 28px; font-weight: 800; background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .row-col { display:flex; gap:10px; align-items:center; }
    .list { display:flex; flex-direction: column; gap:10px; }
    .kpi { display:flex; align-items:center; justify-content: space-between; padding: 10px; background: rgba(0,212,255,0.06); border: 1px dashed var(--border); border-radius:10px; }
    .muted { color: var(--muted); }
    .pill { font-size: 11px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); }
    .section-title { font-weight:700; margin-bottom:8px; }
    .settings-grid { display:grid; gap:12px; grid-template-columns: repeat(2, 1fr); }
    input[type="number"], input[type="text"] { width: 100%; padding: 12px; border-radius: 10px; border:1px solid var(--border); background: #0b1120; color: var(--text); }
    .note { font-size:12px; color: var(--muted); }
    a { color: var(--primary); text-decoration: none; }
    .chart-container { position: relative; height: 300px; width: 100%; padding: 10px 0; }
    .metrics-table { width: 100%; border-collapse: collapse; margin-top: 12px; }
    .metrics-table th { text-align: left; padding: 8px; font-size: 11px; text-transform: uppercase; letter-spacing: 1px; color: var(--muted); border-bottom: 1px solid var(--border); }
    .metrics-table td { padding: 10px 8px; border-bottom: 1px solid rgba(0,212,255,0.08); }
    .metrics-table tr:hover { background: rgba(0,212,255,0.04); }
    .project-link { color: var(--primary); font-weight: 500; cursor: pointer; }
    .traffic-value { font-weight: 600; color: var(--text); }
    .bandwidth-badge { background: rgba(124,58,237,0.12); color: var(--accent); padding: 3px 8px; border-radius: 6px; font-size: 12px; }
    .clickable { cursor: pointer; transition: all 0.2s ease; position: relative; }
    .clickable:hover { transform: translateY(-2px); filter: brightness(1.2); }
    .clickable::after { content: '‚Üó'; position: absolute; top: -8px; right: -8px; font-size: 10px; color: var(--primary); opacity: 0; transition: opacity 0.2s; }
    .clickable:hover::after { opacity: 1; }
    
    /* Enhanced Modal Styles */
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(6,8,24,0.95); backdrop-filter: blur(10px); z-index: 1000; animation: fadeIn 0.2s; }
    .modal.active { display: flex; align-items: center; justify-content: center; }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
    .modal-content { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 24px; max-width: 800px; width: 90%; max-height: 80vh; overflow-y: auto; animation: slideUp 0.3s; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; border-bottom: 1px solid var(--border); padding-bottom: 16px; }
    .modal-title { font-size: 20px; font-weight: 700; background: linear-gradient(135deg, var(--primary), var(--accent)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .modal-close { background: none; border: none; color: var(--muted); font-size: 24px; cursor: pointer; padding: 0; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; border-radius: 8px; transition: all 0.2s; }
    .modal-close:hover { background: rgba(0,212,255,0.1); color: var(--primary); }
    .modal-body { color: var(--text); }
    
    /* Breakdown Items */
    .breakdown-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: rgba(0,212,255,0.05); border: 1px solid var(--border); border-radius: 8px; margin-bottom: 8px; transition: all 0.2s; }
    .breakdown-item:hover { background: rgba(0,212,255,0.08); transform: translateX(4px); }
    .breakdown-label { color: var(--text); font-weight: 500; }
    .breakdown-value { color: var(--primary); font-weight: 600; font-family: 'JetBrains Mono', monospace; }
    .breakdown-meta { font-size: 11px; color: var(--muted); margin-top: 4px; }
    
    /* Resource Details */
    .resource-card { background: rgba(15,23,41,0.5); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .resource-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 12px; }
    .resource-name { font-weight: 600; color: var(--text); font-size: 14px; }
    .resource-cost { color: var(--good); font-weight: 600; font-family: 'JetBrains Mono', monospace; }
    .resource-details { display: grid; gap: 8px; font-size: 12px; }
    .resource-detail { display: flex; gap: 8px; }
    .resource-detail-label { color: var(--muted); min-width: 100px; }
    .resource-detail-value { color: var(--text); word-break: break-all; }
    .resource-endpoint { color: var(--primary); cursor: pointer; }
    .resource-endpoint:hover { text-decoration: underline; }
    
    /* Cluster Info */
    .cluster-card { background: rgba(15,23,41,0.5); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .cluster-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .cluster-name { font-weight: 600; color: var(--text); }
    .cluster-status { padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
    .cluster-status.running { background: rgba(16,185,129,0.2); color: var(--good); }
    .cluster-status.stopped { background: rgba(239,68,68,0.2); color: var(--bad); }
    .cluster-metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-top: 12px; }
    .cluster-metric { text-align: center; padding: 8px; background: rgba(0,212,255,0.05); border-radius: 8px; }
    .cluster-metric-value { font-size: 20px; font-weight: 700; color: var(--primary); }
    .cluster-metric-label { font-size: 10px; color: var(--muted); text-transform: uppercase; }
    
    /* Storage Container Details */
    .container-list { margin-top: 12px; }
    .container-item { background: rgba(0,212,255,0.03); border: 1px solid var(--border); border-radius: 8px; padding: 10px; margin-bottom: 8px; }
    .container-name { font-weight: 500; color: var(--text); margin-bottom: 4px; }
    .container-stats { display: flex; gap: 16px; font-size: 11px; color: var(--muted); }
    .container-stat { display: flex; gap: 4px; }
    .container-stat-value { color: var(--primary); font-weight: 600; }
    
    /* Backup Details */
    .backup-vault { background: rgba(15,23,41,0.5); border: 1px solid var(--border); border-radius: 12px; padding: 16px; margin-bottom: 12px; }
    .backup-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px; }
    .backup-jobs { margin-top: 12px; }
    .backup-job { display: flex; justify-content: space-between; padding: 8px; background: rgba(0,212,255,0.03); border-radius: 6px; margin-bottom: 6px; }
    .backup-job-status { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 600; }
    .backup-job-status.success { background: rgba(16,185,129,0.2); color: var(--good); }
    .backup-job-status.failed { background: rgba(239,68,68,0.2); color: var(--bad); }
    
    /* GPT Model Usage */
    .model-usage-grid { display: grid; gap: 12px; margin-top: 16px; }
    .model-card { background: rgba(15,23,41,0.5); border: 1px solid var(--border); border-radius: 12px; padding: 16px; }
    .model-name { font-weight: 600; color: var(--text); margin-bottom: 8px; font-size: 14px; }
    .model-stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; }
    .model-stat { padding: 8px; background: rgba(0,212,255,0.05); border-radius: 8px; text-align: center; }
    .model-stat-value { font-size: 18px; font-weight: 700; color: var(--primary); }
    .model-stat-label { font-size: 10px; color: var(--muted); text-transform: uppercase; margin-top: 4px; }
    
    /* Status Badges */
    .status-badge { display: inline-block; padding: 4px 8px; border-radius: 6px; font-size: 11px; font-weight: 600; }
    .status-badge.active { background: rgba(16,185,129,0.2); color: var(--good); }
    .status-badge.warning { background: rgba(245,158,11,0.2); color: var(--warn); }
    .status-badge.error { background: rgba(239,68,68,0.2); color: var(--bad); }
    
    @media (max-width: 900px) { 
      .span-6, .span-8, .span-4, .span-3 { grid-column: span 12; } 
      .settings-grid { grid-template-columns: 1fr; }
      .cluster-metrics { grid-template-columns: 1fr; }
      .model-stats { grid-template-columns: 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="row">
        <div>
          <div class="title">Automation & AI Hub ‚Äî Live Dashboard</div>
          <div class="subtitle">Real-time Azure metrics ¬∑ Manual tool costs</div>
        </div>
        <div class="row-col">
          <button class="btn secondary" onclick="window.location.href='index.html'">‚¨Ö Back to Hub</button>
          <button class="btn" onclick="refreshAllWithCharts()">üîÑ Refresh</button>
        </div>
      </div>
    </div>
  </header>

  <main class="wrap">
    <section class="grid">
      <!-- Cost Cards -->
      <div class="card span-3">
        <div class="stat"><div class="label">Month-to-Date Cost</div><div id="cost_mtd" class="value clickable" onclick="showCostBreakdown('mtd')">$0</div></div>
        <div class="note">Azure ‚Äî subscription 3cfb259a-f02a-484e-9ce3-d83c21fd0ddb</div>
      </div>
      <div class="card span-3">
        <div class="stat"><div class="label">Daily Cost (Yesterday)</div><div id="cost_daily" class="value clickable" onclick="showCostBreakdown('daily')">$0</div></div>
        <div class="note">EST timezone</div>
      </div>
      <div class="card span-3">
        <div class="stat"><div class="label">Static Web Apps</div><div id="count_swa" class="value clickable" onclick="showResourceBreakdown('staticSites')">0</div></div>
        <div class="note">Microsoft.Web/staticSites</div>
      </div>
      <div class="card span-3">
        <div class="stat"><div class="label">Function Apps</div><div id="count_func" class="value clickable" onclick="showResourceBreakdown('functionApps')">0</div></div>
        <div class="note">Microsoft.Web/sites (functionapp)</div>
      </div>

      <!-- Kubernetes Card -->
      <div class="card span-4">
        <div class="stat"><div class="label">Kubernetes Clusters</div><div id="k8s_count" class="value clickable" onclick="showKubernetesDetails()">0</div></div>
        <div class="kpi" style="margin-top:10px;">
          <div>Total Nodes</div>
          <div id="k8s_nodes" class="pill">0</div>
        </div>
        <div class="kpi">
          <div>Avg CPU Usage</div>
          <div id="k8s_cpu" class="pill">0%</div>
        </div>
      </div>

      <!-- Backup Status Card -->
      <div class="card span-4">
        <div class="stat"><div class="label">Backup Status</div><div id="backup_status" class="value clickable" onclick="showBackupDetails()">Checking...</div></div>
        <div class="kpi" style="margin-top:10px;">
          <div>Protected Items</div>
          <div id="backup_items" class="pill">0</div>
        </div>
        <div class="kpi">
          <div>Last 24h Jobs</div>
          <div id="backup_jobs" class="pill">0 success / 0 failed</div>
        </div>
        <div class="note" style="margin-top:8px; font-size:10px;">Last updated: <span id="backup_timestamp">--</span> EST</div>
        <div class="kpi" style="margin-top:8px;">
          <div>Last 24h Jobs</div>
          <div id="backup_jobs" class="pill">0 success / 0 failed</div>
        </div>
      </div>

      <!-- Storage Accounts Card -->
      <div class="card span-4">
        <div class="stat"><div class="label">Storage Accounts</div><div id="count_sa" class="value clickable" onclick="showStorageDetails()">0</div></div>
        <div class="kpi" style="margin-top:10px;">
          <div>Total Storage Used</div>
          <div id="storage_used" class="pill">0 B</div>
        </div>
        <div class="list" id="storage_list" style="margin-top:10px;"></div>
      </div>

      <!-- Revenue vs Costs -->
      <div class="card span-8">
        <div class="section-title">Revenue vs. Costs</div>
        <div class="list" id="rev_cost_list">
          <div class="kpi"><div>Monthly Recurring Revenue (sum of active projects)</div><div id="mrr_sum" class="pill">$0</div></div>
          <div class="kpi"><div>Implementation Fees (closed this month)</div><div id="impl_sum" class="pill">$0</div></div>
          <div class="kpi"><div>Manual Tool Costs (ChatGPT, Claude, Warp, other)</div><div id="tools_cost" class="pill">$0</div></div>
          <div class="kpi"><div>Azure Month-to-Date Cost</div><div id="azure_cost_pill" class="pill">$0</div></div>
          <div class="kpi"><div>Net (MRR + Impl - Tools - Azure)</div><div id="net_value" class="pill">$0</div></div>
        </div>
      </div>

      <!-- GPT Usage Summary -->
      <div class="card span-4">
        <div class="stat"><div class="label">GPT Total Tokens (30d)</div><div id="gpt_tokens" class="value clickable" onclick="showGPTBreakdown()">0</div></div>
        <div class="kpi" style="margin-top:10px;">
          <div>Estimated Cost</div>
          <div id="gpt_cost" class="pill">$0</div>
        </div>
        <div class="kpi">
          <div>Models Active</div>
          <div id="gpt_models" class="pill">0</div>
        </div>
      </div>

      <!-- Historical Cost Chart -->
      <div class="card span-12">
        <div class="section-title">Historical Cost Trending ‚Äî Last 30 Days</div>
        <div class="chart-container">
          <canvas id="costTrendChart"></canvas>
        </div>
        <div class="note">Shows daily Azure costs for the past 30 days. Data refreshes automatically.</div>
      </div>

      <!-- GPT Token Charts -->
      <div class="card span-6">
        <div class="section-title">GPT Token Usage ‚Äî Daily Trend</div>
        <div class="chart-container">
          <canvas id="tokenUsageChart"></canvas>
        </div>
        <div class="note">OpenAI API token consumption over the last 7 days</div>
      </div>

      <div class="card span-6">
        <div class="section-title">GPT Token Usage ‚Äî By Model</div>
        <div class="chart-container">
          <canvas id="tokenModelChart"></canvas>
        </div>
        <div class="note">Token distribution across different GPT models</div>
      </div>

      <!-- Project Traffic Table -->
      <div class="card span-12">
        <div class="section-title">Project Traffic & Bandwidth Metrics</div>
        <table class="metrics-table" id="trafficMetricsTable">
          <thead>
            <tr>
              <th>Project</th>
              <th>Status</th>
              <th>Monthly Traffic</th>
              <th>Bandwidth Used</th>
              <th>Storage Size</th>
              <th>Last Activity</th>
            </tr>
          </thead>
          <tbody id="trafficMetricsBody">
            <tr>
              <td colspan="6" style="text-align: center; color: var(--muted);">Loading metrics...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Settings -->
      <div class="card span-12">
        <div class="section-title">Settings ‚Äî Manual Tool Costs</div>
        <div class="settings-grid">
          <div>
            <label>ChatGPT Monthly ($)</label>
            <input type="number" id="cost_chatgpt" min="0" step="0.01" />
          </div>
          <div>
            <label>Claude Monthly ($)</label>
            <input type="number" id="cost_claude" min="0" step="0.01" />
          </div>
          <div>
            <label>Warp Monthly ($)</label>
            <input type="number" id="cost_warp" min="0" step="0.01" />
          </div>
          <div>
            <label>Other Tools Monthly ($)</label>
            <input type="number" id="cost_other" min="0" step="0.01" />
          </div>
        </div>
        <div class="row" style="margin-top:12px;">
          <div class="note">Only manual entries here. All Azure metrics are live from your subscription.</div>
          <div>
            <button class="btn secondary" onclick="resetSettings()">Reset</button>
            <button class="btn" onclick="saveSettings()">Save</button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modals -->
  <div id="costBreakdownModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Cost Breakdown</h2>
        <button class="modal-close" onclick="closeModal('costBreakdownModal')">√ó</button>
      </div>
      <div class="modal-body" id="costBreakdownBody"></div>
    </div>
  </div>

  <div id="resourceBreakdownModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Resource Details</h2>
        <button class="modal-close" onclick="closeModal('resourceBreakdownModal')">√ó</button>
      </div>
      <div class="modal-body" id="resourceBreakdownBody"></div>
    </div>
  </div>

  <div id="kubernetesModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Kubernetes Clusters</h2>
        <button class="modal-close" onclick="closeModal('kubernetesModal')">√ó</button>
      </div>
      <div class="modal-body" id="kubernetesBody"></div>
    </div>
  </div>

  <div id="backupModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Backup Status Details</h2>
        <button class="modal-close" onclick="closeModal('backupModal')">√ó</button>
      </div>
      <div class="modal-body" id="backupBody"></div>
    </div>
  </div>

  <div id="storageModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">Storage Account Details</h2>
        <button class="modal-close" onclick="closeModal('storageModal')">√ó</button>
      </div>
      <div class="modal-body" id="storageBody"></div>
    </div>
  </div>

  <div id="gptModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 class="modal-title">GPT Usage Breakdown</h2>
        <button class="modal-close" onclick="closeModal('gptModal')">√ó</button>
      </div>
      <div class="modal-body" id="gptBody"></div>
    </div>
  </div>

  <script>
    // Global data storage
    let metricsData = null;
    let charts = {};

    // Modal functions
    function showModal(modalId) {
      document.getElementById(modalId).classList.add('active');
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.remove('active');
    }

    // Close modal on ESC key
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        document.querySelectorAll('.modal.active').forEach(modal => {
          modal.classList.remove('active');
        });
      }
    });

    // Cost Breakdown Modal
    function showCostBreakdown(type) {
      if (!metricsData || !metricsData.costs) return;
      
      const body = document.getElementById('costBreakdownBody');
      let html = '';
      
      if (type === 'mtd') {
        html = '<h3>Month-to-Date Cost Breakdown by Service</h3>';
        const breakdown = metricsData.costs.costBreakdown || {};
        const sorted = Object.entries(breakdown).sort((a, b) => b[1] - a[1]);
        
        sorted.forEach(([service, cost]) => {
          const percentage = ((cost / metricsData.costs.monthToDate) * 100).toFixed(1);
          html += `
            <div class="breakdown-item">
              <div>
                <div class="breakdown-label">${service}</div>
                <div class="breakdown-meta">${percentage}% of total</div>
              </div>
              <div class="breakdown-value">$${cost.toFixed(2)}</div>
            </div>
          `;
        });
        
        // Add top resources by cost
        if (metricsData.costs.resourceCosts && metricsData.costs.resourceCosts.length > 0) {
          html += '<h3 style="margin-top: 20px;">Top Resources by Cost</h3>';
          metricsData.costs.resourceCosts.slice(0, 10).forEach(resource => {
            html += `
              <div class="breakdown-item">
                <div>
                  <div class="breakdown-label">${resource.name}</div>
                  <div class="breakdown-meta">${resource.service}</div>
                </div>
                <div class="breakdown-value">$${resource.totalCost.toFixed(2)}</div>
              </div>
            `;
          });
        }
      } else {
        // Yesterday's detailed breakdown
        html = '<h3>Yesterday\'s Cost Details</h3>';
        html += `
          <div class="breakdown-item">
            <div class="breakdown-label">Total Cost</div>
            <div class="breakdown-value">$${metricsData.costs.yesterday.toFixed(2)}</div>
          </div>
        `;
        
        // Service breakdown for yesterday
        if (metricsData.costs.yesterdayDetails && metricsData.costs.yesterdayDetails.services) {
          html += '<h3 style="margin-top: 20px;">Breakdown by Service</h3>';
          const services = metricsData.costs.yesterdayDetails.services;
          const sorted = Object.entries(services).sort((a, b) => b[1] - a[1]);
          
          sorted.forEach(([service, cost]) => {
            if (cost > 0) {
              html += `
                <div class="breakdown-item">
                  <div class="breakdown-label">${service}</div>
                  <div class="breakdown-value">$${cost.toFixed(2)}</div>
                </div>
              `;
            }
          });
        }
        
        // Resource breakdown for yesterday
        if (metricsData.costs.yesterdayDetails && metricsData.costs.yesterdayDetails.resources && 
            metricsData.costs.yesterdayDetails.resources.length > 0) {
          html += '<h3 style="margin-top: 20px;">Resources Used Yesterday</h3>';
          metricsData.costs.yesterdayDetails.resources.slice(0, 20).forEach(resource => {
            html += `
              <div class="breakdown-item">
                <div>
                  <div class="breakdown-label">${resource.name}</div>
                  <div class="breakdown-meta">${resource.service}</div>
                </div>
                <div class="breakdown-value">$${resource.cost.toFixed(2)}</div>
              </div>
            `;
          });
        }
      }
      
      body.innerHTML = html;
      showModal('costBreakdownModal');
    }

    // Resource Breakdown Modal
    function showResourceBreakdown(type) {
      if (!metricsData || !metricsData.resourceDetails) return;
      
      const body = document.getElementById('resourceBreakdownBody');
      const resources = metricsData.resourceDetails[type] || [];
      
      let html = `<h3>${type === 'staticSites' ? 'Static Web Apps' : type === 'functionApps' ? 'Function Apps' : 'Storage Accounts'}</h3>`;
      
      if (resources.length === 0) {
        html += '<p class="muted">No resources found</p>';
      } else {
        resources.forEach(resource => {
          // Calculate monthly cost for Static Web Apps
          let monthlyCost = 0;
          if (type === 'staticSites') {
            monthlyCost = resource.sku === 'Standard' ? 9.00 : 0;
          }
          
          html += `
            <div class="resource-card">
              <div class="resource-header">
                <div class="resource-name">${resource.name}</div>
                <div class="resource-cost">
                  ${type === 'staticSites' ? `
                    <span class="status-badge ${resource.sku === 'Standard' ? 'warning' : 'active'}">${resource.sku || 'Free'}</span>
                    ${monthlyCost > 0 ? `<span style="margin-left: 8px;">$${monthlyCost.toFixed(2)}/mo</span>` : ''}
                  ` : type === 'functionApps' ? `
                    <span class="status-badge active">${resource.osType || 'Windows'}</span>
                  ` : ''}
                </div>
              </div>
              <div class="resource-details">
                <div class="resource-detail">
                  <div class="resource-detail-label">Location:</div>
                  <div class="resource-detail-value">${resource.location}</div>
                </div>
                <div class="resource-detail">
                  <div class="resource-detail-label">Resource Group:</div>
                  <div class="resource-detail-value">${resource.resourceGroup}</div>
                </div>
                <div class="resource-detail">
                  <div class="resource-detail-label">Endpoint:</div>
                  <div class="resource-detail-value">
                    <a href="${resource.endpoint}" target="_blank" class="resource-endpoint">${resource.endpoint}</a>
                  </div>
                </div>
                ${resource.customDomains && resource.customDomains.length > 0 ? `
                <div class="resource-detail">
                  <div class="resource-detail-label">Custom Domains:</div>
                  <div class="resource-detail-value">
                    ${resource.customDomains.map(domain => 
                      `<a href="https://${domain}" target="_blank" class="resource-endpoint">${domain}</a>`
                    ).join('<br>')}
                  </div>
                </div>
                ` : ''}
                ${type === 'functionApps' ? `
                <div class="resource-detail">
                  <div class="resource-detail-label">Runtime:</div>
                  <div class="resource-detail-value">${resource.runtime || 'N/A'}</div>
                </div>
                <div class="resource-detail">
                  <div class="resource-detail-label">Functions:</div>
                  <div class="resource-detail-value">
                    ${resource.functionCount || 0} function(s)
                    ${resource.functions && resource.functions.length > 0 ? 
                      '<br>' + resource.functions.map(f => `‚Ä¢ ${f.name}`).join('<br>') : 
                      ''}
                  </div>
                </div>
                ` : ''}
                ${resource.createdTime ? `
                <div class="resource-detail">
                  <div class="resource-detail-label">Created:</div>
                  <div class="resource-detail-value">${new Date(resource.createdTime).toLocaleDateString()}</div>
                </div>
                ` : ''}
                ${resource.state ? `
                <div class="resource-detail">
                  <div class="resource-detail-label">State:</div>
                  <div class="resource-detail-value">
                    <span class="status-badge ${resource.state === 'Running' ? 'active' : 'warning'}">${resource.state}</span>
                  </div>
                </div>
                ` : ''}
              </div>
            </div>
          `;
        });
      }
      
      body.innerHTML = html;
      showModal('resourceBreakdownModal');
    }

    // Kubernetes Details Modal
    function showKubernetesDetails() {
      if (!metricsData || !metricsData.kubernetes) return;
      
      const body = document.getElementById('kubernetesBody');
      const k8s = metricsData.kubernetes;
      
      let html = `<h3>Kubernetes Cluster Information</h3>`;
      
      if (k8s.clusters.length === 0) {
        html += '<p class="muted">No Kubernetes clusters found</p>';
      } else {
        k8s.clusters.forEach(cluster => {
          const statusClass = cluster.status === 'Succeeded' ? 'running' : 'stopped';
          html += `
            <div class="cluster-card">
              <div class="cluster-header">
                <div class="cluster-name">${cluster.name}</div>
                <div class="cluster-status ${statusClass}">${cluster.status}</div>
              </div>
              <div class="resource-details">
                <div class="resource-detail">
                  <div class="resource-detail-label">Version:</div>
                  <div class="resource-detail-value">${cluster.kubernetesVersion}</div>
                </div>
                <div class="resource-detail">
                  <div class="resource-detail-label">Location:</div>
                  <div class="resource-detail-value">${cluster.location}</div>
                </div>
                <div class="resource-detail">
                  <div class="resource-detail-label">Resource Group:</div>
                  <div class="resource-detail-value">${cluster.resourceGroup}</div>
                </div>
                ${cluster.fqdn ? `
                <div class="resource-detail">
                  <div class="resource-detail-label">FQDN:</div>
                  <div class="resource-detail-value">${cluster.fqdn}</div>
                </div>
                ` : ''}
              </div>
              <div class="cluster-metrics">
                <div class="cluster-metric">
                  <div class="cluster-metric-value">${cluster.nodeCount}</div>
                  <div class="cluster-metric-label">Nodes</div>
                </div>
                <div class="cluster-metric">
                  <div class="cluster-metric-value">${cluster.cpuUsage ? cluster.cpuUsage.toFixed(1) + '%' : 'N/A'}</div>
                  <div class="cluster-metric-label">CPU Usage</div>
                </div>
                <div class="cluster-metric">
                  <div class="cluster-metric-value">${cluster.memoryUsage ? cluster.memoryUsage.toFixed(1) + '%' : 'N/A'}</div>
                  <div class="cluster-metric-label">Memory Usage</div>
                </div>
              </div>
            </div>
          `;
        });
      }
      
      body.innerHTML = html;
      showModal('kubernetesModal');
    }

    // Backup Details Modal - Enhanced with new metrics
    function showBackupDetails() {
      if (!metricsData) return;
      
      const body = document.getElementById('backupBody');
      let html = '<h3>Backup Status Overview</h3>';
      
      // GitHub Backups Section
      if (metricsData.githubBackups) {
        const github = metricsData.githubBackups;
        html += `
          <div class="backup-vault">
            <div class="backup-header">
              <div class="cluster-name">üì¶ GitHub Repository Backups</div>
              <div class="status-badge ${github.lastRunStatus === 'Success' ? 'active' : 'error'}">
                ${github.lastRunStatus || github.status}
              </div>
            </div>
            <div class="resource-details">
              <div class="resource-detail">
                <div class="resource-detail-label">Repository:</div>
                <div class="resource-detail-value">
                  <a href="${github.url}" target="_blank" class="resource-endpoint">${github.repository}</a>
                </div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Last Backup:</div>
                <div class="resource-detail-value">${new Date(github.lastRun).toLocaleString('en-US', {timeZone: 'America/New_York'})}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Static Web Apps:</div>
                <div class="resource-detail-value">${github.staticWebApps?.backed || 0} / ${github.staticWebApps?.total || 0}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Function Apps:</div>
                <div class="resource-detail-value">${github.functionApps?.backed || 0} / ${github.functionApps?.total || 0}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Total Size:</div>
                <div class="resource-detail-value">${github.totalBackupSize || 'N/A'}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Schedule:</div>
                <div class="resource-detail-value">${github.backupFrequency || 'Daily'}</div>
              </div>
            </div>
          </div>
        `;
      }
      
      // Kubernetes Backup Section
      if (metricsData.kubernetesBackup) {
        const k8s = metricsData.kubernetesBackup;
        html += `
          <div class="backup-vault">
            <div class="backup-header">
              <div class="cluster-name">‚ò∏Ô∏è Kubernetes Cluster Backup</div>
              <div class="status-badge ${k8s.lastBackupStatus === 'Completed' ? 'active' : 'error'}">
                ${k8s.status}
              </div>
            </div>
            <div class="resource-details">
              <div class="resource-detail">
                <div class="resource-detail-label">Provider:</div>
                <div class="resource-detail-value">${k8s.provider}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Portal:</div>
                <div class="resource-detail-value">
                  <a href="${k8s.url}" target="_blank" class="resource-endpoint">View in Azure Portal ‚Üó</a>
                </div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Last Backup:</div>
                <div class="resource-detail-value">${new Date(k8s.lastBackup).toLocaleString('en-US', {timeZone: 'America/New_York'})}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Status:</div>
                <div class="resource-detail-value">${k8s.lastBackupStatus}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Backup Size:</div>
                <div class="resource-detail-value">${k8s.backupSize}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Total Backups:</div>
                <div class="resource-detail-value">${k8s.totalBackups}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Retention:</div>
                <div class="resource-detail-value">${k8s.retentionDays} days</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Namespaces:</div>
                <div class="resource-detail-value">${k8s.namespaces?.join(', ') || 'All'}</div>
              </div>
            </div>
          </div>
        `;
      }
      
      // PostgreSQL Maintenance Section  
      if (metricsData.postgresqlMaintenance) {
        const pg = metricsData.postgresqlMaintenance;
        html += `
          <div class="backup-vault">
            <div class="backup-header">
              <div class="cluster-name">üêò PostgreSQL Maintenance</div>
              <div class="status-badge ${pg.lastMaintenanceStatus === 'Success' ? 'active' : 'error'}">
                ${pg.status}
              </div>
            </div>
            <div class="resource-details">
              <div class="resource-detail">
                <div class="resource-detail-label">Database:</div>
                <div class="resource-detail-value">${pg.database}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Version:</div>
                <div class="resource-detail-value">${pg.version}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Last Maintenance:</div>
                <div class="resource-detail-value">${new Date(pg.lastMaintenance).toLocaleString('en-US', {timeZone: 'America/New_York'})}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Maintenance Status:</div>
                <div class="resource-detail-value">${pg.lastMaintenanceStatus}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Last Backup:</div>
                <div class="resource-detail-value">${new Date(pg.lastBackup).toLocaleString('en-US', {timeZone: 'America/New_York'})}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Backup Status:</div>
                <div class="resource-detail-value">${pg.lastBackupStatus}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Backup Size:</div>
                <div class="resource-detail-value">${pg.backupSize}</div>
              </div>
              <div class="resource-detail">
                <div class="resource-detail-label">Maintenance Window:</div>
                <div class="resource-detail-value">${pg.maintenanceWindow}</div>
              </div>
            </div>
          </div>
        `;
      }
      
      // Legacy backup data fallback
      if (metricsData.backupStatus) {
        const backup = metricsData.backupStatus;
      
      let html = `<h3>Backup Status Overview</h3>`;
      html += `
        <div class="breakdown-item">
          <div class="breakdown-label">Total Vaults</div>
          <div class="breakdown-value">${backup.summary.totalVaults}</div>
        </div>
        <div class="breakdown-item">
          <div class="breakdown-label">Protected Items</div>
          <div class="breakdown-value">${backup.summary.totalProtectedItems}</div>
        </div>
        <div class="breakdown-item">
          <div class="breakdown-label">Successful Jobs (24h)</div>
          <div class="breakdown-value">${backup.summary.successfulJobs}</div>
        </div>
        <div class="breakdown-item">
          <div class="breakdown-label">Failed Jobs (24h)</div>
          <div class="breakdown-value">${backup.summary.failedJobs}</div>
        </div>
      `;
      
      if (backup.vaults && backup.vaults.length > 0) {
        html += '<h3 style="margin-top: 20px;">Backup Vaults</h3>';
        backup.vaults.forEach(vault => {
          html += `
            <div class="backup-vault">
              <div class="backup-header">
                <div class="cluster-name">${vault.name}</div>
                <div class="muted">${vault.location}</div>
              </div>
              <div class="resource-details">
                <div class="resource-detail">
                  <div class="resource-detail-label">Protected Items:</div>
                  <div class="resource-detail-value">${vault.protectedItems.length}</div>
                </div>
                <div class="resource-detail">
                  <div class="resource-detail-label">Recent Jobs:</div>
                  <div class="resource-detail-value">${vault.jobs.length}</div>
                </div>
              </div>
              ${vault.jobs.length > 0 ? `
              <div class="backup-jobs">
                ${vault.jobs.slice(0, 5).map(job => `
                  <div class="backup-job">
                    <div>${job.operation || 'Backup'}</div>
                    <div class="backup-job-status ${job.status === 'Completed' ? 'success' : 'failed'}">${job.status}</div>
                  </div>
                `).join('')}
              </div>
              ` : ''}
            </div>
          `;
        });
      }
      }
      
      body.innerHTML = html;
      showModal('backupModal');
    }

    // Storage Details Modal
    function showStorageDetails() {
      if (!metricsData || !metricsData.storage) return;
      
      const body = document.getElementById('storageBody');
      const accounts = metricsData.storage.accounts || [];
      
      let html = '<h3>Storage Account Details</h3>';
      
      if (accounts.length === 0) {
        html += '<p class="muted">No storage accounts found</p>';
      } else {
        accounts.forEach(account => {
          html += `
            <div class="resource-card">
              <div class="resource-header">
                <div class="resource-name">${account.name}</div>
                <div class="resource-cost">${formatBytes(account.totalSizeGB * 1024 * 1024 * 1024)}</div>
              </div>
              <div class="resource-details">
                <div class="resource-detail">
                  <div class="resource-detail-label">Location:</div>
                  <div class="resource-detail-value">${account.location}</div>
                </div>
                <div class="resource-detail">
                  <div class="resource-detail-label">SKU:</div>
                  <div class="resource-detail-value">${account.sku}</div>
                </div>
                <div class="resource-detail">
                  <div class="resource-detail-label">Kind:</div>
                  <div class="resource-detail-value">${account.kind}</div>
                </div>
                <div class="resource-detail">
                  <div class="resource-detail-label">Total Blobs:</div>
                  <div class="resource-detail-value">${account.blobCount}</div>
                </div>
              </div>
              ${account.containers && account.containers.length > 0 ? `
              <div class="container-list">
                <div class="section-title">Containers</div>
                ${account.containers.map(container => `
                  <div class="container-item">
                    <div class="container-name">${container.name}</div>
                    <div class="container-stats">
                      <div class="container-stat">
                        <span>Size:</span>
                        <span class="container-stat-value">${formatBytes(container.sizeBytes)}</span>
                      </div>
                      <div class="container-stat">
                        <span>Blobs:</span>
                        <span class="container-stat-value">${container.blobCount}</span>
                      </div>
                      <div class="container-stat">
                        <span>Access:</span>
                        <span class="container-stat-value">${container.publicAccess}</span>
                      </div>
                    </div>
                  </div>
                `).join('')}
              </div>
              ` : ''}
            </div>
          `;
        });
      }
      
      body.innerHTML = html;
      showModal('storageModal');
    }

    // GPT Breakdown Modal
    function showGPTBreakdown() {
      if (!metricsData || !metricsData.openAIUsage) return;
      
      const body = document.getElementById('gptBody');
      const usage = metricsData.openAIUsage;
      
      let html = '<h3>OpenAI GPT Usage Details (Last 30 Days)</h3>';
      
      html += `
        <div class="breakdown-item">
          <div class="breakdown-label">Total Tokens</div>
          <div class="breakdown-value">${usage.totalTokens.toLocaleString()}</div>
        </div>
        <div class="breakdown-item">
          <div class="breakdown-label">Estimated Cost</div>
          <div class="breakdown-value">$${usage.estimatedCost.toFixed(2)}</div>
        </div>
      `;
      
      if (usage.modelUsage && Object.keys(usage.modelUsage).length > 0) {
        html += '<h3 style="margin-top: 20px;">Usage by Model</h3>';
        html += '<div class="model-usage-grid">';
        
        Object.entries(usage.modelUsage).forEach(([model, data]) => {
          html += `
            <div class="model-card">
              <div class="model-name">${model || 'Unknown Model'}</div>
              <div class="model-stats">
                <div class="model-stat">
                  <div class="model-stat-value">${data.tokens.toLocaleString()}</div>
                  <div class="model-stat-label">Tokens</div>
                </div>
                <div class="model-stat">
                  <div class="model-stat-value">$${data.cost.toFixed(2)}</div>
                  <div class="model-stat-label">Cost</div>
                </div>
              </div>
            </div>
          `;
        });
        html += '</div>';
      }
      
      if (usage.accounts && usage.accounts.length > 0) {
        html += '<h3 style="margin-top: 20px;">OpenAI Accounts</h3>';
        usage.accounts.forEach(account => {
          html += `
            <div class="breakdown-item">
              <div>
                <div class="breakdown-label">${account.name}</div>
                <div class="breakdown-meta">${account.location} ¬∑ ${account.deployments.length} deployments</div>
              </div>
              <div class="breakdown-value">${account.resourceGroup}</div>
            </div>
          `;
        });
      }
      
      body.innerHTML = html;
      showModal('gptModal');
    }

    // Helper function to format bytes
    function formatBytes(bytes) {
      if (bytes === 0) return '0 B';
      const k = 1024;
      const sizes = ['B', 'KB', 'MB', 'GB', 'TB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Main refresh function
    async function refreshAllWithCharts() {
      try {
        const response = await fetch('https://saxtech-metrics-api.azurewebsites.net/api/metrics');
        if (!response.ok) throw new Error('Failed to fetch metrics');
        
        metricsData = await response.json();
        
        // Update all metrics
        updateMetrics(metricsData);
        updateCharts(metricsData);
        
      } catch (error) {
        console.error('Error fetching metrics:', error);
      }
    }

    // Update metrics display
    function updateMetrics(data) {
      // Cost metrics - handle null values
      if (data.costs && data.costs.monthToDate !== null && data.costs.monthToDate !== undefined) {
        document.getElementById('cost_mtd').textContent = `$${data.costs.monthToDate.toFixed(2)}`;
        document.getElementById('azure_cost_pill').textContent = `$${data.costs.monthToDate.toFixed(2)}`;
      } else {
        document.getElementById('cost_mtd').textContent = '$0.00';
        document.getElementById('azure_cost_pill').textContent = '$0.00';
      }
      
      if (data.costs && data.costs.yesterday !== null && data.costs.yesterday !== undefined) {
        document.getElementById('cost_daily').textContent = `$${data.costs.yesterday.toFixed(2)}`;
      } else {
        document.getElementById('cost_daily').textContent = '$0.00';
      }
      
      // Resource counts
      if (data.resources) {
        document.getElementById('count_swa').textContent = data.resources.staticSites || 0;
        document.getElementById('count_func').textContent = data.resources.functionApps || 0;
        document.getElementById('count_sa').textContent = data.resources.storageAccounts || 0;
      }
      
      // Kubernetes - display full details
      if (data.kubernetes && data.kubernetes.clusterCount > 0) {
        document.getElementById('k8s_count').textContent = data.kubernetes.clusterCount || 0;
        document.getElementById('k8s_nodes').textContent = data.kubernetes.totalNodes || 0;
        document.getElementById('k8s_cpu').textContent = `${data.kubernetes.avgCpuUsage || 0}%`;
        
        // Display first cluster details if available
        if (data.kubernetes.clusters && data.kubernetes.clusters.length > 0) {
          const cluster = data.kubernetes.clusters[0];
          // Update the Kubernetes card with more info
          const k8sCard = document.querySelector('.metric-card:has(#k8s_count)');
          if (k8sCard) {
            const existingInfo = k8sCard.querySelector('.cluster-info');
            if (existingInfo) {
              existingInfo.remove();
            }
            const clusterInfo = document.createElement('div');
            clusterInfo.className = 'cluster-info';
            clusterInfo.style.cssText = 'margin-top: 10px; font-size: 12px; color: #94a3b8;';
            clusterInfo.innerHTML = `
              <div>Cluster: ${cluster.name}</div>
              <div>Version: ${cluster.kubernetesVersion}</div>
              <div>Memory: ${cluster.memoryUsage ? cluster.memoryUsage.toFixed(1) + '%' : 'N/A'}</div>
            `;
            k8sCard.appendChild(clusterInfo);
          }
        }
      } else {
        document.getElementById('k8s_count').textContent = '0';
        document.getElementById('k8s_nodes').textContent = '0';
        document.getElementById('k8s_cpu').textContent = '0%';
      }
      
    // Backup status - using new enhanced metrics structure
    if (data.githubBackups || data.kubernetesBackup || data.postgresqlMaintenance) {
      // Determine overall backup status
      const githubStatus = data.githubBackups?.lastRunStatus === 'Success';
      const k8sStatus = data.kubernetesBackup?.lastBackupStatus === 'Completed';
      const pgStatus = data.postgresqlMaintenance?.lastBackupStatus === 'Success';
      
      const allGood = githubStatus && k8sStatus && pgStatus;
      const anyFailed = !githubStatus || !k8sStatus || !pgStatus;
      
      const statusEl = document.getElementById('backup_status');
      statusEl.textContent = allGood ? 'Healthy' : anyFailed ? 'Warning' : 'Active';
      statusEl.className = `value clickable ${allGood ? 'status-good' : anyFailed ? 'status-warn' : ''}`;
      
      // Count protected items
      let protectedItems = 0;
      if (data.githubBackups) {
        protectedItems += (data.githubBackups.staticWebApps?.total || 0) + (data.githubBackups.functionApps?.total || 0);
      }
      if (data.kubernetesBackup?.enabled) protectedItems += 1;
      if (data.postgresqlMaintenance) protectedItems += 1;
      
      document.getElementById('backup_items').textContent = protectedItems;
      
      // Show last backup times
      const lastBackups = [];
      if (data.githubBackups?.lastRun) {
        lastBackups.push(`GitHub: ${new Date(data.githubBackups.lastRun).toLocaleTimeString('en-US', {timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit'})}`);
      }
      if (data.kubernetesBackup?.lastBackup) {
        lastBackups.push(`K8s: ${new Date(data.kubernetesBackup.lastBackup).toLocaleTimeString('en-US', {timeZone: 'America/New_York', hour: '2-digit', minute: '2-digit'})}`);
      }
      document.getElementById('backup_jobs').textContent = lastBackups.join(' | ') || 'No recent backups';
    } else if (data.backupStatus) {
      // Fallback to old structure if available
      document.getElementById('backup_status').textContent = data.backupStatus.summary.status;
      document.getElementById('backup_items').textContent = data.backupStatus.summary.totalProtectedItems;
      document.getElementById('backup_jobs').textContent = 
        `${data.backupStatus.summary.successfulJobs} success / ${data.backupStatus.summary.failedJobs} failed`;
    }
      
      // Storage
      if (data.storage) {
        let totalSize = 0;
        const storageList = document.getElementById('storage_list');
        storageList.innerHTML = '';
        
        data.storage.accounts.forEach(account => {
          totalSize += account.totalSizeGB * 1024 * 1024 * 1024;
          const div = document.createElement('div');
          div.className = 'kpi';
          div.innerHTML = `
            <div>${account.name}</div>
            <div class="pill">${formatBytes(account.totalSizeGB * 1024 * 1024 * 1024)}</div>
          `;
          storageList.appendChild(div);
        });
        
        document.getElementById('storage_used').textContent = formatBytes(totalSize);
      }
      
      // GPT usage
      if (data.openAIUsage) {
        document.getElementById('gpt_tokens').textContent = data.openAIUsage.totalTokens.toLocaleString();
        document.getElementById('gpt_cost').textContent = `$${data.openAIUsage.estimatedCost.toFixed(2)}`;
        document.getElementById('gpt_models').textContent = Object.keys(data.openAIUsage.modelUsage || {}).length;
      }
    }

    // Update charts
    function updateCharts(data) {
      // Historical cost chart with trend line
      if (data.costs && data.costs.historical) {
        const ctx = document.getElementById('costTrendChart').getContext('2d');
        const historical = data.costs.historical.slice(-30);
        
        // Calculate trend line using linear regression
        const calculateTrendLine = (data) => {
          const n = data.length;
          let sumX = 0, sumY = 0, sumXY = 0, sumX2 = 0;
          
          data.forEach((point, i) => {
            sumX += i;
            sumY += point.cost;
            sumXY += i * point.cost;
            sumX2 += i * i;
          });
          
          const slope = (n * sumXY - sumX * sumY) / (n * sumX2 - sumX * sumX);
          const intercept = (sumY - slope * sumX) / n;
          
          return data.map((_, i) => slope * i + intercept);
        };
        
        const trendData = calculateTrendLine(historical);
        
        if (charts.costTrend) charts.costTrend.destroy();
        
        charts.costTrend = new Chart(ctx, {
          type: 'line',
          data: {
            labels: historical.map(h => {
              const dateStr = h.date.toString();
              const year = dateStr.substring(0, 4);
              const month = dateStr.substring(4, 6);
              const day = dateStr.substring(6, 8);
              return `${month}/${day}`;
            }),
            datasets: [
              {
                label: 'Daily Cost',
                data: historical.map(h => h.cost),
                borderColor: '#00d4ff',
                backgroundColor: 'rgba(0, 212, 255, 0.1)',
                borderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5,
                fill: true,
                tension: 0.1
              },
              {
                label: 'Trend',
                data: trendData,
                borderColor: '#7c3aed',
                borderWidth: 2,
                borderDash: [5, 5],
                pointRadius: 0,
                fill: false,
                tension: 0
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
              mode: 'index',
              intersect: false
            },
            plugins: {
              legend: { 
                display: true,
                position: 'top',
                labels: {
                  usePointStyle: true,
                  padding: 10
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    let label = context.dataset.label || '';
                    if (label) {
                      label += ': ';
                    }
                    label += '$' + context.parsed.y.toFixed(2);
                    return label;
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    return '$' + value.toFixed(0);
                  }
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }
      
      // GPT daily usage trend chart
      if (data.openAIUsage && data.openAIUsage.dailyUsage && data.openAIUsage.dailyUsage.length > 0) {
        const ctx = document.getElementById('tokenUsageChart').getContext('2d');
        const dailyUsage = data.openAIUsage.dailyUsage;
        
        if (charts.tokenUsage) charts.tokenUsage.destroy();
        
        charts.tokenUsage = new Chart(ctx, {
          type: 'line',
          data: {
            labels: dailyUsage.map(d => {
              const date = new Date(d.date);
              return `${(date.getMonth() + 1).toString().padStart(2, '0')}/${date.getDate().toString().padStart(2, '0')}`;
            }),
            datasets: [{
              label: 'Daily Token Usage',
              data: dailyUsage.map(d => d.tokens),
              borderColor: '#10b981',
              backgroundColor: 'rgba(16, 185, 129, 0.1)',
              borderWidth: 2,
              pointRadius: 4,
              pointHoverRadius: 6,
              fill: true,
              tension: 0.3
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { display: false },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    return context.parsed.y.toLocaleString() + ' tokens';
                  }
                }
              }
            },
            scales: {
              y: {
                beginAtZero: true,
                ticks: {
                  callback: function(value) {
                    if (value >= 1000000) {
                      return (value / 1000000).toFixed(1) + 'M';
                    } else if (value >= 1000) {
                      return (value / 1000).toFixed(0) + 'K';
                    }
                    return value;
                  }
                }
              },
              x: {
                grid: {
                  display: false
                }
              }
            }
          }
        });
      }
      
      // GPT model usage chart
      if (data.openAIUsage && data.openAIUsage.modelUsage) {
        const ctx = document.getElementById('tokenModelChart').getContext('2d');
        const models = Object.keys(data.openAIUsage.modelUsage);
        const tokens = models.map(m => data.openAIUsage.modelUsage[m].tokens);
        
        if (charts.tokenModel) charts.tokenModel.destroy();
        
        charts.tokenModel = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: models,
            datasets: [{
              data: tokens,
              backgroundColor: [
                '#00d4ff',
                '#7c3aed',
                '#10b981',
                '#f59e0b',
                '#ef4444',
                '#ec4899',
                '#8b5cf6',
                '#06b6d4'
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'bottom',
                labels: {
                  padding: 10,
                  font: {
                    size: 11
                  }
                }
              },
              tooltip: {
                callbacks: {
                  label: function(context) {
                    const label = context.label || '';
                    const value = context.parsed;
                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                    const percentage = ((value / total) * 100).toFixed(1);
                    return `${label}: ${value.toLocaleString()} tokens (${percentage}%)`;
                  }
                }
              }
            }
          }
        });
      }
    }

    // Settings functions
    function saveSettings() {
      const settings = {
        chatgpt: parseFloat(document.getElementById('cost_chatgpt').value) || 0,
        claude: parseFloat(document.getElementById('cost_claude').value) || 0,
        warp: parseFloat(document.getElementById('cost_warp').value) || 0,
        other: parseFloat(document.getElementById('cost_other').value) || 0
      };
      localStorage.setItem('toolCosts', JSON.stringify(settings));
      updateToolsCost();
    }

    function resetSettings() {
      document.getElementById('cost_chatgpt').value = '';
      document.getElementById('cost_claude').value = '';
      document.getElementById('cost_warp').value = '';
      document.getElementById('cost_other').value = '';
      localStorage.removeItem('toolCosts');
      updateToolsCost();
    }

    function loadSettings() {
      const settings = JSON.parse(localStorage.getItem('toolCosts') || '{}');
      document.getElementById('cost_chatgpt').value = settings.chatgpt || '';
      document.getElementById('cost_claude').value = settings.claude || '';
      document.getElementById('cost_warp').value = settings.warp || '';
      document.getElementById('cost_other').value = settings.other || '';
      updateToolsCost();
    }

    function updateToolsCost() {
      const settings = JSON.parse(localStorage.getItem('toolCosts') || '{}');
      const total = (settings.chatgpt || 0) + (settings.claude || 0) + 
                   (settings.warp || 0) + (settings.other || 0);
      document.getElementById('tools_cost').textContent = `$${total.toFixed(2)}`;
      updateNetValue();
    }

    function updateNetValue() {
      const mrr = parseFloat(document.getElementById('mrr_sum').textContent.replace('$', '')) || 0;
      const impl = parseFloat(document.getElementById('impl_sum').textContent.replace('$', '')) || 0;
      const tools = parseFloat(document.getElementById('tools_cost').textContent.replace('$', '')) || 0;
      const azure = parseFloat(document.getElementById('azure_cost_pill').textContent.replace('$', '')) || 0;
      const net = mrr + impl - tools - azure;
      document.getElementById('net_value').textContent = `$${net.toFixed(2)}`;
      document.getElementById('net_value').parentElement.style.color = net >= 0 ? 'var(--good)' : 'var(--bad)';
    }

    // Initialize on load
    document.addEventListener('DOMContentLoaded', () => {
      loadSettings();
      refreshAllWithCharts();
      
      // Auto-refresh every 5 minutes
      setInterval(refreshAllWithCharts, 5 * 60 * 1000);
    });
  </script>
</body>
</html>
